<!DOCTYPE html>
<html lang="en">

<head>
  <title>
  Device Tree hello world · Techiedeepdive
</title>
  <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="color-scheme" content="light dark">




<meta name="description" content="Device Tree is defined as

In computing, a device tree (also written devicetree) is a data structure describing the hardware components of a particular computer so that the operating system&rsquo;s kernel can use and manage those components, including the CPU or CPUs, the memory, the buses and the peripherals.

Basically, device tree defines SOC architecture for operating system or boot-loader. This is widely used in embedded systems where the system is not configurable and not going to change.">
<meta name="keywords" content="homepage, blog">



  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:image" content="/">
  <meta name="twitter:title" content="Device Tree hello world">
  <meta name="twitter:description" content="Device Tree is defined as
In computing, a device tree (also written devicetree) is a data structure describing the hardware components of a particular computer so that the operating system’s kernel can use and manage those components, including the CPU or CPUs, the memory, the buses and the peripherals.
Basically, device tree defines SOC architecture for operating system or boot-loader. This is widely used in embedded systems where the system is not configurable and not going to change.">

<meta property="og:url" content="/posts/2020/09/device-tree-hello-world/">
  <meta property="og:site_name" content="Techiedeepdive">
  <meta property="og:title" content="Device Tree hello world">
  <meta property="og:description" content="Device Tree is defined as
In computing, a device tree (also written devicetree) is a data structure describing the hardware components of a particular computer so that the operating system’s kernel can use and manage those components, including the CPU or CPUs, the memory, the buses and the peripherals.
Basically, device tree defines SOC architecture for operating system or boot-loader. This is widely used in embedded systems where the system is not configurable and not going to change.">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2020-09-06T16:05:18+02:00">
    <meta property="article:modified_time" content="2020-09-06T16:05:18+02:00">
    <meta property="article:tag" content="Embedded">
    <meta property="og:image" content="/">




<link rel="canonical" href="/posts/2020/09/device-tree-hello-world/">


<link rel="preload" href="/fonts/fa-brands-400.woff2" as="font" type="font/woff2" crossorigin>
<link rel="preload" href="/fonts/fa-regular-400.woff2" as="font" type="font/woff2" crossorigin>
<link rel="preload" href="/fonts/fa-solid-900.woff2" as="font" type="font/woff2" crossorigin>


  
  
  <link rel="stylesheet" href="/css/coder.min.aa5ef26fa979d6793724ae2dbd71efa94fd16cb1c5c7db3b6651f21f9892a5fd.css" integrity="sha256-ql7yb6l51nk3JK4tvXHvqU/RbLHFx9s7ZlHyH5iSpf0=" crossorigin="anonymous" media="screen" />






  
    
    
    <link rel="stylesheet" href="/css/coder-dark.min.a00e6364bacbc8266ad1cc81230774a1397198f8cfb7bcba29b7d6fcb54ce57f.css" integrity="sha256-oA5jZLrLyCZq0cyBIwd0oTlxmPjPt7y6KbfW/LVM5X8=" crossorigin="anonymous" media="screen" />
  



 




<link rel="icon" type="image/svg+xml" href="/images/favicon.svg" sizes="any">
<link rel="icon" type="image/png" href="/images/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/images/favicon-16x16.png" sizes="16x16">

<link rel="apple-touch-icon" href="/images/apple-touch-icon.png">
<link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">

<link rel="manifest" href="/site.webmanifest">
<link rel="mask-icon" href="/images/safari-pinned-tab.svg" color="#5bbad5">









</head>






<body class="preload-transitions colorscheme-auto">
  
<div class="float-container">
    <a id="dark-mode-toggle" class="colorscheme-toggle">
        <i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i>
    </a>
</div>


  <main class="wrapper">
    <nav class="navigation">
  <section class="container">
    
    <a class="navigation-title" href="/">
      Techiedeepdive
    </a>
    
    
      <input type="checkbox" id="menu-toggle" />
      <label class="menu-button float-right" for="menu-toggle">
        <i class="fa-solid fa-bars fa-fw" aria-hidden="true"></i>
      </label>
      <ul class="navigation-list">
        
          
            <li class="navigation-item">
              <a class="navigation-link " href="/posts">Blog</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link " href="/reading-list/">Reading list</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link " href="/tags/">Tags</a>
            </li>
          
        
        
      </ul>
    
  </section>
</nav>


    <div class="content">
      
  <section class="container post">
    <article>
      <header>
        <div class="post-title">
          <h1 class="title">
            <a class="title-link" href="/posts/2020/09/device-tree-hello-world/">
              Device Tree hello world
            </a>
          </h1>
        </div>
        <div class="post-meta">
          <div class="date">
            <span class="posted-on">
              <i class="fa-solid fa-calendar" aria-hidden="true"></i>
              <time datetime="2020-09-06T16:05:18&#43;02:00">
                September 6, 2020
              </time>
            </span>
            <span class="reading-time">
              <i class="fa-solid fa-clock" aria-hidden="true"></i>
              3-minute read
            </span>
          </div>
          
          
          <div class="tags">
  <i class="fa-solid fa-tag" aria-hidden="true"></i>
    <span class="tag">
      <a href="/tags/embedded/">Embedded</a>
    </span></div>

        </div>
      </header>

      <div class="post-content">
        
        <p><a href="https://en.wikipedia.org/wiki/Device_tree"  class="external-link" target="_blank" rel="noopener">Device Tree</a> is defined as</p>
<blockquote>
<p>In computing, a device tree (also written devicetree) is a data structure describing the hardware components of a particular computer so that the operating system&rsquo;s kernel can use and manage those components, including the CPU or CPUs, the memory, the buses and the peripherals.</p>
</blockquote>
<p>Basically, device tree defines SOC architecture for operating system or boot-loader. This is widely used in embedded systems where the system is not configurable and not going to change.</p>
<p>This is not a problem on PCs because of things like BIOS enumeration through ACPI and you can add whatever behind PCI and it can be probed.</p>
<p>Anyway, i read the first two chapters of <a href="https://github.com/devicetree-org/devicetree-specification/releases/tag/v0.3"  class="external-link" target="_blank" rel="noopener">specification</a> and i thought it was enough to play around with <code>dtc</code> which part of <code>device-tree-compiler</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>apt install device-tree-compiler
</span></span></code></pre></div><h1 id="device-tree-crash-course">
  Device tree crash course
  <a class="heading-link" href="#device-tree-crash-course">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h1>
<p>I am not going to repeat the spec. but to sum up,</p>
<ul>
<li>It&rsquo;s a tree of nodes (DAG)</li>
<li>each node have pairs of property/values.</li>
<li>The devicetree has a single root node of which all other device nodes are descendants. The full path to the root node is /.</li>
<li>All devicetrees shall have a root node and the following nodes shall be present at the root of all devicetrees: one <code>/cpus/</code> and at least one <code>/memory</code></li>
</ul>
<p>That&rsquo;s it.</p>
<pre tabindex="0"><code>/dts-v1/;

/ {
    compatible = &#34;vendor,model&#34;;
	cpus {
		cpu1: cpu@1 {
			compatible = &#34;vendor,model&#34;;
			clock-frequency = &lt;650000000&gt;;
			device_type = &#34;cpu&#34;;
			reg = &lt;1&gt;;
		};
	};

    memory: memory@80000000 {
		device_type = &#34;memory&#34;;
		reg = &lt;0x00000000 0x80000000 0x00000000 0x40000000&gt;;
	};

};
</code></pre><p>Properties can take one the following values</p>
<ul>
<li>empty</li>
<li>u32</li>
<li>u64</li>
<li>phandle</li>
<li>string</li>
<li>prop-encoded-array</li>
<li>stringlist</li>
</ul>
<p>more details and examples at sections 2.2 of <a href="https://github.com/devicetree-org/devicetree-specification/releases/tag/v0.3"  class="external-link" target="_blank" rel="noopener">specs</a></p>
<h1 id="compile-and-de-compile-device-tree">
  Compile and de-compile device tree
  <a class="heading-link" href="#compile-and-de-compile-device-tree">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h1>
<p>Using <code>dtc</code>, we can compile dts into dtb(device tree blob).</p>
<pre tabindex="0"><code>dtc -I dts  -O dtb -o 1.dtb  1.dts 
</code></pre><p>we can de-compile the blob back to dts.</p>
<pre tabindex="0"><code>dtc -I dtb  -O dts -o 1.dtsd  1.dtb
</code></pre><p>Note, the specs define the format for the binary blob. with the following, i guess it would be fun to write a parser for it.</p>
<pre tabindex="0"><code>struct fdt_header {
uint32_t magic;
uint32_t totalsize;
uint32_t off_dt_struct;
uint32_t off_dt_strings;
uint32_t off_mem_rsvmap;
uint32_t version;
uint32_t last_comp_version;
uint32_t boot_cpuid_phys;
uint32_t size_dt_strings;
uint32_t size_dt_struct;
};
</code></pre><p>we can see this realy quick with <code>hexdump</code> as specs says the <code>magic</code>value is <code>0xd00dfeed</code>.
Note, we get <code>0dd0 edfe</code> because of endiance.</p>
<pre tabindex="0"><code>$ hexdump 1.dtb 
0000000 0dd0 edfe 0000 3f01 0000 3800 0000 1401
</code></pre><h1 id="interrupts">
  Interrupts
  <a class="heading-link" href="#interrupts">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h1>
<p>I think that interrupts is most complicated part of specs.Here is quick overview</p>
<p>the spec defines <code>interrupt-generating devices</code></p>
<blockquote>
<p>The physical wiring of an interrupt source to an interrupt controller is represented in the devicetree with the interrupt-parent property. Nodes that represent interrupt-generating devices contain an interrupt-parent property which has a phandle value that points to the device to which the device’s interrupts are routed, typically an interrupt controller. If an interrupt-generating device does not have an interrupt-parent property, its interrupt parent is assumed to be its devicetree parent.</p>
</blockquote>
<p>and <code>interrupt domain</code> is defined as:</p>
<blockquote>
<p>An interrupt domain is the context in which an interrupt specifier is interpreted. The root of the domain is either (1) an interrupt controller or (2) an interrupt nexus.</p>
<ul>
<li>An interrupt controller</li>
<li>An interrupt nexus</li>
</ul>
</blockquote>
<p>Looking at any dts in linux kernel say <a href="https://elixir.bootlin.com/linux/latest/source/arch/arm/boot/dts/armada-375.dtsi"  class="external-link" target="_blank" rel="noopener">this one</a>. The interrupt controller has the properties</p>
<ul>
<li>interrupt-controller</li>
<li>interrupt-cells which defines the interrupt specifier in the interrupt-generating device</li>
</ul>
<pre tabindex="0"><code>			gic: interrupt-controller@d000 {
				compatible = &#34;arm,cortex-a9-gic&#34;;
				#interrupt-cells = &lt;3&gt;;
				#size-cells = &lt;0&gt;;
				interrupt-controller;
				reg = &lt;0xd000 0x1000&gt;,
				      &lt;0xc100 0x100&gt;;
			};
</code></pre><p>somewhere in the same dts, there are interrupt devices with <code>interrupts</code> property</p>
<pre tabindex="0"><code>			rtc: rtc@10300 {
				compatible = &#34;marvell,orion-rtc&#34;;
				reg = &lt;0x10300 0x20&gt;;
				interrupts = &lt;GIC_SPI 21 IRQ_TYPE_LEVEL_HIGH&gt;;
			};
</code></pre>
      </div>


      <footer>
        


        
        
        
        
        
        
        
      </footer>
    </article>

    
  </section>

    </div>

    <footer class="footer">
  <section class="container">
    ©
    
    2024
    
    ·
    
      Licensed under <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">CC BY-SA-4.0</a>
    ·
    
    Powered by <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> & <a href="https://github.com/luizdepra/hugo-coder/" target="_blank" rel="noopener">Coder</a>.
    
  </section>
</footer>

  </main>

  

  
  
  <script src="/js/coder.min.6ae284be93d2d19dad1f02b0039508d9aab3180a12a06dcc71b0b0ef7825a317.js" integrity="sha256-auKEvpPS0Z2tHwKwA5UI2aqzGAoSoG3McbCw73gloxc="></script>
  

  

  


  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  
</body>

</html>
