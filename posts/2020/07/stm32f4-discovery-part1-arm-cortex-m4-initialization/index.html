<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="author" content="">
<meta name="description" content="Introduction This post will explain the linker script and assembly initialization before jumping to main using stm32f4 board and Hello world example from github.
The end I will describe this the same way i gone through it. Starting with the linking command.
arm-none-eabi-gcc -g -O2 -Wall -Tstm32_flash.ld -mlittle-endian -mthumb -mcpu=cortex-m4 -mthumb-interwork -mfloat-abi=hard -mfpu=fpv4-sp-d16 -Iinc -Ilib -Ilib/inc -Ilib/inc/core -Ilib/inc/peripherals src/main.c src/stm32f4xx_it.c src/system_stm32f4xx.c lib/startup_stm32f4xx.s -o main.elf -Llib -lstm32f4 Starting with main.c, well nothing interesting there." />
<meta name="keywords" content=", embedded" />
<meta name="robots" content="noodp" />
<meta name="theme-color" content="" />
<link rel="canonical" href="/posts/2020/07/stm32f4-discovery-part1-arm-cortex-m4-initialization/" />


    <title>
        
            Stm32f4 Discovery - Part1 - ARM Cortex M4 Initialization :: Techiedeepdive 
        
    </title>



<link href="https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.5.0/css/flag-icon.min.css" rel="stylesheet"
    type="text/css">



<link rel="stylesheet" href="/main.de188b3201233c251f4fd6306dbd2cb41e408fb8846c09781b2925de7df5025c.css">






<meta itemprop="name" content="Stm32f4 Discovery - Part1 - ARM Cortex M4 Initialization">
<meta itemprop="description" content="Introduction This post will explain the linker script and assembly initialization before jumping to main using stm32f4 board and Hello world example from github.
The end I will describe this the same way i gone through it. Starting with the linking command.
arm-none-eabi-gcc -g -O2 -Wall -Tstm32_flash.ld -mlittle-endian -mthumb -mcpu=cortex-m4 -mthumb-interwork -mfloat-abi=hard -mfpu=fpv4-sp-d16 -Iinc -Ilib -Ilib/inc -Ilib/inc/core -Ilib/inc/peripherals src/main.c src/stm32f4xx_it.c src/system_stm32f4xx.c lib/startup_stm32f4xx.s -o main.elf -Llib -lstm32f4 Starting with main.c, well nothing interesting there."><meta itemprop="datePublished" content="2020-07-11T17:48:31+02:00" />
<meta itemprop="dateModified" content="2020-07-11T17:48:31+02:00" />
<meta itemprop="wordCount" content="1304"><meta itemprop="image" content=""/>
<meta itemprop="keywords" content="embedded," />
<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content=""/>

<meta name="twitter:title" content="Stm32f4 Discovery - Part1 - ARM Cortex M4 Initialization"/>
<meta name="twitter:description" content="Introduction This post will explain the linker script and assembly initialization before jumping to main using stm32f4 board and Hello world example from github.
The end I will describe this the same way i gone through it. Starting with the linking command.
arm-none-eabi-gcc -g -O2 -Wall -Tstm32_flash.ld -mlittle-endian -mthumb -mcpu=cortex-m4 -mthumb-interwork -mfloat-abi=hard -mfpu=fpv4-sp-d16 -Iinc -Ilib -Ilib/inc -Ilib/inc/core -Ilib/inc/peripherals src/main.c src/stm32f4xx_it.c src/system_stm32f4xx.c lib/startup_stm32f4xx.s -o main.elf -Llib -lstm32f4 Starting with main.c, well nothing interesting there."/>




    <meta property="og:title" content="Stm32f4 Discovery - Part1 - ARM Cortex M4 Initialization" />
<meta property="og:description" content="Introduction This post will explain the linker script and assembly initialization before jumping to main using stm32f4 board and Hello world example from github.
The end I will describe this the same way i gone through it. Starting with the linking command.
arm-none-eabi-gcc -g -O2 -Wall -Tstm32_flash.ld -mlittle-endian -mthumb -mcpu=cortex-m4 -mthumb-interwork -mfloat-abi=hard -mfpu=fpv4-sp-d16 -Iinc -Ilib -Ilib/inc -Ilib/inc/core -Ilib/inc/peripherals src/main.c src/stm32f4xx_it.c src/system_stm32f4xx.c lib/startup_stm32f4xx.s -o main.elf -Llib -lstm32f4 Starting with main.c, well nothing interesting there." />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/2020/07/stm32f4-discovery-part1-arm-cortex-m4-initialization/" /><meta property="og:image" content=""/><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-07-11T17:48:31+02:00" />
<meta property="article:modified_time" content="2020-07-11T17:48:31+02:00" /><meta property="og:site_name" content="Techiedeepdive" />







    <meta property="article:published_time" content="2020-07-11 17:48:31 &#43;0200 &#43;0200" />








    </head>

    
        <body>
    
    
        <div class="container">
            <header class="header">
    <span class="header__inner">
        <a href="/" style="text-decoration: none;">
    <div class="logo">
        
            <span class="logo__mark">></span>
            <span class="logo__text">$ cd /home/</span>
            <span class="logo__cursor" style=
                  "
                   
                   ">
            </span>
        
    </div>
</a>


        <span class="header__right">
            
                <nav class="menu">
    <ul class="menu__inner"><li><a href="/about/">About</a></li><li><a href="/posts">Blog</a></li><li><a href="/reading-list/">Reading list</a></li><li><a href="/tags/">Tags</a></li>
    </ul>
</nav>

                <span class="menu-trigger">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path d="M0 0h24v24H0z" fill="none"/>
                        <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
                    </svg>
                </span>
            
        </span>
    </span>
</header>


            <div class="content">
                
  <main class="post">

    <div class="post-info">
      <p>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock">
          <circle cx="12" cy="12" r="10"></circle>
          <polyline points="12 6 12 12 16 14"></polyline>
        </svg>
        7 minutes

        
      </p>
    </div>

    <article>
      <h1 class="post-title">
        <a href="/posts/2020/07/stm32f4-discovery-part1-arm-cortex-m4-initialization/">Stm32f4 Discovery - Part1 - ARM Cortex M4 Initialization</a>
      </h1>

      

      

      <div class="post-content">
        <h1 id="introduction">Introduction</h1>
<p>This post will explain the linker script and assembly initialization before jumping to main using <a href="https://www.st.com/en/evaluation-tools/stm32f4discovery.html">stm32f4</a> board and Hello world example from <a href="git://github.com/jeremyherbert/stm32-templates.git">github</a>.</p>
<h1 id="the-end">The end</h1>
<p>I will describe this the same way i gone through it. <em>Starting with the linking command</em>.</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">arm-none-eabi-gcc -g -O2 -Wall -Tstm32_flash.ld  -mlittle-endian -mthumb -mcpu=cortex-m4 -mthumb-interwork -mfloat-abi=hard -mfpu=fpv4-sp-d16 -Iinc -Ilib -Ilib/inc  -Ilib/inc/core -Ilib/inc/peripherals  src/main.c src/stm32f4xx_it.c src/system_stm32f4xx.c lib/startup_stm32f4xx.s -o main.elf -Llib -lstm32f4
</code></pre></div><p>Starting with <code>main.c</code>, well nothing interesting there. just the <code>main</code>, obviously.</p>
<p>So,I jumped to <code>system_stm32f4xx.c</code>, it has 2 functions but only <code>SystemInit</code> called somewhere else. It&rsquo;s called from <code>startup_stm32f4xx.s</code> specifically from routine <code>Reset_Handler</code>.</p>
<p>From the snippet below, it&rsquo;s clear that <code>Reset_Handler</code> is the bootstrap routine because it does two things</p>
<ul>
<li>Hardware-specific initialization with <code>SystemInit</code></li>
<li>Jump to <code>main</code></li>
</ul>
<pre tabindex="0"><code>/* Call the clock system intitialization function.*/
  bl  SystemInit   
/* Call static constructors */
    bl __libc_init_array
/* Call the application's entry point.*/
  bl  main
  bx  lr 
</code></pre><h1 id="reset_handler-and-arm-m4-boot">Reset_Handler and ARM M4 boot</h1>
<p><code>Reset_Handler</code> is 2nd entry in interrupt vector <code>isr_vector</code> defined in the same file.</p>
<pre tabindex="0"><code>   .section  .isr_vector,&quot;a&quot;,%progbits
  .type  g_pfnVectors, %object
  .size  g_pfnVectors, .-g_pfnVectors
    
    
g_pfnVectors:
  .word  _estack
  .word  Reset_Handler
  .word  NMI_Handler
</code></pre><p>So, How is <code>Reset_Handler</code> is called?</p>
<p><a href="https://www.st.com/resource/en/reference_manual/dm00031020-stm32f405-415-stm32f407-417-stm32f427-437-and-stm32f429-439-advanced-arm-based-32-bit-mcus-stmicroelectronics.pdf">stm32 RM</a> Describes the boot process from address <code>0x0000 0000</code>.</p>
<blockquote>
<p>Due to its fixed memory map, the code area starts from address 0x0000 0000 (accessed
through the ICode/DCode buses) while the data area (SRAM) starts from address
0x2000 0000 (accessed through the system bus). The CortexTM-M4 with FPU CPU always
fetches the reset vector on the ICode bus, which implies to have the boot space available
only in the code area (typically, Flash memory). STM32F4xx microcontrollers implement a
special mechanism to be able to boot from other memories (like the internal SRAM).</p>
</blockquote>
<p>And next section describes the memory remap to allow ICode to access the boot memories (Flash, SRAM).</p>
<blockquote>
<p>Physical remap in STM32F405xx/07xx and STM32F415xx/17xx
Once the boot pins are selected, the application software can modify the memory
accessible in the code area (in this way the code can be executed through the ICode bus in</p>
</blockquote>
<p>The way i understand it, the boot mode is selected based on BOOT1 and BOOT0. and the address range starting 0x00000000 gets remapped to the boot source. Table 3 shows that mapping.</p>
<p>And finally it mentions, the first 2 entries that the core need. So, we know that core will start executing from address at 0x00000004. in our case, 0x080000000 + 0x00000004.</p>
<blockquote>
<p>The BOOT pins are also resampled when the device exits the Standby mode. Consequently,
they must be kept in the required Boot mode configuration when the device is in the Standby
mode. After this startup delay is over, the CPU fetches the top-of-stack value from address
0x0000 0000, then starts code execution from the boot memory starting from 0x0000 0004.</p>
</blockquote>
<p>So, we know what the program will execute somewhere after 0x08000000 and  we need to put the address of  <code>Reset_Handler</code> at offset 0x00000004.</p>
<p>how is that done?</p>
<h1 id="the-linker-black-magic">The linker black magic</h1>
<p><code>stm32_flash.ld</code> defines the memory regions and how sections will be linked into the final ELF.</p>
<h2 id="the-memory-map">The memory map</h2>
<p><code>MEMORY</code> defines the memory map available on the system bus. Note that FLASH origin at <code>0x08000000</code> and RAM origin at <code>0x20000000</code> as defined by <a href="https://www.st.com/resource/en/reference_manual/dm00031020-stm32f405-415-stm32f407-417-stm32f427-437-and-stm32f429-439-advanced-arm-based-32-bit-mcus-stmicroelectronics.pdf">RM</a></p>
<pre tabindex="0"><code>MEMORY
{
  FLASH (rx)      : ORIGIN = 0x08000000, LENGTH = 1024K
  RAM (xrw)       : ORIGIN = 0x20000000, LENGTH = 192K
  MEMORY_B1 (rx)  : ORIGIN = 0x60000000, LENGTH = 0K
}
</code></pre><h2 id="ist_vector">ist_vector</h2>
<p>This section puts <code>isr_vector</code> section into the FLASH memory region and being the first one, it will be placed at address <code>0x080000000</code>. Remember the memory remap from the last section? this means that <code>Reset_Handler</code> will be at the correct address.</p>
<pre tabindex="0"><code>  .isr_vector :
  {
    . = ALIGN(4);
    KEEP(*(.isr_vector)) /* Startup code */
    . = ALIGN(4);
  } &gt;FLASH

</code></pre><p>Dumping the elf section after linking with <code>arm-none-eabi-objdump -x main.elf</code> shows the ist_vector at address <code>0800000</code>.</p>
<pre tabindex="0"><code>Sections:
Idx Name          Size      VMA       LMA       File off  Algn
  0 .isr_vector   00000188  08000000  08000000  00008000  2**0
                  CONTENTS, ALLOC, LOAD, READONLY, DATA
</code></pre><h2 id="text">text</h2>
<p>Same as isr_vector, the <code>.text</code> section is the executable code will go into the FLASH region.</p>
<pre tabindex="0"><code>  /* The program code and other data goes into FLASH */
  .text :
  {
    . = ALIGN(4);
    *(.text)           /* .text sections (code) */
    *(.text*)          /* .text* sections (code) */

  } &gt;FLASH

</code></pre><p>with <code>objdump</code>, we see that <code>.text</code> section starts right after isr_vector at <code>0x08000188</code></p>
<pre tabindex="0"><code>  1 .text         00000ea8  08000188  08000188  00008188  2**2
                  CONTENTS, ALLOC, LOAD, READONLY, CODE

</code></pre><h2 id="data-and-bss">data and BSS</h2>
<p>Data and BSS are used for static variables in each object file. data is used to allocate variables with initial value. BSS used for variables without initial value.</p>
<p>There are 3 important parts here</p>
<ul>
<li><code>_sidata</code> before the <code>.data</code> section</li>
<li><code>.data : AT ( _sidata )</code> while defining the data section</li>
<li><code>_sdata</code> and <code>_edata</code></li>
</ul>
<pre tabindex="0"><code>  /* used by the startup to initialize data */
  _sidata = .;

  /* Initialized data sections goes into RAM, load LMA copy after code */
  .data : AT ( _sidata )
  {
    . = ALIGN(4);
    _sdata = .;        /* create a global symbol at data start */
    *(.data)           /* .data sections */
    *(.data*)          /* .data* sections */

    . = ALIGN(4);
    _edata = .;        /* define a global symbol at data end */
  } &gt;RAM

</code></pre><p>By doing <code>_sidata =.;</code>,  we store the current address(that depends on how big sections were) in <code>_sidata</code>.</p>
<p>Next, By using <code>AT</code> for <code>.data</code>, we define the <code>VMA</code> and <code>LMA</code> to be different. in this case</p>
<ul>
<li><code>VMA</code> will be the address from RAM (from <code>&gt;RAM</code>)</li>
<li><code>LMA</code> will be the address we are at the ELF(or in this case, FLASH).</li>
</ul>
<p><em>What are LMA and VMA and why they are important?</em></p>
<p>The problem is  data are read/write regions so, it lives in the RAM but we need to allocate initial values in the FLASH . We will see that <code>Reset_Handler</code> will need to copy that from the flash to the RAM.
But Linker will use VMA to resolve and relocate the variables. More details at <a href="https://sourceware.org/binutils/docs/ld/Output-Section-LMA.html#Output-Section-LMA">ld doc</a>.</p>
<p>With <code>odjdump</code>, We can see the difference between <code>LMA</code> and <code>VMA</code>.
Note that wasn&rsquo;t the case in <code>.text</code> and <code>.bss</code>.</p>
<pre tabindex="0"><code>Idx Name          Size      VMA       LMA       File off  Algn
  5 .data         00000458  20000000  08001040  00010000  2**3
  6 .jcr          00000004  20000458  08001498  00010458  2**2
  7 .bss          00000024  2000045c  0800149c  0001045c  2**2

</code></pre><p>So, at this points we have 3 addresses</p>
<ul>
<li><code>_sidata</code> : address of data in elf (AKA flash) relative 08000000</li>
<li><code>_sdata</code>  : start address for data section the ram relative 20000000</li>
<li><code>_edata</code>  : end address for data section the ram.</li>
</ul>
<p>for BSS, it&rsquo;s same. There are addresses <code>_sbss</code> and <code>_ebss</code> like we have <code>_sdata</code> and <code>_edata</code>.</p>
<h1 id="what-does-reset_handler-do">What Does Reset_handler do?</h1>
<p>At this point, we have done the following:</p>
<ul>
<li>Went through ARM M4 boot sequence and saw how it eventually calls <code>Reset_Handler</code>.</li>
<li>Understood how the linker script tells the linker where to loads elf sections in FLASH and RAM regions.</li>
</ul>
<p>Now that <code>Reset_Handler</code> is called. It does 4 things:</p>
<ul>
<li>Initialize the data section by copying from the flash to the ram. This is done by <code>LoopCopyDataInit</code> and using <code>_sidata</code>, <code>_sdata</code> and <code>_edata</code>.</li>
<li>Initialize BSS section in ram with zeros. This is done by <code>LoopFillZerobss</code> and uses <code>_sbss</code> and <code>_ebss</code>.</li>
<li>Calls <code>SystemInit</code></li>
<li>Calls <code>main</code></li>
</ul>
<p>Note, <code>__libc_init_array</code> seems like call-back from compiler/libc to initialized things before calling the main. Not even trying to go there!</p>
<pre tabindex="0"><code>Reset_Handler:  

/* Copy the data segment initializers from flash to SRAM */  
  movs  r1, #0
  b  LoopCopyDataInit

CopyDataInit:
  ldr  r3, =_sidata
  ldr  r3, [r3, r1]
  str  r3, [r0, r1]
  adds  r1, r1, #4
    
LoopCopyDataInit:
  ldr  r0, =_sdata
  ldr  r3, =_edata
  adds  r2, r0, r1
  cmp  r2, r3
  bcc  CopyDataInit
  ldr  r2, =_sbss
  b  LoopFillZerobss
/* Zero fill the bss segment. */  
FillZerobss:
  movs  r3, #0
  str  r3, [r2], #4
    
LoopFillZerobss:
  ldr  r3, = _ebss
  cmp  r2, r3
  bcc  FillZerobss

/* Call the clock system intitialization function.*/
  bl  SystemInit   
/* Call static constructors */
    bl __libc_init_array
/* Call the application's entry point.*/
  bl  main
</code></pre>
      </div>
    </article>

    <hr />

    <div class="post-info">
      
    <p>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7" y2="7"></line></svg>

        <span class="tag"><a href="tags/embedded/">embedded</a></span>
        
    </p>

      

      <p>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text">
          <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
          <polyline points="14 2 14 8 20 8"></polyline>
          <line x1="16" y1="13" x2="8" y2="13"></line>
          <line x1="16" y1="17" x2="8" y2="17"></line>
          <polyline points="10 9 9 9 8 9"></polyline>
        </svg>
        1304 Words
      </p>

      <p>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar">
          <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
          <line x1="16" y1="2" x2="16" y2="6"></line>
          <line x1="8" y1="2" x2="8" y2="6"></line>
          <line x1="3" y1="10" x2="21" y2="10"></line>
        </svg>
        
          2020-07-11 16:48 &#43;0100
        

         
          
        
      </p>
    </div>

    
      <div class="pagination">
        <div class="pagination__title">
          <span class="pagination__title-h">Read other posts</span>
          <hr />
        </div>

        <div class="pagination__buttons">
          
            <span class="button previous">
              <a href="/posts/2020/07/nginx-configuration/">
                <span class="button__icon">←</span>
                <span class="button__text">Nginx Configuration</span>
              </a>
            </span>
          

          
            <span class="button next">
              <a href="/posts/2020/07/golang-part1/">
                <span class="button__text">Golang Part1</span>
                <span class="button__icon">→</span>
              </a>
            </span>
          
        </div>
      </div>
    


    

    

  </main>

            </div>

            
                <footer class="footer">
    <div class="footer__inner">
        <div class="footer__content">
            <span>&copy; 2023</span>
            
            <span><a href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank" rel="noopener">CC BY-NC 4.0</a></span><span><a href="posts/index.xml" target="_blank" title="rss"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle></svg></a></span>
        </div>
    </div>
    <div class="footer__inner">
        <div class="footer__content">
            <span>Powered by <a href="http://gohugo.io">Hugo</a></span>
            <span>Made with &#10084; by <a href="https://github.com/rhazdon">Djordje Atlialp</a></span>
          </div>
    </div>
</footer>

            
        </div>

        



<script type="text/javascript" src="/bundle.min.2ce64ea6ea44a72b13dd812fc2eb5cca3efe878cce258a47c137c17edf46e0602a05e422b618a5b80b5939c731b7a293351c2f2222a21f6ee27e54a8448dd20e.js" integrity="sha512-LOZOpupEpysT3YEvwutcyj7&#43;h4zOJYpHwTfBft9G4GAqBeQithiluAtZOccxt6KTNRwvIiKiH27iflSoRI3SDg=="></script>



    </body>
</html>
