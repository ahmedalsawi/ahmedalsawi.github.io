<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="author" content="">
<meta name="description" content="I came across this riscv core. I was more interested in the setup to run Yosys and nextpnr all the way to bitstream.
The default target is board with ICE40 FPGA. These are steps the Makefile used to build bitstream.
Pre-synthesis starting with icepll, it&amp;rsquo;s part of icestorm project to reverse-engineer the binary format for ICE40 fpga.
icepll -q -i 12 -o 48 -m -f pll.sv The generated pll is wrapper around Lattice&amp;rsquo;s SB_PLL40_CORE." />
<meta name="keywords" content=", fpga, eda" />
<meta name="robots" content="noodp" />
<meta name="theme-color" content="" />
<link rel="canonical" href="/posts/2020/07/yosys-nextpnr-flow/" />


    <title>
        
            Yosys Nextpnr Flow :: Techiedeepdive 
        
    </title>



<link href="https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.5.0/css/flag-icon.min.css" rel="stylesheet"
    type="text/css">



<link rel="stylesheet" href="/main.de188b3201233c251f4fd6306dbd2cb41e408fb8846c09781b2925de7df5025c.css">






<meta itemprop="name" content="Yosys Nextpnr Flow">
<meta itemprop="description" content="I came across this riscv core. I was more interested in the setup to run Yosys and nextpnr all the way to bitstream.
The default target is board with ICE40 FPGA. These are steps the Makefile used to build bitstream.
Pre-synthesis starting with icepll, it&rsquo;s part of icestorm project to reverse-engineer the binary format for ICE40 fpga.
icepll -q -i 12 -o 48 -m -f pll.sv The generated pll is wrapper around Lattice&rsquo;s SB_PLL40_CORE."><meta itemprop="datePublished" content="2020-07-23T18:10:09+02:00" />
<meta itemprop="dateModified" content="2020-07-23T18:10:09+02:00" />
<meta itemprop="wordCount" content="276"><meta itemprop="image" content=""/>
<meta itemprop="keywords" content="fpga,eda," />
<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content=""/>

<meta name="twitter:title" content="Yosys Nextpnr Flow"/>
<meta name="twitter:description" content="I came across this riscv core. I was more interested in the setup to run Yosys and nextpnr all the way to bitstream.
The default target is board with ICE40 FPGA. These are steps the Makefile used to build bitstream.
Pre-synthesis starting with icepll, it&rsquo;s part of icestorm project to reverse-engineer the binary format for ICE40 fpga.
icepll -q -i 12 -o 48 -m -f pll.sv The generated pll is wrapper around Lattice&rsquo;s SB_PLL40_CORE."/>




    <meta property="og:title" content="Yosys Nextpnr Flow" />
<meta property="og:description" content="I came across this riscv core. I was more interested in the setup to run Yosys and nextpnr all the way to bitstream.
The default target is board with ICE40 FPGA. These are steps the Makefile used to build bitstream.
Pre-synthesis starting with icepll, it&rsquo;s part of icestorm project to reverse-engineer the binary format for ICE40 fpga.
icepll -q -i 12 -o 48 -m -f pll.sv The generated pll is wrapper around Lattice&rsquo;s SB_PLL40_CORE." />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/2020/07/yosys-nextpnr-flow/" /><meta property="og:image" content=""/><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-07-23T18:10:09+02:00" />
<meta property="article:modified_time" content="2020-07-23T18:10:09+02:00" /><meta property="og:site_name" content="Techiedeepdive" />







    <meta property="article:published_time" content="2020-07-23 18:10:09 &#43;0200 &#43;0200" />








    </head>

    
        <body>
    
    
        <div class="container">
            <header class="header">
    <span class="header__inner">
        <a href="/" style="text-decoration: none;">
    <div class="logo">
        
            <span class="logo__mark">></span>
            <span class="logo__text">$ cd /home/</span>
            <span class="logo__cursor" style=
                  "
                   
                   ">
            </span>
        
    </div>
</a>


        <span class="header__right">
            
                <nav class="menu">
    <ul class="menu__inner"><li><a href="/about/">About</a></li><li><a href="/posts">Blog</a></li><li><a href="/reading-list/">Reading list</a></li><li><a href="/tags/">Tags</a></li>
    </ul>
</nav>

                <span class="menu-trigger">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path d="M0 0h24v24H0z" fill="none"/>
                        <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
                    </svg>
                </span>
            
        </span>
    </span>
</header>


            <div class="content">
                
  <main class="post">

    <div class="post-info">
      <p>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock">
          <circle cx="12" cy="12" r="10"></circle>
          <polyline points="12 6 12 12 16 14"></polyline>
        </svg>
        2 minutes

        
      </p>
    </div>

    <article>
      <h1 class="post-title">
        <a href="/posts/2020/07/yosys-nextpnr-flow/">Yosys Nextpnr Flow</a>
      </h1>

      

      

      <div class="post-content">
        <p>I came across this <a href="https://github.com/grahamedgecombe/icicle.git">riscv core</a>. I was more interested in the setup to run Yosys and nextpnr all the way to bitstream.</p>
<p>The default target is <a href="https://www.digikey.com/product-detail/en/lattice-semiconductor-corporation/ICE40HX8K-B-EVN/220-1874-ND/4738851">board</a> with <a href="http://www.latticesemi.com/iCE40">ICE40</a> FPGA. These are steps the Makefile used to build bitstream.</p>
<h1 id="pre-synthesis">Pre-synthesis</h1>
<p>starting with <code>icepll</code>, it&rsquo;s part of <a href="https://github.com/cliffordwolf/icestorm.git">icestorm</a> project to reverse-engineer the binary format for ICE40 fpga.</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">icepll -q -i <span style="color:#ff0;font-weight:bold">12</span> -o <span style="color:#ff0;font-weight:bold">48</span> -m -f pll.sv
</code></pre></div><p>The generated <code>pll</code> is wrapper around Lattice&rsquo;s <code>SB_PLL40_CORE</code>. I guess pll was needed to generated higher frequency. the on-baoard clock was 12 MHz and generated clock is 48 MHz.</p>
<pre tabindex="0"><code>module pll(
	input  clock_in,
	output clock_out,
	output locked
	);

SB_PLL40_CORE #(
		.FEEDBACK_PATH(&quot;SIMPLE&quot;),
		.DIVR(4'b0000),		// DIVR =  0
		.DIVF(7'b0111111),	// DIVF = 63
		.DIVQ(3'b100),		// DIVQ =  4
		.FILTER_RANGE(3'b001)	// FILTER_RANGE = 1
	) uut (
		.LOCK(locked),
		.RESETB(1'b1),
		.BYPASS(1'b0),
		.REFERENCECLK(clock_in),
		.PLLOUTCORE(clock_out)
		);

endmodule
</code></pre><h1 id="synthesis">Synthesis</h1>
<p><a href="https://github.com/YosysHQ/yosys.git">Yosys</a> is OSS verilog synthesis tool. It support ICE40 and ECP5 lattice FPGAs.</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">yosys -q ice40.ys
</code></pre></div><p><code>ice40.ys</code> reads <code>top.sv</code>, elaborate the the design, then finally synth for ice40 and generate both json and blif.</p>
<pre tabindex="0"><code>read_verilog -DICE40 -noautowire -sv top.sv
proc
opt -full
alumacc
share -aggressive
opt -full
synth_ice40 -abc2 -top top -blif top.blif -json top.json
</code></pre><h1 id="place-and-route">Place and route</h1>
<p><a href="https://github.com/YosysHQ/nextpnr.git">Nextpnr</a> is OSS FPGA PNR tool by the same people who did Yosys.</p>
<p>nextpnr takes synthesis json, pcf and configuration.It generate <code>.asc</code> file for icepack.</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">nextpnr-ice40 -q --hx8k --package ct256 --json top.json --pcf boards/ice40hx8k-b-evn.pcf --freq <span style="color:#ff0;font-weight:bold">48</span> --asc top_syn.asc
</code></pre></div><p><code>.asc</code> is ASCII file to represent tile. utilities from icestorm project can pack and unpack asc files into and from bitstream.</p>
<h1 id="bitstream-generation">Bitstream generation</h1>
<p>icepack is part of of icestorm project which converts <code>.asc</code> to bitstream.</p>
<pre tabindex="0"><code>cp top_syn.asc top.asc
icepack -s top.asc top.bin
</code></pre>
      </div>
    </article>

    <hr />

    <div class="post-info">
      
    <p>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7" y2="7"></line></svg>

        <span class="tag"><a href="tags/fpga/">fpga</a></span>
        <span class="tag"><a href="tags/eda/">eda</a></span>
        
    </p>

      

      <p>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text">
          <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
          <polyline points="14 2 14 8 20 8"></polyline>
          <line x1="16" y1="13" x2="8" y2="13"></line>
          <line x1="16" y1="17" x2="8" y2="17"></line>
          <polyline points="10 9 9 9 8 9"></polyline>
        </svg>
        276 Words
      </p>

      <p>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar">
          <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
          <line x1="16" y1="2" x2="16" y2="6"></line>
          <line x1="8" y1="2" x2="8" y2="6"></line>
          <line x1="3" y1="10" x2="21" y2="10"></line>
        </svg>
        
          2020-07-23 17:10 &#43;0100
        

         
          
        
      </p>
    </div>

    
      <div class="pagination">
        <div class="pagination__title">
          <span class="pagination__title-h">Read other posts</span>
          <hr />
        </div>

        <div class="pagination__buttons">
          
            <span class="button previous">
              <a href="/posts/2020/08/ssh-jump-server-on-raspberry-pi/">
                <span class="button__icon">←</span>
                <span class="button__text">SSH jump server on Raspberry pi</span>
              </a>
            </span>
          

          
            <span class="button next">
              <a href="/posts/2020/07/apb-tutorial/">
                <span class="button__text">APB Tutorial</span>
                <span class="button__icon">→</span>
              </a>
            </span>
          
        </div>
      </div>
    


    

    

  </main>

            </div>

            
                <footer class="footer">
    <div class="footer__inner">
        <div class="footer__content">
            <span>&copy; 2023</span>
            
            <span><a href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank" rel="noopener">CC BY-NC 4.0</a></span><span><a href="posts/index.xml" target="_blank" title="rss"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle></svg></a></span>
        </div>
    </div>
    <div class="footer__inner">
        <div class="footer__content">
            <span>Powered by <a href="http://gohugo.io">Hugo</a></span>
            <span>Made with &#10084; by <a href="https://github.com/rhazdon">Djordje Atlialp</a></span>
          </div>
    </div>
</footer>

            
        </div>

        



<script type="text/javascript" src="/bundle.min.2ce64ea6ea44a72b13dd812fc2eb5cca3efe878cce258a47c137c17edf46e0602a05e422b618a5b80b5939c731b7a293351c2f2222a21f6ee27e54a8448dd20e.js" integrity="sha512-LOZOpupEpysT3YEvwutcyj7&#43;h4zOJYpHwTfBft9G4GAqBeQithiluAtZOccxt6KTNRwvIiKiH27iflSoRI3SDg=="></script>



    </body>
</html>
