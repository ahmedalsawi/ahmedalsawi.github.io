<!DOCTYPE html>
<html lang="en">

<head>
  <title>
  LLM - AgentVerse Â· Techiedeepdive
</title>
  <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="color-scheme" content="light dark">




<meta name="description" content="AgentVerse is yet another agent framework but this one is interesting because:
 It has game-like UI. UI is implemented with Phaser which is HTML game development framework(live and learn) This is very thing LLamaIndex agent I can find (see ToolAgent)  AgentVerse provides 3 top level classes and CLI programs:
 Simulation CLI Simulation GUI Task Solving  I will look deeper into task solving TaskSolving because it looks the most relevant at the moment.">
<meta name="keywords" content="">

<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content=""/>

<meta name="twitter:title" content="LLM - AgentVerse"/>
<meta name="twitter:description" content="AgentVerse is yet another agent framework but this one is interesting because:
 It has game-like UI. UI is implemented with Phaser which is HTML game development framework(live and learn) This is very thing LLamaIndex agent I can find (see ToolAgent)  AgentVerse provides 3 top level classes and CLI programs:
 Simulation CLI Simulation GUI Task Solving  I will look deeper into task solving TaskSolving because it looks the most relevant at the moment."/>

<meta property="og:title" content="LLM - AgentVerse" />
<meta property="og:description" content="AgentVerse is yet another agent framework but this one is interesting because:
 It has game-like UI. UI is implemented with Phaser which is HTML game development framework(live and learn) This is very thing LLamaIndex agent I can find (see ToolAgent)  AgentVerse provides 3 top level classes and CLI programs:
 Simulation CLI Simulation GUI Task Solving  I will look deeper into task solving TaskSolving because it looks the most relevant at the moment." />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/2024/06/llm-agentverse/" /><meta property="og:image" content=""/><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-06-01T00:00:00+00:00" />
<meta property="article:modified_time" content="2024-06-01T00:00:00+00:00" /><meta property="og:site_name" content="Techiedeepdive" />





<link rel="canonical" href="/posts/2024/06/llm-agentverse/">


<link rel="preload" href="/fonts/fa-brands-400.woff2" as="font" type="font/woff2" crossorigin>
<link rel="preload" href="/fonts/fa-regular-400.woff2" as="font" type="font/woff2" crossorigin>
<link rel="preload" href="/fonts/fa-solid-900.woff2" as="font" type="font/woff2" crossorigin>


  
  
  <link rel="stylesheet" href="/css/coder.min.577e3c5ead537873430da16f0964b754a120fd87c4e2203a00686e7c75b51378.css" integrity="sha256-V348Xq1TeHNDDaFvCWS3VKEg/YfE4iA6AGhufHW1E3g=" crossorigin="anonymous" media="screen" />






  
    
    
    <link rel="stylesheet" href="/css/coder-dark.min.a00e6364bacbc8266ad1cc81230774a1397198f8cfb7bcba29b7d6fcb54ce57f.css" integrity="sha256-oA5jZLrLyCZq0cyBIwd0oTlxmPjPt7y6KbfW/LVM5X8=" crossorigin="anonymous" media="screen" />
  



 




<link rel="icon" type="image/svg+xml" href="/images/favicon.svg" sizes="any">
<link rel="icon" type="image/png" href="/images/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/images/favicon-16x16.png" sizes="16x16">

<link rel="apple-touch-icon" href="/images/apple-touch-icon.png">
<link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">

<link rel="manifest" href="/site.webmanifest">
<link rel="mask-icon" href="/images/safari-pinned-tab.svg" color="#5bbad5">









</head>






<body class="preload-transitions colorscheme-auto">
  
<div class="float-container">
    <a id="dark-mode-toggle" class="colorscheme-toggle">
        <i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i>
    </a>
</div>


  <main class="wrapper">
    <nav class="navigation">
  <section class="container">
    
    <a class="navigation-title" href="">
      Techiedeepdive
    </a>
    
    
      <input type="checkbox" id="menu-toggle" />
      <label class="menu-button float-right" for="menu-toggle">
        <i class="fa-solid fa-bars fa-fw" aria-hidden="true"></i>
      </label>
      <ul class="navigation-list">
        
          
            <li class="navigation-item">
              <a class="navigation-link " href="/posts">Blog</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link " href="/reading-list/">Reading list</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link " href="/tags/">Tags</a>
            </li>
          
        
        
      </ul>
    
  </section>
</nav>


    <div class="content">
      
  <section class="container post">
    <article>
      <header>
        <div class="post-title">
          <h1 class="title">
            <a class="title-link" href="/posts/2024/06/llm-agentverse/">
              LLM - AgentVerse
            </a>
          </h1>
        </div>
        <div class="post-meta">
          <div class="date">
            <span class="posted-on">
              <i class="fa-solid fa-calendar" aria-hidden="true"></i>
              <time datetime="2024-06-01T00:00:00Z">
                June 1, 2024
              </time>
            </span>
            <span class="reading-time">
              <i class="fa-solid fa-clock" aria-hidden="true"></i>
              10-minute read
            </span>
          </div>
          
          
          <div class="tags">
  <i class="fa-solid fa-tag" aria-hidden="true"></i>
    <span class="tag">
      <a href="/tags/llm/">llm</a>
    </span></div>

        </div>
      </header>

      <div class="post-content">
        
        <p><code>AgentVerse</code> is yet another agent framework but this one is interesting because:</p>
<ul>
<li>It has game-like UI. UI is implemented with <code>Phaser</code> which is HTML game development framework(live and learn)</li>
<li>This is very thing LLamaIndex agent I can find (see <code>ToolAgent</code>)</li>
</ul>
<p>AgentVerse provides 3 top level classes and CLI programs:</p>
<ul>
<li>Simulation CLI</li>
<li>Simulation GUI</li>
<li>Task Solving</li>
</ul>
<p>I will look deeper into task solving <code>TaskSolving</code> because it looks the most relevant at the moment. Starting with <code>agentverse_command/main_tasksolving_cli.py</code> which is really simple, just parsing task and task directory and creating <code>TaskSolving</code> object and <code>run()</code> it.</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#007f7f"># from agentverse.agentverse import AgentVerse</span>
<span style="color:#fff;font-weight:bold">from</span> agentverse.tasksolving <span style="color:#fff;font-weight:bold">import</span> TaskSolving

....

<span style="color:#fff;font-weight:bold">def</span> cli_main():
    agentversepipeline = TaskSolving.from_task(args.task, args.tasks_dir)
    agentversepipeline.run()

<span style="color:#fff;font-weight:bold">if</span> __name__ == <span style="color:#0ff;font-weight:bold">&#34;__main__&#34;</span>:
    cli_main()
</code></pre></div><h1 id="run-forest-run">
  Run forest run
  <a class="heading-link" href="#run-forest-run">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h1>
<p><code>run</code> just calls the env <code>run</code> and waits until it&rsquo;s done.</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">    <span style="color:#fff;font-weight:bold">def</span> run(self):
        <span style="color:#0ff;font-weight:bold">&#34;&#34;&#34;Run the environment from scratch until it is done.&#34;&#34;&#34;</span>
        self.environment.reset()
        self.logs = []
        advice = <span style="color:#0ff;font-weight:bold">&#34;No advice yet.&#34;</span>
        previous_plan = <span style="color:#0ff;font-weight:bold">&#34;No solution yet.&#34;</span>
        <span style="color:#fff;font-weight:bold">while</span> not self.environment.is_done():
            result, advice, previous_plan, logs, success = asyncio.run(
                self.environment.step(advice, previous_plan)
            )
            self.logs += logs
        self.environment.report_metrics()
        self.save_result(previous_plan, result, self.environment.get_spend())
        <span style="color:#fff;font-weight:bold">return</span> previous_plan, result, self.logs
</code></pre></div><p><code>is_done</code> waits until the environment succeeds (or max count is hit).</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">    <span style="color:#fff;font-weight:bold">def</span> is_done(self):
        <span style="color:#0ff;font-weight:bold">&#34;&#34;&#34;Check if the environment is done&#34;&#34;&#34;</span>
        <span style="color:#fff;font-weight:bold">return</span> self.cnt_turn &gt;= self.max_turn or self.success
</code></pre></div><p>They have reporting and cost calculation <code>report_metrics</code> and <code>get_spend</code>. They iterate agents <code>get_spend()</code></p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">    <span style="color:#fff;font-weight:bold">def</span> get_spend(self):
        total_spent = <span style="color:#fff;font-weight:bold">sum</span>([agent.get_spend() <span style="color:#fff;font-weight:bold">for</span> (_, agent) in self.iter_agents()])
        <span style="color:#fff;font-weight:bold">return</span> total_spent

    <span style="color:#fff;font-weight:bold">def</span> report_metrics(self) -&gt; <span style="color:#fff;font-weight:bold">None</span>:
        logger.info(<span style="color:#0ff;font-weight:bold">&#34;&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;Agent spend:&#34;</span>, Fore.GREEN)
        <span style="color:#fff;font-weight:bold">for</span> role, agent in self.iter_agents():
            name = agent.name.split(<span style="color:#0ff;font-weight:bold">&#34;:&#34;</span>)[<span style="color:#ff0;font-weight:bold">0</span>]
            logger.info(
                <span style="color:#0ff;font-weight:bold">&#34;&#34;</span>,
                <span style="color:#0ff;font-weight:bold">f</span><span style="color:#0ff;font-weight:bold">&#34;Agent (Role: </span><span style="color:#0ff;font-weight:bold">{</span>role<span style="color:#0ff;font-weight:bold">}</span><span style="color:#0ff;font-weight:bold">) </span><span style="color:#0ff;font-weight:bold">{</span>name<span style="color:#0ff;font-weight:bold">}</span><span style="color:#0ff;font-weight:bold">: </span><span style="color:#0ff;font-weight:bold">{</span>agent.get_spend_formatted()<span style="color:#0ff;font-weight:bold">}</span><span style="color:#0ff;font-weight:bold">&#34;</span>,
                Fore.GREEN,
            )
        logger.info(<span style="color:#0ff;font-weight:bold">&#34;&#34;</span>, <span style="color:#0ff;font-weight:bold">f</span><span style="color:#0ff;font-weight:bold">&#34;Total spent: $</span><span style="color:#0ff;font-weight:bold">{</span>self.get_spend()<span style="color:#0ff;font-weight:bold">:</span><span style="color:#0ff;font-weight:bold">.6f</span><span style="color:#0ff;font-weight:bold">}</span><span style="color:#0ff;font-weight:bold">&#34;</span>, Fore.GREEN)
</code></pre></div><p>We will talk more about environment later.</p>
<h1 id="tasksolving">
  TaskSolving
  <a class="heading-link" href="#tasksolving">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h1>
<p>So, what does <code>TaskSolving</code> do?
By default, it parses <code>brainstorming</code> from <code>agentverse/tasks/tasksolving/brainstorming/config.yaml</code> by calling <code>prepare_task_config</code></p>
<p>It also loads the agents and environment based on <code>config.yaml</code></p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">    @classmethod
    <span style="color:#fff;font-weight:bold">def</span> from_task(cls, task: <span style="color:#fff;font-weight:bold">str</span>, tasks_dir: <span style="color:#fff;font-weight:bold">str</span>):
        <span style="color:#0ff;font-weight:bold">&#34;&#34;&#34;Build an AgentVerse from a task name.
</span><span style="color:#0ff;font-weight:bold">        The task name should correspond to a directory in `tasks` directory.
</span><span style="color:#0ff;font-weight:bold">        Then this method will load the configuration from the yaml file in that directory.
</span><span style="color:#0ff;font-weight:bold">        &#34;&#34;&#34;</span>
        <span style="color:#007f7f"># Prepare the config of the task</span>
        task_config = prepare_task_config(task, tasks_dir)

        <span style="color:#007f7f"># Build the environment</span>
        env_config = task_config[<span style="color:#0ff;font-weight:bold">&#34;environment&#34;</span>]

        <span style="color:#007f7f"># Build agents for all pipeline (task)</span>
        agents = {}
        <span style="color:#fff;font-weight:bold">for</span> i, agent_config in <span style="color:#fff;font-weight:bold">enumerate</span>(task_config[<span style="color:#0ff;font-weight:bold">&#34;agents&#34;</span>]):
            <span style="color:#fff;font-weight:bold">if</span> agent_config.get(<span style="color:#0ff;font-weight:bold">&#34;agent_type&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;&#34;</span>) == <span style="color:#0ff;font-weight:bold">&#34;critic&#34;</span>:
                agent = load_agent(agent_config)
                agents[AGENT_TYPES.CRITIC] = [
                    copy.deepcopy(agent)
                    <span style="color:#fff;font-weight:bold">for</span> _ in <span style="color:#fff;font-weight:bold">range</span>(task_config.get(<span style="color:#0ff;font-weight:bold">&#34;cnt_agents&#34;</span>, <span style="color:#ff0;font-weight:bold">1</span>) - <span style="color:#ff0;font-weight:bold">1</span>)
                ]
            <span style="color:#fff;font-weight:bold">else</span>:
                agent_type = AGENT_TYPES.from_string(agent_config.get(<span style="color:#0ff;font-weight:bold">&#34;agent_type&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;&#34;</span>))
                agents[agent_type] = load_agent(agent_config)

        env_config[<span style="color:#0ff;font-weight:bold">&#34;agents&#34;</span>] = agents

        env_config[<span style="color:#0ff;font-weight:bold">&#34;task_description&#34;</span>] = task_config.get(<span style="color:#0ff;font-weight:bold">&#34;task_description&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;&#34;</span>)
        env_config[<span style="color:#0ff;font-weight:bold">&#34;max_rounds&#34;</span>] = task_config.get(<span style="color:#0ff;font-weight:bold">&#34;max_rounds&#34;</span>, <span style="color:#ff0;font-weight:bold">3</span>)

        environment: BasicEnvironment = load_environment(env_config)

        <span style="color:#fff;font-weight:bold">return</span> cls(environment=environment, task=task)
</code></pre></div><p>Let&rsquo;s dig deeper into these load tasks in <code>agentverse/initialization.py</code></p>
<h1 id="prepare_task_config">
  prepare_task_config
  <a class="heading-link" href="#prepare_task_config">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h1>
<p><code>prepare_task_config</code> loads yaml.config and some other infra stuff based on that yaml:</p>
<ul>
<li>Memory</li>
<li>LLM</li>
<li>tools</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#fff;font-weight:bold">def</span> prepare_task_config(task, tasks_dir):
    <span style="color:#0ff;font-weight:bold">&#34;&#34;&#34;Read the yaml config of the given task in `tasks` directory.&#34;&#34;&#34;</span>
    all_task_dir = tasks_dir
    task_path = os.path.join(all_task_dir, task)
    ...
    task_config = yaml.safe_load(<span style="color:#fff;font-weight:bold">open</span>(config_path))

    <span style="color:#fff;font-weight:bold">for</span> i, agent_configs in <span style="color:#fff;font-weight:bold">enumerate</span>(task_config[<span style="color:#0ff;font-weight:bold">&#34;agents&#34;</span>]):
        agent_configs[<span style="color:#0ff;font-weight:bold">&#34;memory&#34;</span>] = load_memory(agent_configs.get(<span style="color:#0ff;font-weight:bold">&#34;memory&#34;</span>, {}))
        <span style="color:#fff;font-weight:bold">if</span> agent_configs.get(<span style="color:#0ff;font-weight:bold">&#34;tool_memory&#34;</span>, <span style="color:#fff;font-weight:bold">None</span>) is not <span style="color:#fff;font-weight:bold">None</span>:
            agent_configs[<span style="color:#0ff;font-weight:bold">&#34;tool_memory&#34;</span>] = load_memory(agent_configs[<span style="color:#0ff;font-weight:bold">&#34;tool_memory&#34;</span>])

        llm = load_llm(agent_configs.get(<span style="color:#0ff;font-weight:bold">&#34;llm&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;text-davinci-003&#34;</span>))
        agent_configs[<span style="color:#0ff;font-weight:bold">&#34;llm&#34;</span>] = llm

        ...

        agent_configs[<span style="color:#0ff;font-weight:bold">&#34;tools&#34;</span>] = load_tools(agent_configs.get(<span style="color:#0ff;font-weight:bold">&#34;tools&#34;</span>, []))

    <span style="color:#fff;font-weight:bold">return</span> task_config
</code></pre></div><h1 id="load_llm">
  load_llm
  <a class="heading-link" href="#load_llm">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h1>
<p>Each framework implements its own LLM wrapper. This one is no different. <code>load_llm</code> just looks up LLM from <code>llm_registry</code></p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#fff;font-weight:bold">def</span> load_llm(llm_config: Dict):
    llm_type = llm_config.pop(<span style="color:#0ff;font-weight:bold">&#34;llm_type&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;text-davinci-003&#34;</span>)

    <span style="color:#fff;font-weight:bold">return</span> llm_registry.build(llm_type, **llm_config)
</code></pre></div><p>What populate <code>llm_registry</code>. Let&rsquo;s start with <code>LLMBase</code> defining common API implemented by each LLM class.</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#fff;font-weight:bold">class</span> BaseLLM(BaseModel):
    args: BaseModelArgs = Field(default_factory=BaseModelArgs)
    max_retry: <span style="color:#fff;font-weight:bold">int</span> = Field(default=<span style="color:#ff0;font-weight:bold">3</span>)
    client_args: Optional[Dict] = Field(default={})
    is_azure: <span style="color:#fff;font-weight:bold">bool</span> = Field(default=<span style="color:#fff;font-weight:bold">False</span>)

    @abstractmethod
    <span style="color:#fff;font-weight:bold">def</span> get_spend(self) -&gt; <span style="color:#fff;font-weight:bold">float</span>:
        <span style="color:#0ff;font-weight:bold">&#34;&#34;&#34;
</span><span style="color:#0ff;font-weight:bold">        Number of USD spent
</span><span style="color:#0ff;font-weight:bold">        &#34;&#34;&#34;</span>
        <span style="color:#fff;font-weight:bold">return</span> -<span style="color:#ff0;font-weight:bold">1.0</span>

    @abstractmethod
    <span style="color:#fff;font-weight:bold">def</span> generate_response(self, **kwargs) -&gt; LLMResult:
        <span style="color:#fff;font-weight:bold">pass</span>

    @abstractmethod
    <span style="color:#fff;font-weight:bold">def</span> agenerate_response(self, **kwargs) -&gt; LLMResult:
        <span style="color:#fff;font-weight:bold">pass</span>

<span style="color:#fff;font-weight:bold">class</span> BaseChatModel(BaseLLM):
    <span style="color:#fff;font-weight:bold">pass</span>

<span style="color:#fff;font-weight:bold">class</span> BaseCompletionModel(BaseLLM):
    <span style="color:#fff;font-weight:bold">pass</span>
</code></pre></div><p>Currently, they support openAI, Azura and Local VLLM. They pick up env vars and initialize llm objects.</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">    api_key = <span style="color:#fff;font-weight:bold">None</span>
    base_url = <span style="color:#fff;font-weight:bold">None</span>
    model_name = <span style="color:#fff;font-weight:bold">None</span>
    OPENAI_API_KEY = os.environ.get(<span style="color:#0ff;font-weight:bold">&#34;OPENAI_API_KEY&#34;</span>)
    OPENAI_BASE_URL = os.environ.get(<span style="color:#0ff;font-weight:bold">&#34;OPENAI_BASE_URL&#34;</span>)
    AZURE_API_KEY = os.environ.get(<span style="color:#0ff;font-weight:bold">&#34;AZURE_OPENAI_API_KEY&#34;</span>)
    AZURE_API_BASE = os.environ.get(<span style="color:#0ff;font-weight:bold">&#34;AZURE_OPENAI_API_BASE&#34;</span>)
    VLLM_BASE_URL = os.environ.get(<span style="color:#0ff;font-weight:bold">&#34;VLLM_BASE_URL&#34;</span>)
    VLLM_API_KEY = os.environ.get(<span style="color:#0ff;font-weight:bold">&#34;VLLM_API_KEY&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;EMPTY&#34;</span>)

    <span style="color:#fff;font-weight:bold">if</span> not OPENAI_API_KEY and not AZURE_API_KEY:
        logger.warn(
            <span style="color:#0ff;font-weight:bold">&#34;OpenAI API key is not set. Please set an environment variable OPENAI_API_KEY or &#34;</span>
            <span style="color:#0ff;font-weight:bold">&#34;AZURE_OPENAI_API_KEY.&#34;</span>
        )
    <span style="color:#fff;font-weight:bold">elif</span> OPENAI_API_KEY:
        DEFAULT_CLIENT = OpenAI(api_key=OPENAI_API_KEY, base_url=OPENAI_BASE_URL)
        DEFAULT_CLIENT_ASYNC = AsyncOpenAI(api_key=OPENAI_API_KEY, base_url=OPENAI_BASE_URL)
        api_key = OPENAI_API_KEY
        base_url = OPENAI_BASE_URL
    <span style="color:#fff;font-weight:bold">elif</span> AZURE_API_KEY:
        DEFAULT_CLIENT = AzureOpenAI(
            api_key=AZURE_API_KEY,
            azure_endpoint=AZURE_API_BASE,
            api_version=<span style="color:#0ff;font-weight:bold">&#34;2024-02-15-preview&#34;</span>,
        )
        DEFAULT_CLIENT_ASYNC = AsyncAzureOpenAI(
            api_key=AZURE_API_KEY,
            azure_endpoint=AZURE_API_BASE,
        )
        api_key = AZURE_API_KEY
        base_url = AZURE_API_BASE
    <span style="color:#fff;font-weight:bold">if</span> VLLM_BASE_URL:
        <span style="color:#fff;font-weight:bold">if</span> model_name := get_llm_server_modelname(VLLM_BASE_URL, VLLM_API_KEY, logger):
            <span style="color:#007f7f"># model_name = /mnt/llama/hf_models/TheBloke_Llama-2-70B-Chat-GPTQ</span>
            <span style="color:#007f7f"># transform to TheBloke/Llama-2-70B-Chat-GPTQ</span>
            hf_model_name = model_name.split(<span style="color:#0ff;font-weight:bold">&#34;/&#34;</span>)[-<span style="color:#ff0;font-weight:bold">1</span>].replace(<span style="color:#0ff;font-weight:bold">&#34;_&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;/&#34;</span>)
            LOCAL_LLMS.append(model_name)
            LOCAL_LLMS_MAPPING[model_name] = {
                <span style="color:#0ff;font-weight:bold">&#34;hf_model_name&#34;</span>: hf_model_name,
                <span style="color:#0ff;font-weight:bold">&#34;base_url&#34;</span>: VLLM_BASE_URL,
                <span style="color:#0ff;font-weight:bold">&#34;api_key&#34;</span>: VLLM_API_KEY <span style="color:#fff;font-weight:bold">if</span> VLLM_API_KEY <span style="color:#fff;font-weight:bold">else</span> <span style="color:#0ff;font-weight:bold">&#34;EMPTY&#34;</span>,
            }
            logger.info(<span style="color:#0ff;font-weight:bold">f</span><span style="color:#0ff;font-weight:bold">&#34;Using vLLM model: </span><span style="color:#0ff;font-weight:bold">{</span>hf_model_name<span style="color:#0ff;font-weight:bold">}</span><span style="color:#0ff;font-weight:bold">&#34;</span>)
    <span style="color:#fff;font-weight:bold">if</span> hf_model_name := get_llm_server_modelname(
        <span style="color:#0ff;font-weight:bold">&#34;http://localhost:5000&#34;</span>, logger=logger
    ):
        <span style="color:#007f7f"># meta-llama/Llama-2-7b-chat-hf</span>
        <span style="color:#007f7f"># transform to llama-2-7b-chat-hf</span>
        short_model_name = model_name.split(<span style="color:#0ff;font-weight:bold">&#34;/&#34;</span>)[-<span style="color:#ff0;font-weight:bold">1</span>].lower()
        LOCAL_LLMS.append(short_model_name)
        LOCAL_LLMS_MAPPING[short_model_name] = {
            <span style="color:#0ff;font-weight:bold">&#34;hf_model_name&#34;</span>: hf_model_name,
            <span style="color:#0ff;font-weight:bold">&#34;base_url&#34;</span>: <span style="color:#0ff;font-weight:bold">&#34;http://localhost:5000/v1&#34;</span>,
            <span style="color:#0ff;font-weight:bold">&#34;api_key&#34;</span>: <span style="color:#0ff;font-weight:bold">&#34;EMPTY&#34;</span>,
        }

        logger.info(<span style="color:#0ff;font-weight:bold">f</span><span style="color:#0ff;font-weight:bold">&#34;Using FSChat model: </span><span style="color:#0ff;font-weight:bold">{</span>model_name<span style="color:#0ff;font-weight:bold">}</span><span style="color:#0ff;font-weight:bold">&#34;</span>)
</code></pre></div><p>Then, They register the with model names.</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#007f7f"># To support your own local LLMs, register it here and add it into LOCAL_LLMS.</span>
@llm_registry.register(<span style="color:#0ff;font-weight:bold">&#34;gpt-35-turbo&#34;</span>)
@llm_registry.register(<span style="color:#0ff;font-weight:bold">&#34;gpt-3.5-turbo&#34;</span>)
@llm_registry.register(<span style="color:#0ff;font-weight:bold">&#34;gpt-4&#34;</span>)
@llm_registry.register(<span style="color:#0ff;font-weight:bold">&#34;vllm&#34;</span>)
@llm_registry.register(<span style="color:#0ff;font-weight:bold">&#34;local&#34;</span>)
<span style="color:#fff;font-weight:bold">class</span> OpenAIChat(BaseChatModel):
    args: OpenAIChatArgs = Field(default_factory=OpenAIChatArgs)
    client_args: Optional[Dict] = Field(
        default={<span style="color:#0ff;font-weight:bold">&#34;api_key&#34;</span>: api_key, <span style="color:#0ff;font-weight:bold">&#34;base_url&#34;</span>: base_url}
    )
    is_azure: <span style="color:#fff;font-weight:bold">bool</span> = Field(default=<span style="color:#fff;font-weight:bold">False</span>)

    total_prompt_tokens: <span style="color:#fff;font-weight:bold">int</span> = <span style="color:#ff0;font-weight:bold">0</span>
    total_completion_tokens: <span style="color:#fff;font-weight:bold">int</span> = <span style="color:#ff0;font-weight:bold">0</span>
</code></pre></div><h1 id="load_tools">
  load_tools
  <a class="heading-link" href="#load_tools">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h1>
<p>The tools are defined in <code>agentverse/tasks/tasksolving/tool_using/tools_simplified.json</code> which is using <code>BMTools</code>. (TODO)</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#fff;font-weight:bold">def</span> load_tools(tool_config: List[Dict]):
    <span style="color:#fff;font-weight:bold">if</span> <span style="color:#fff;font-weight:bold">len</span>(tool_config) == <span style="color:#ff0;font-weight:bold">0</span>:
        <span style="color:#fff;font-weight:bold">return</span> []
    all_tools_list = []
    <span style="color:#fff;font-weight:bold">for</span> tool in tool_config:
        _, config = load_single_tools(tool[<span style="color:#0ff;font-weight:bold">&#34;tool_name&#34;</span>], tool[<span style="color:#0ff;font-weight:bold">&#34;tool_url&#34;</span>])
        all_tools_list += import_all_apis(config)
    <span style="color:#fff;font-weight:bold">return</span> all_tools_list
</code></pre></div><p>An example of agent using tools are ones from <code>vacation</code> task.</p>
<ul>
<li>agentverse/tasks/tasksolving/tool_using/vacation/config.yaml</li>
<li>agentverse/tasks/tasksolving/tool_using/tools_simplified.json</li>
</ul>
<h1 id="load_environment-and-load_agent">
  load_environment and load_agent
  <a class="heading-link" href="#load_environment-and-load_agent">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h1>
<p>Both tasks just load the env or agent from <code>env_registry</code> and <code>agent_registry</code>. I guess we have to look at those</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#fff;font-weight:bold">def</span> load_environment(env_config: Dict) -&gt; BaseEnvironment:
    env_type = env_config.pop(<span style="color:#0ff;font-weight:bold">&#34;env_type&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;basic&#34;</span>)
    <span style="color:#fff;font-weight:bold">return</span> env_registry.build(env_type, **env_config)
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#fff;font-weight:bold">def</span> load_agent(agent_config: Dict) -&gt; BaseAgent:
    agent_type = agent_config.pop(<span style="color:#0ff;font-weight:bold">&#34;agent_type&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;conversation&#34;</span>)
    agent = agent_registry.build(agent_type, **agent_config)
    <span style="color:#fff;font-weight:bold">return</span> agent
</code></pre></div><h1 id="agents">
  Agents
  <a class="heading-link" href="#agents">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h1>
<p><code>BaseAgent</code> are defined in <code>agentverse/agents/base.py</code> with some API.</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#fff;font-weight:bold">class</span> BaseAgent(BaseModel):
    name: <span style="color:#fff;font-weight:bold">str</span>
    llm: BaseLLM
    output_parser: OutputParser
    prepend_prompt_template: <span style="color:#fff;font-weight:bold">str</span> = Field(default=<span style="color:#0ff;font-weight:bold">&#34;&#34;</span>)
    append_prompt_template: <span style="color:#fff;font-weight:bold">str</span> = Field(default=<span style="color:#0ff;font-weight:bold">&#34;&#34;</span>)
    prompt_template: <span style="color:#fff;font-weight:bold">str</span> = Field(default=<span style="color:#0ff;font-weight:bold">&#34;&#34;</span>)
    role_description: <span style="color:#fff;font-weight:bold">str</span> = Field(default=<span style="color:#0ff;font-weight:bold">&#34;&#34;</span>)
    memory: BaseMemory = Field(default_factory=ChatHistoryMemory)
    memory_manipulator: BaseMemoryManipulator = Field(
        default_factory=BaseMemoryManipulator
    )
    max_retry: <span style="color:#fff;font-weight:bold">int</span> = Field(default=<span style="color:#ff0;font-weight:bold">3</span>)
    receiver: Set[<span style="color:#fff;font-weight:bold">str</span>] = Field(default=<span style="color:#fff;font-weight:bold">set</span>({<span style="color:#0ff;font-weight:bold">&#34;all&#34;</span>}))
    async_mode: <span style="color:#fff;font-weight:bold">bool</span> = Field(default=<span style="color:#fff;font-weight:bold">True</span>)


    @abstractmethod
    <span style="color:#fff;font-weight:bold">def</span> step(self, env_description: <span style="color:#fff;font-weight:bold">str</span> = <span style="color:#0ff;font-weight:bold">&#34;&#34;</span>) -&gt; Message:
        <span style="color:#0ff;font-weight:bold">&#34;&#34;&#34;Get one step response&#34;&#34;&#34;</span>
        <span style="color:#fff;font-weight:bold">pass</span>

    @abstractmethod
    <span style="color:#fff;font-weight:bold">def</span> astep(self, env_description: <span style="color:#fff;font-weight:bold">str</span> = <span style="color:#0ff;font-weight:bold">&#34;&#34;</span>) -&gt; Message:
        <span style="color:#0ff;font-weight:bold">&#34;&#34;&#34;Asynchronous version of step&#34;&#34;&#34;</span>
        <span style="color:#fff;font-weight:bold">pass</span>
</code></pre></div><p>Specific agents extend <code>BaseAgent</code> and register with <code>agent_registry</code></p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">@agent_registry.register(<span style="color:#0ff;font-weight:bold">&#34;executor&#34;</span>)
<span style="color:#fff;font-weight:bold">class</span> ExecutorAgent(BaseAgent):
    max_history: <span style="color:#fff;font-weight:bold">int</span> = <span style="color:#ff0;font-weight:bold">5</span>

    <span style="color:#fff;font-weight:bold">def</span> step(
        self, task_description: <span style="color:#fff;font-weight:bold">str</span>, solution: <span style="color:#fff;font-weight:bold">str</span>, tools: List[<span style="color:#fff;font-weight:bold">dict</span>] = [], **kwargs
    ) -&gt; ExecutorMessage:
        <span style="color:#fff;font-weight:bold">pass</span>

    <span style="color:#fff;font-weight:bold">async</span> <span style="color:#fff;font-weight:bold">def</span> astep(
        self, task_description: <span style="color:#fff;font-weight:bold">str</span>, solution: <span style="color:#fff;font-weight:bold">str</span>, tools: List[<span style="color:#fff;font-weight:bold">dict</span>] = [], **kwargs
    ) -&gt; ExecutorMessage:
        logger.debug(<span style="color:#0ff;font-weight:bold">&#34;&#34;</span>, self.name, Fore.MAGENTA)
        prepend_prompt, append_prompt, prompt_token = self.get_all_prompts(
            task_description=task_description,
            solution=solution,
            agent_name=self.name,
            **kwargs,
        )
</code></pre></div><p>There is specific type of agents called <code>ToolAgent</code> which calls a tool to get an observation. This is very similar to LLamaIndex ReAct agent. See the call and acall below. It also prepares the prompts by listing all available tools.</p>
<p><code>agentverse/agents/simulation_agent/tool.py</code></p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">@agent_registry.register(<span style="color:#0ff;font-weight:bold">&#34;tool&#34;</span>)
<span style="color:#fff;font-weight:bold">class</span> ToolAgent(BaseAgent):
    tools: List[BaseTool] = Field(default=[])
    tool_memory: BaseMemory = Field(default_factory=ChatHistoryMemory)
    verbose: <span style="color:#fff;font-weight:bold">bool</span> = Field(default=<span style="color:#fff;font-weight:bold">False</span>)

    <span style="color:#fff;font-weight:bold">def</span> step(self, env_description: <span style="color:#fff;font-weight:bold">str</span> = <span style="color:#0ff;font-weight:bold">&#34;&#34;</span>) -&gt; Message:
        parsed_response = <span style="color:#fff;font-weight:bold">None</span>
        tool_observation = [self.tool_memory.to_string()]
        <span style="color:#fff;font-weight:bold">while</span> <span style="color:#fff;font-weight:bold">True</span>:
            prompt = self._fill_prompt_template(env_description, tool_observation)

            <span style="color:#fff;font-weight:bold">for</span> i in <span style="color:#fff;font-weight:bold">range</span>(self.max_retry):
                <span style="color:#fff;font-weight:bold">try</span>:
                    response = self.llm.generate_response(prompt)
                    parsed_response = self.output_parser.parse(respon...


    <span style="color:#fff;font-weight:bold">def</span> _call_tool(self, response: NamedTuple) -&gt; <span style="color:#fff;font-weight:bold">str</span>:
        <span style="color:#0ff;font-weight:bold">&#34;&#34;&#34;Call a tool and return the output&#34;&#34;&#34;</span>
        name_to_tool = {tool.name: tool <span style="color:#fff;font-weight:bold">for</span> tool in self.tools}
        <span style="color:#fff;font-weight:bold">if</span> response.tool not in name_to_tool:
            <span style="color:#fff;font-weight:bold">raise</span> ToolNotExistError(response.tool)
        tool = name_to_tool[response.tool]
        observation = tool.run(response.tool_input, verbose=self.verbose)
        <span style="color:#fff;font-weight:bold">return</span> observation

    <span style="color:#fff;font-weight:bold">async</span> <span style="color:#fff;font-weight:bold">def</span> _acall_tool(self, response: NamedTuple) -&gt; <span style="color:#fff;font-weight:bold">str</span>:
        <span style="color:#0ff;font-weight:bold">&#34;&#34;&#34;Call a tool and return the output&#34;&#34;&#34;</span>
        name_to_tool = {tool.name: tool <span style="color:#fff;font-weight:bold">for</span> tool in self.tools}
        <span style="color:#fff;font-weight:bold">if</span> response.tool not in name_to_tool:
            <span style="color:#fff;font-weight:bold">raise</span> ToolNotExistError(response.tool)
        tool = name_to_tool[response.tool]
        observation = <span style="color:#fff;font-weight:bold">await</span> tool.arun(response.tool_input, verbose=self.verbose)
        <span style="color:#fff;font-weight:bold">return</span> observation

    <span style="color:#fff;font-weight:bold">def</span> _fill_prompt_template(
        self, env_description: <span style="color:#fff;font-weight:bold">str</span> = <span style="color:#0ff;font-weight:bold">&#34;&#34;</span>, tool_observation: List[<span style="color:#fff;font-weight:bold">str</span>] = []
    ) -&gt; <span style="color:#fff;font-weight:bold">str</span>:
        <span style="color:#0ff;font-weight:bold">&#34;&#34;&#34;Fill the placeholders in the prompt template
</span><span style="color:#0ff;font-weight:bold">
</span><span style="color:#0ff;font-weight:bold">        In the tool agent, these placeholders are supported:
</span><span style="color:#0ff;font-weight:bold">        - $</span><span style="color:#0ff;font-weight:bold">{agent_name}</span><span style="color:#0ff;font-weight:bold">: the name of the agent
</span><span style="color:#0ff;font-weight:bold">        - $</span><span style="color:#0ff;font-weight:bold">{env_description}</span><span style="color:#0ff;font-weight:bold">: the description of the environment
</span><span style="color:#0ff;font-weight:bold">        - $</span><span style="color:#0ff;font-weight:bold">{role_description}</span><span style="color:#0ff;font-weight:bold">: the description of the role of the agent
</span><span style="color:#0ff;font-weight:bold">        - $</span><span style="color:#0ff;font-weight:bold">{chat_history}</span><span style="color:#0ff;font-weight:bold">: the chat history of the agent
</span><span style="color:#0ff;font-weight:bold">        - $</span><span style="color:#0ff;font-weight:bold">{tools}</span><span style="color:#0ff;font-weight:bold">: the list of tools and their usage
</span><span style="color:#0ff;font-weight:bold">        - $</span><span style="color:#0ff;font-weight:bold">{tool_names}</span><span style="color:#0ff;font-weight:bold">: the list of tool names
</span><span style="color:#0ff;font-weight:bold">        - $</span><span style="color:#0ff;font-weight:bold">{tool_observations}</span><span style="color:#0ff;font-weight:bold">: the observation of the tool in this turn
</span><span style="color:#0ff;font-weight:bold">        &#34;&#34;&#34;</span>
        tools = <span style="color:#0ff;font-weight:bold">&#34;</span><span style="color:#0ff;font-weight:bold">\n</span><span style="color:#0ff;font-weight:bold">&#34;</span>.join([<span style="color:#0ff;font-weight:bold">f</span><span style="color:#0ff;font-weight:bold">&#34;&gt; </span><span style="color:#0ff;font-weight:bold">{</span>tool.name<span style="color:#0ff;font-weight:bold">}</span><span style="color:#0ff;font-weight:bold">: </span><span style="color:#0ff;font-weight:bold">{</span>tool.description<span style="color:#0ff;font-weight:bold">}</span><span style="color:#0ff;font-weight:bold">&#34;</span> <span style="color:#fff;font-weight:bold">for</span> tool in self.tools])
        tools = tools.replace(<span style="color:#0ff;font-weight:bold">&#34;{{&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;{&#34;</span>).replace(<span style="color:#0ff;font-weight:bold">&#34;}}&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;}&#34;</span>)
        tool_names = <span style="color:#0ff;font-weight:bold">&#34;, &#34;</span>.join([tool.name <span style="color:#fff;font-weight:bold">for</span> tool in self.tools])
        input_arguments = {
            <span style="color:#0ff;font-weight:bold">&#34;agent_name&#34;</span>: self.name,
            <span style="color:#0ff;font-weight:bold">&#34;env_description&#34;</span>: env_description,
            <span style="color:#0ff;font-weight:bold">&#34;role_description&#34;</span>: self.role_description,
            <span style="color:#0ff;font-weight:bold">&#34;chat_history&#34;</span>: self.memory.to_string(add_sender_prefix=<span style="color:#fff;font-weight:bold">True</span>),
            <span style="color:#0ff;font-weight:bold">&#34;tools&#34;</span>: tools,
            <span style="color:#0ff;font-weight:bold">&#34;tool_names&#34;</span>: tool_names,
            <span style="color:#0ff;font-weight:bold">&#34;tool_observation&#34;</span>: <span style="color:#0ff;font-weight:bold">&#34;</span><span style="color:#0ff;font-weight:bold">\n</span><span style="color:#0ff;font-weight:bold">&#34;</span>.join(tool_observation),
        }
        <span style="color:#fff;font-weight:bold">return</span> Template(self.prompt_template).safe_substitute(input_arguments)
</code></pre></div><h1 id="environment">
  Environment
  <a class="heading-link" href="#environment">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h1>
<p>As usual there is <code>BaseEnvironment</code> with API for child envs to implement.</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#fff;font-weight:bold">class</span> BaseEnvironment(BaseModel):
    <span style="color:#0ff;font-weight:bold">&#34;&#34;&#34;
</span><span style="color:#0ff;font-weight:bold">    Base class for environment.
</span><span style="color:#0ff;font-weight:bold">
</span><span style="color:#0ff;font-weight:bold">    Args:
</span><span style="color:#0ff;font-weight:bold">        agents: List of agents
</span><span style="color:#0ff;font-weight:bold">        rule: Rule for the environment
</span><span style="color:#0ff;font-weight:bold">        max_turns: Maximum number of turns
</span><span style="color:#0ff;font-weight:bold">        cnt_turn: Current turn number
</span><span style="color:#0ff;font-weight:bold">        last_messages: Messages from last turn
</span><span style="color:#0ff;font-weight:bold">        rule_params: Variables set by the rule
</span><span style="color:#0ff;font-weight:bold">    &#34;&#34;&#34;</span>

    agents: List[BaseAgent]
    rule: BaseRule
    max_turns: <span style="color:#fff;font-weight:bold">int</span> = <span style="color:#ff0;font-weight:bold">10</span>
    cnt_turn: <span style="color:#fff;font-weight:bold">int</span> = <span style="color:#ff0;font-weight:bold">0</span>
    last_messages: List[Message] = []
    rule_params: Dict = {}

    @abstractmethod
    <span style="color:#fff;font-weight:bold">async</span> <span style="color:#fff;font-weight:bold">def</span> step(self) -&gt; List[Message]:
        <span style="color:#0ff;font-weight:bold">&#34;&#34;&#34;Run one step of the environment&#34;&#34;&#34;</span>
        <span style="color:#fff;font-weight:bold">pass</span>

    @abstractmethod
    <span style="color:#fff;font-weight:bold">def</span> reset(self) -&gt; <span style="color:#fff;font-weight:bold">None</span>:
        <span style="color:#0ff;font-weight:bold">&#34;&#34;&#34;Reset the environment&#34;&#34;&#34;</span>
        <span style="color:#fff;font-weight:bold">pass</span>

    <span style="color:#fff;font-weight:bold">def</span> report_metrics(self) -&gt; <span style="color:#fff;font-weight:bold">None</span>:
        <span style="color:#0ff;font-weight:bold">&#34;&#34;&#34;Report useful metrics&#34;&#34;&#34;</span>
        total_spent = <span style="color:#fff;font-weight:bold">sum</span>([agent.get_spend() <span style="color:#fff;font-weight:bold">for</span> agent in self.agents])
        logger.info(<span style="color:#0ff;font-weight:bold">f</span><span style="color:#0ff;font-weight:bold">&#34;Total spent: $</span><span style="color:#0ff;font-weight:bold">{</span>total_spent<span style="color:#0ff;font-weight:bold">}</span><span style="color:#0ff;font-weight:bold">&#34;</span>)
        <span style="color:#fff;font-weight:bold">pass</span>

    <span style="color:#fff;font-weight:bold">def</span> is_done(self) -&gt; <span style="color:#fff;font-weight:bold">bool</span>:
        <span style="color:#0ff;font-weight:bold">&#34;&#34;&#34;Check if the environment is done&#34;&#34;&#34;</span>
        <span style="color:#fff;font-weight:bold">return</span> self.cnt_turn &gt;= self.max_turns
</code></pre></div><p>For example, The env for <code>TaskSolving</code> is <code>BasicEnvironment</code></p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#fff;font-weight:bold">from</span> agentverse.environments.tasksolving_env.rules <span style="color:#fff;font-weight:bold">import</span> TasksolvingRule

@EnvironmentRegistry.register(<span style="color:#0ff;font-weight:bold">&#34;task-basic&#34;</span>)
<span style="color:#fff;font-weight:bold">class</span> BasicEnvironment(BaseEnvironment):
    rule: TasksolvingRule
    agents: Dict[Enum, Union[BaseAgent, List[BaseAgent]]] = <span style="color:#fff;font-weight:bold">None</span>

    task_description: <span style="color:#fff;font-weight:bold">str</span>

    cnt_turn: <span style="color:#fff;font-weight:bold">int</span> = <span style="color:#ff0;font-weight:bold">0</span>
    max_turn: <span style="color:#fff;font-weight:bold">int</span> = <span style="color:#ff0;font-weight:bold">10</span>
    success: <span style="color:#fff;font-weight:bold">bool</span> = <span style="color:#fff;font-weight:bold">False</span>

    <span style="color:#fff;font-weight:bold">def</span> __init__(self, **kwargs):
        rule_config = kwargs.pop(<span style="color:#0ff;font-weight:bold">&#34;rule&#34;</span>, {})
        role_assigner_config = rule_config.pop(
            <span style="color:#0ff;font-weight:bold">&#34;role_assigner&#34;</span>, {<span style="color:#0ff;font-weight:bold">&#34;type&#34;</span>: <span style="color:#0ff;font-weight:bold">&#34;role_description&#34;</span>}
        )
        decision_maker_config = rule_config.pop(<span style="color:#0ff;font-weight:bold">&#34;decision_maker&#34;</span>, {<span style="color:#0ff;font-weight:bold">&#34;type&#34;</span>: <span style="color:#0ff;font-weight:bold">&#34;vertical&#34;</span>})
        executor_config = rule_config.pop(<span style="color:#0ff;font-weight:bold">&#34;executor&#34;</span>, {<span style="color:#0ff;font-weight:bold">&#34;type&#34;</span>: <span style="color:#0ff;font-weight:bold">&#34;none&#34;</span>})
        evaluator_config = rule_config.pop(<span style="color:#0ff;font-weight:bold">&#34;evaluator&#34;</span>, {<span style="color:#0ff;font-weight:bold">&#34;type&#34;</span>: <span style="color:#0ff;font-weight:bold">&#34;basic&#34;</span>})
        rule = TasksolvingRule(
            role_assigner_config=role_assigner_config,
            decision_maker_config=decision_maker_config,
            executor_config=executor_config,
            evaluator_config=evaluator_config,
        )
        <span style="color:#fff;font-weight:bold">super</span>().__init__(rule=rule, **kwargs)
</code></pre></div><p>Now, This is the most important part as the env, how agent <em>talk</em> based on <code>TasksolvingRule</code> in <code>agentverse/environments/tasksolving_env/rules</code>. The stages implemented in the env <code>step</code> are:</p>
<ul>
<li>assignment</li>
<li>plan</li>
<li>execute</li>
<li>evaluate</li>
</ul>
<p><code>step</code> is called multiple times until score (it&rsquo;s set to 8 but comment says it is arbitrary)</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">    <span style="color:#fff;font-weight:bold">async</span> <span style="color:#fff;font-weight:bold">def</span> step(
        self, advice: <span style="color:#fff;font-weight:bold">str</span> = <span style="color:#0ff;font-weight:bold">&#34;No advice yet.&#34;</span>, previous_plan: <span style="color:#fff;font-weight:bold">str</span> = <span style="color:#0ff;font-weight:bold">&#34;No solution yet.&#34;</span>
    ) -&gt; List[Message]:


        <span style="color:#007f7f"># ================== EXPERT RECRUITMENT ==================</span>
        agents = <span style="color:#fff;font-weight:bold">await</span> self.rule.role_assign(
            self.task_description, self.agents, self.cnt_turn, advice
        )
        description = <span style="color:#0ff;font-weight:bold">&#34;</span><span style="color:#0ff;font-weight:bold">\n</span><span style="color:#0ff;font-weight:bold">&#34;</span>.join([agent.role_description <span style="color:#fff;font-weight:bold">for</span> agent in agents])

        <span style="color:#007f7f"># ================== EXPERT RECRUITMENT ==================</span>

        <span style="color:#007f7f"># ================== DECISION MAKING ==================</span>
        plan: List[SolverMessage] = <span style="color:#fff;font-weight:bold">await</span> self.rule.decision_making(
            self.task_description, self.agents, previous_plan, advice
        )
        flatten_plan = <span style="color:#0ff;font-weight:bold">&#34;</span><span style="color:#0ff;font-weight:bold">\n</span><span style="color:#0ff;font-weight:bold">&#34;</span>.join([p.content <span style="color:#fff;font-weight:bold">for</span> p in plan])
        <span style="color:#007f7f"># ================== DECISION MAKING ==================</span>

        <span style="color:#007f7f"># ================== EXECUTION ==================</span>
        result: List[ExecutorMessage] = <span style="color:#fff;font-weight:bold">await</span> self.rule.execute(
            self.task_description, self.agents, plan
        )
        flatten_result = <span style="color:#0ff;font-weight:bold">&#34;</span><span style="color:#0ff;font-weight:bold">\n</span><span style="color:#0ff;font-weight:bold">&#34;</span>.join([r.content <span style="color:#fff;font-weight:bold">for</span> r in result])

        <span style="color:#007f7f"># ================== EXECUTION ==================</span>

        <span style="color:#007f7f"># ================== EVALUATION ==================</span>
        score, advice = <span style="color:#fff;font-weight:bold">await</span> self.rule.evaluate(
            self.task_description, self.agents, plan, result
        )

        <span style="color:#fff;font-weight:bold">if</span> score is not <span style="color:#fff;font-weight:bold">None</span> and (
            (<span style="color:#fff;font-weight:bold">isinstance</span>(score, <span style="color:#fff;font-weight:bold">bool</span>) and score is <span style="color:#fff;font-weight:bold">True</span>)
            or (<span style="color:#fff;font-weight:bold">isinstance</span>(score, (<span style="color:#fff;font-weight:bold">list</span>, <span style="color:#fff;font-weight:bold">tuple</span>)) and <span style="color:#fff;font-weight:bold">all</span>([s &gt;= <span style="color:#ff0;font-weight:bold">8</span> <span style="color:#fff;font-weight:bold">for</span> s in score]))
        ):
            <span style="color:#007f7f"># TODO: 8 is an arbitrary threshold</span>
            logs.append({<span style="color:#0ff;font-weight:bold">&#34;agent&#34;</span>: <span style="color:#0ff;font-weight:bold">&#34;system&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;content&#34;</span>: <span style="color:#0ff;font-weight:bold">&#34;Good score! Accept!&#34;</span>})
            logger.info(
                <span style="color:#0ff;font-weight:bold">&#34;&#34;</span>, <span style="color:#0ff;font-weight:bold">f</span><span style="color:#0ff;font-weight:bold">&#34;Good score! Accept! Final Result:</span><span style="color:#0ff;font-weight:bold">\n</span><span style="color:#0ff;font-weight:bold">{</span>flatten_plan<span style="color:#0ff;font-weight:bold">}</span><span style="color:#0ff;font-weight:bold">&#34;</span>, Fore.GREEN
            )
            self.success = <span style="color:#fff;font-weight:bold">True</span>
        <span style="color:#fff;font-weight:bold">else</span>:
            logs.append({<span style="color:#0ff;font-weight:bold">&#34;agent&#34;</span>: <span style="color:#0ff;font-weight:bold">&#34;system&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;content&#34;</span>: <span style="color:#0ff;font-weight:bold">&#34;Bad score! Reject!&#34;</span>})
            logger.info(<span style="color:#0ff;font-weight:bold">&#34;&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;Bad score! Reject!&#34;</span>, Fore.RED)
        self.cnt_turn += <span style="color:#ff0;font-weight:bold">1</span>
        <span style="color:#fff;font-weight:bold">return</span> flatten_result, advice, flatten_plan, logs, self.success
</code></pre></div><p>It&rsquo;s clear that env delegates to the rules. Let&rsquo;s dig deeper into those.</p>
<h1 id="rules">
  Rules
  <a class="heading-link" href="#rules">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h1>
<p>Looking at <code>TasksolvingRule</code> as env delegates it by calling methods in env <code>step</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">    <span style="color:#fff;font-weight:bold">async</span> <span style="color:#fff;font-weight:bold">def</span> role_assign(
        self,
        task_description: <span style="color:#fff;font-weight:bold">str</span>,
        agents: List[BaseAgent],
        cnt_turn: <span style="color:#fff;font-weight:bold">int</span>,
        advice: <span style="color:#fff;font-weight:bold">str</span> = <span style="color:#0ff;font-weight:bold">&#34;&#34;</span>,
    ) -&gt; List[BaseAgent]:
        <span style="color:#0ff;font-weight:bold">&#34;&#34;&#34;Assign roles to agents&#34;&#34;&#34;</span>
        <span style="color:#fff;font-weight:bold">if</span> self.role_assign_only_once and cnt_turn &gt; <span style="color:#ff0;font-weight:bold">0</span>:
            agents = [agents[AGENT_TYPES.SOLVER]] + agents[AGENT_TYPES.CRITIC]
        <span style="color:#fff;font-weight:bold">else</span>:
            agents = <span style="color:#fff;font-weight:bold">await</span> self.role_assigner.astep(
                role_assigner=agents[AGENT_TYPES.ROLE_ASSIGNMENT],
                group_members=[agents[AGENT_TYPES.SOLVER]] + agents[AGENT_TYPES.CRITIC],
                advice=advice,
                task_description=task_description,
            )
            <span style="color:#fff;font-weight:bold">if</span> self.role_assign_only_once and cnt_turn == <span style="color:#ff0;font-weight:bold">0</span>:
                agents[AGENT_TYPES.SOLVER] = agents[<span style="color:#ff0;font-weight:bold">0</span>]
                agents[AGENT_TYPES.CRITIC] = agents[<span style="color:#ff0;font-weight:bold">1</span>:]
        <span style="color:#fff;font-weight:bold">return</span> agents
</code></pre></div><p>The <code>agentverse/environments/tasksolving_env/rules/role_assigner/role_description.py</code> which simply calls <code>astep</code> from the agent assigned for <code>role_description</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#fff;font-weight:bold">class</span> BaseRoleAssigner(BaseModel):
    <span style="color:#0ff;font-weight:bold">&#34;&#34;&#34;
</span><span style="color:#0ff;font-weight:bold">    The base class of role assignment class.
</span><span style="color:#0ff;font-weight:bold">    &#34;&#34;&#34;</span>

    @abstractmethod
    <span style="color:#fff;font-weight:bold">async</span> <span style="color:#fff;font-weight:bold">def</span> astep(
        self,
        role_assigner: RoleAssignerAgent,
        group_members: List[CriticAgent],
        advice: <span style="color:#fff;font-weight:bold">str</span> = <span style="color:#0ff;font-weight:bold">&#34;No advice yet.&#34;</span>,
        task_description: <span style="color:#fff;font-weight:bold">str</span> = <span style="color:#0ff;font-weight:bold">&#34;&#34;</span>,
        *args,
        **kwargs,
    ) -&gt; List[CriticAgent]:
        <span style="color:#fff;font-weight:bold">pass</span>

    <span style="color:#fff;font-weight:bold">def</span> reset(self):
        <span style="color:#fff;font-weight:bold">pass</span>

@role_assigner_registry.register(<span style="color:#0ff;font-weight:bold">&#34;role_description&#34;</span>)
<span style="color:#fff;font-weight:bold">class</span> DescriptionAssigner(BaseRoleAssigner):
    <span style="color:#0ff;font-weight:bold">&#34;&#34;&#34;
</span><span style="color:#0ff;font-weight:bold">    Generates descriptions for each agent.
</span><span style="color:#0ff;font-weight:bold">    &#34;&#34;&#34;</span>

    <span style="color:#fff;font-weight:bold">async</span> <span style="color:#fff;font-weight:bold">def</span> astep(
        self,
        role_assigner: RoleAssignerAgent,
        group_members: List[CriticAgent],
        advice: <span style="color:#fff;font-weight:bold">str</span> = <span style="color:#0ff;font-weight:bold">&#34;No advice yet.&#34;</span>,
        task_description: <span style="color:#fff;font-weight:bold">str</span> = <span style="color:#0ff;font-weight:bold">&#34;&#34;</span>,
        *args,
        **kwargs,
    ) -&gt; List[CriticAgent]:
        <span style="color:#fff;font-weight:bold">assert</span> task_description != <span style="color:#0ff;font-weight:bold">&#34;&#34;</span>
        <span style="color:#fff;font-weight:bold">assert</span> <span style="color:#fff;font-weight:bold">len</span>(group_members) &gt; <span style="color:#ff0;font-weight:bold">0</span>

        roles = <span style="color:#fff;font-weight:bold">await</span> role_assigner.astep(advice, task_description, <span style="color:#fff;font-weight:bold">len</span>(group_members))
        <span style="color:#fff;font-weight:bold">if</span> <span style="color:#fff;font-weight:bold">len</span>(roles.content) &lt; <span style="color:#fff;font-weight:bold">len</span>(group_members):
            <span style="color:#fff;font-weight:bold">raise</span> ValueError(
                <span style="color:#0ff;font-weight:bold">f</span><span style="color:#0ff;font-weight:bold">&#34;Number of roles (</span><span style="color:#0ff;font-weight:bold">{</span><span style="color:#fff;font-weight:bold">len</span>(roles.content)<span style="color:#0ff;font-weight:bold">}</span><span style="color:#0ff;font-weight:bold">) and number of group members (</span><span style="color:#0ff;font-weight:bold">{</span><span style="color:#fff;font-weight:bold">len</span>(group_members)<span style="color:#0ff;font-weight:bold">}</span><span style="color:#0ff;font-weight:bold">) do not match.&#34;</span>
            )
        <span style="color:#fff;font-weight:bold">for</span> role, member in <span style="color:#fff;font-weight:bold">zip</span>(roles.content[: <span style="color:#fff;font-weight:bold">len</span>(group_members)], group_members):
            description = role.strip().strip(<span style="color:#0ff;font-weight:bold">&#34;.&#34;</span>)
            member.role_description = description
            member.name = description

        <span style="color:#fff;font-weight:bold">return</span> group_members

    <span style="color:#fff;font-weight:bold">def</span> reset(self):
        <span style="color:#fff;font-weight:bold">pass</span>
</code></pre></div>
      </div>


      <footer>
        


        
        
        
        
        

        
      </footer>
    </article>

    
  </section>

    </div>

    <footer class="footer">
  <section class="container">
    Â©
    
    2024
    
    Â·
    
      Licensed under <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">CC BY-SA-4.0</a>
    Â·
    
    Powered by <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> & <a href="https://github.com/luizdepra/hugo-coder/" target="_blank" rel="noopener">Coder</a>.
    
  </section>
</footer>

  </main>

  

  
  
  <script src="/js/coder.min.369d90111ae4409b4e51de5efd23a46b92663fcc82dc9a0efde7f70bffc3f949.js" integrity="sha256-Np2QERrkQJtOUd5e/SOka5JmP8yC3JoO/ef3C//D&#43;Uk="></script>
  

  

  


  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  
</body>

</html>
