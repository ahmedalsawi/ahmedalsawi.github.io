<!DOCTYPE html>
<html lang="en">

<head>
  <title>
  Linux Kernel crypto Utilities · Techiedeepdive
</title>
  <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="color-scheme" content="light dark">




<meta name="description" content="Keyring  Link to heading   keyring a safe way to work with sensitive data in memory. From link, It&rsquo;s described as follows:
 This service allows cryptographic keys, authentication tokens, cross-domain user mappings, and similar to be cached in the kernel for the use of filesystems and other kernel services.
In this context, keys represent units of cryptographic data, authentication tokens, keyrings, etc.. These are represented in the kernel by struct key.">
<meta name="keywords" content="">

<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content=""/>

<meta name="twitter:title" content="Linux Kernel crypto Utilities"/>
<meta name="twitter:description" content="Keyring  Link to heading   keyring a safe way to work with sensitive data in memory. From link, It&rsquo;s described as follows:
 This service allows cryptographic keys, authentication tokens, cross-domain user mappings, and similar to be cached in the kernel for the use of filesystems and other kernel services.
In this context, keys represent units of cryptographic data, authentication tokens, keyrings, etc.. These are represented in the kernel by struct key."/>

<meta property="og:title" content="Linux Kernel crypto Utilities" />
<meta property="og:description" content="Keyring  Link to heading   keyring a safe way to work with sensitive data in memory. From link, It&rsquo;s described as follows:
 This service allows cryptographic keys, authentication tokens, cross-domain user mappings, and similar to be cached in the kernel for the use of filesystems and other kernel services.
In this context, keys represent units of cryptographic data, authentication tokens, keyrings, etc.. These are represented in the kernel by struct key." />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/2023/04/linux-kernel-crypto-utilities/" /><meta property="og:image" content=""/><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-04-09T00:00:00+00:00" />
<meta property="article:modified_time" content="2023-04-09T00:00:00+00:00" /><meta property="og:site_name" content="Techiedeepdive" />





<link rel="canonical" href="/posts/2023/04/linux-kernel-crypto-utilities/">


<link rel="preload" href="/fonts/forkawesome-webfont.woff2?v=1.2.0" as="font" type="font/woff2" crossorigin>


  
  
  <link rel="stylesheet" href="/css/coder.min.0669b62fc2c181a12a4ba10be9984e385c9a5e83dc7cb7ae3759ad0b98d7e8b2.css" integrity="sha256-Bmm2L8LBgaEqS6EL6ZhOOFyaXoPcfLeuN1mtC5jX6LI=" crossorigin="anonymous" media="screen" />






  
    
    
    <link rel="stylesheet" href="/css/coder-dark.min.f6534b0b446b75d9b6ad77a97d43ede2ddaeff1b6e2361fb7198d6f8fcb7f83f.css" integrity="sha256-9lNLC0Rrddm2rXepfUPt4t2u/xtuI2H7cZjW&#43;Py3&#43;D8=" crossorigin="anonymous" media="screen" />
  



 




<link rel="icon" type="image/png" href="/images/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/images/favicon-16x16.png" sizes="16x16">

<link rel="apple-touch-icon" href="/images/apple-touch-icon.png">
<link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">

<link rel="manifest" href="/site.webmanifest">
<link rel="mask-icon" href="/images/safari-pinned-tab.svg" color="#5bbad5">




<meta name="generator" content="Hugo 0.92.2" />





</head>






<body class="preload-transitions colorscheme-auto">
  
<div class="float-container">
    <a id="dark-mode-toggle" class="colorscheme-toggle">
        <i class="fa fa-adjust fa-fw" aria-hidden="true"></i>
    </a>
</div>


  <main class="wrapper">
    <nav class="navigation">
  <section class="container">
    <a class="navigation-title" href="/">
      Techiedeepdive
    </a>
    
      <input type="checkbox" id="menu-toggle" />
      <label class="menu-button float-right" for="menu-toggle">
        <i class="fa fa-bars fa-fw" aria-hidden="true"></i>
      </label>
      <ul class="navigation-list">
        
          
            <li class="navigation-item">
              <a class="navigation-link" href="/posts">Blog</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link" href="/reading-list/">Reading list</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link" href="/tags/">Tags</a>
            </li>
          
        
        
      </ul>
    
  </section>
</nav>


    <div class="content">
      
  <section class="container post">
    <article>
      <header>
        <div class="post-title">
          <h1 class="title">
            <a class="title-link" href="/posts/2023/04/linux-kernel-crypto-utilities/">
              Linux Kernel crypto Utilities
            </a>
          </h1>
        </div>
        <div class="post-meta">
          <div class="date">
            <span class="posted-on">
              <i class="fa fa-calendar" aria-hidden="true"></i>
              <time datetime="2023-04-09T00:00:00Z">
                April 9, 2023
              </time>
            </span>
            <span class="reading-time">
              <i class="fa fa-clock-o" aria-hidden="true"></i>
              4-minute read
            </span>
          </div>
          
          
          <div class="tags">
  <i class="fa fa-tag" aria-hidden="true"></i>
    <span class="tag">
      <a href="/tags/linux/">linux</a>
    </span></div>

        </div>
      </header>

      <div class="post-content">
        
        <h1 id="keyring">
  Keyring
  <a class="heading-link" href="#keyring">
    <i class="fa fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h1>
<p>keyring a safe way to work with sensitive data in memory. From <a href="https://www.kernel.org/doc/html/v6.0/security/keys/core.html"  class="external-link" target="_blank" rel="noopener">link</a>, It&rsquo;s described as follows:</p>
<blockquote>
<p>This service allows cryptographic keys, authentication tokens, cross-domain user mappings, and similar to be cached in the kernel for the use of filesystems and other kernel services.</p>
<p>In this context, keys represent units of cryptographic data, authentication tokens, keyrings, etc.. These are represented in the kernel by struct key.</p>
</blockquote>
<p>keyring has user land interface using system calls but this document will focus on kernel APIs. The following snippet shows a small example to use keep x509 cert.</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">	<span style="color:#fff;font-weight:bold">struct</span> key *keyring;
	<span style="color:#fff;font-weight:bold">char</span> keyring_name[<span style="color:#ff0;font-weight:bold">17</span>];
	<span style="color:#fff;font-weight:bold">char</span> root_serial[<span style="color:#ff0;font-weight:bold">26</span>];
	key_ref_t key_ref;
	size_t offset = <span style="color:#ff0;font-weight:bold">0</span>;
	<span style="color:#fff;font-weight:bold">int</span> rc, length;

	snprintf(keyring_name, <span style="color:#fff;font-weight:bold">sizeof</span>(keyring_name), <span style="color:#0ff;font-weight:bold">&#34;.%d&#34;</span>,
		 current-&gt;pid);

	keyring = keyring_alloc(keyring_name, KUIDT_INIT(<span style="color:#ff0;font-weight:bold">0</span>), KGIDT_INIT(<span style="color:#ff0;font-weight:bold">0</span>),
				current_cred(), KEY_POS_ALL,
				KEY_ALLOC_NOT_IN_QUOTA | KEY_ALLOC_SET_KEEP,
				<span style="color:#fff;font-weight:bold">NULL</span>, <span style="color:#fff;font-weight:bold">NULL</span>);

	...

	<span style="color:#fff;font-weight:bold">while</span> (offset &lt; total_length) {
		rc = x509_get_certificate_length(certs + offset,
						 total_length - offset);

		length = rc;
		key_ref = key_create_or_update(make_key_ref(keyring, <span style="color:#fff;font-weight:bold">true</span>),
					       <span style="color:#0ff;font-weight:bold">&#34;asymmetric&#34;</span>, <span style="color:#fff;font-weight:bold">NULL</span>,
					       certs + offset, length,
					       (KEY_POS_ALL &amp; ~KEY_POS_SETATTR),
					       KEY_ALLOC_NOT_IN_QUOTA);
        ...

		key_put(keyring-&gt;restrict_link-&gt;key);
		keyring-&gt;restrict_link-&gt;key = key_ref_to_ptr(key_ref);

		offset += length;
	}

	leaf_key = key_get(keyring-&gt;restrict_link-&gt;key);
</code></pre></div><p>Starting with <code>keyring_alloc</code> to create keyring</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#fff;font-weight:bold">struct</span> key *keyring_alloc(<span style="color:#fff;font-weight:bold">const</span> <span style="color:#fff;font-weight:bold">char</span> *description, uid_t uid, gid_t gid,
                          <span style="color:#fff;font-weight:bold">const</span> <span style="color:#fff;font-weight:bold">struct</span> cred *cred,
                          key_perm_t perm,
                          <span style="color:#fff;font-weight:bold">struct</span> key_restriction *restrict_link,
                          <span style="color:#fff;font-weight:bold">unsigned</span> <span style="color:#fff;font-weight:bold">long</span> flags,
                          <span style="color:#fff;font-weight:bold">struct</span> key *dest);
</code></pre></div><p><code>key_create_or_update</code> create key reference and link to keyring created above.</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#fff;font-weight:bold">extern</span> key_ref_t key_create_or_update(key_ref_t keyring,
				      <span style="color:#fff;font-weight:bold">const</span> <span style="color:#fff;font-weight:bold">char</span> *type,
				      <span style="color:#fff;font-weight:bold">const</span> <span style="color:#fff;font-weight:bold">char</span> *description,
				      <span style="color:#fff;font-weight:bold">const</span> <span style="color:#fff;font-weight:bold">void</span> *payload,
				      size_t plen,
				      key_perm_t perm,
				      <span style="color:#fff;font-weight:bold">unsigned</span> <span style="color:#fff;font-weight:bold">long</span> flags);

<span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">inline</span> key_ref_t make_key_ref(<span style="color:#fff;font-weight:bold">const</span> <span style="color:#fff;font-weight:bold">struct</span> key *key,
				     <span style="color:#fff;font-weight:bold">bool</span> possession)
{
	<span style="color:#fff;font-weight:bold">return</span> (key_ref_t) ((<span style="color:#fff;font-weight:bold">unsigned</span> <span style="color:#fff;font-weight:bold">long</span>) key | possession);
}
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">inline</span> <span style="color:#fff;font-weight:bold">struct</span> key *key_ref_to_ptr(<span style="color:#fff;font-weight:bold">const</span> key_ref_t key_ref)
{
	<span style="color:#fff;font-weight:bold">return</span> (<span style="color:#fff;font-weight:bold">struct</span> key *) ((<span style="color:#fff;font-weight:bold">unsigned</span> <span style="color:#fff;font-weight:bold">long</span>) key_ref &amp; ~<span style="color:#ff0;font-weight:bold">1UL</span>);
}
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#fff;font-weight:bold">struct</span> key_restriction {
	key_restrict_link_func_t check;
	<span style="color:#fff;font-weight:bold">struct</span> key *key;
	<span style="color:#fff;font-weight:bold">struct</span> key_type *keytype;
};
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#fff;font-weight:bold">struct</span> key {
	refcount_t		usage;		
	
	...
	
	<span style="color:#fff;font-weight:bold">union</span> {
		<span style="color:#fff;font-weight:bold">struct</span> keyring_index_key index_key;
		<span style="color:#fff;font-weight:bold">struct</span> {
			<span style="color:#fff;font-weight:bold">unsigned</span> <span style="color:#fff;font-weight:bold">long</span>	hash;
			<span style="color:#fff;font-weight:bold">unsigned</span> <span style="color:#fff;font-weight:bold">long</span>	len_desc;
			<span style="color:#fff;font-weight:bold">struct</span> key_type	*type;		<span style="color:#007f7f">/* type of key */</span>
			<span style="color:#fff;font-weight:bold">struct</span> key_tag	*domain_tag;	<span style="color:#007f7f">/* Domain of operation */</span>
			<span style="color:#fff;font-weight:bold">char</span>		*description;
		};
	};

	<span style="color:#fff;font-weight:bold">union</span> {
		<span style="color:#fff;font-weight:bold">union</span> key_payload payload;
		<span style="color:#fff;font-weight:bold">struct</span> {
			<span style="color:#007f7f">/* Keyring bits */</span>
			<span style="color:#fff;font-weight:bold">struct</span> list_head name_link;
			<span style="color:#fff;font-weight:bold">struct</span> assoc_array keys;
		};
	};

	<span style="color:#fff;font-weight:bold">struct</span> key_restriction *restrict_link;
};
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#fff;font-weight:bold">typedef</span> <span style="color:#fff;font-weight:bold">struct</span> __key_reference_with_attributes *key_ref_t;
</code></pre></div><h1 id="hashing">
  Hashing
  <a class="heading-link" href="#hashing">
    <i class="fa fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h1>
<p>The linux kernel have hash utility that supports multiple alogs. There are 3 API to init, update and calculate.</p>
<ul>
<li>crypto_shash_init</li>
<li>crypto_shash_update</li>
<li>crypto_shash_final</li>
</ul>
<p>There is also <code>crypto_shash_digest</code> which is defines as</p>
<blockquote>
<p>This function is a “short-hand” for the function calls of crypto_shash_init, crypto_shash_update and crypto_shash_final. The parameters have the same meaning as discussed for those separate three functions.</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#fff;font-weight:bold">int</span> 	(<span style="color:#fff;font-weight:bold">struct</span> shash_desc * desc, <span style="color:#fff;font-weight:bold">const</span> u8 * data, <span style="color:#fff;font-weight:bold">unsigned</span> <span style="color:#fff;font-weight:bold">int</span> len)
</code></pre></div><blockquote>
<p>Updates the message digest state of the operational state handle.</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#fff;font-weight:bold">int</span> crypto_shash_final(<span style="color:#fff;font-weight:bold">struct</span> shash_desc * desc, u8 * out)
</code></pre></div><blockquote>
<p>Finalize the message digest operation and create the message digest based on all data added to the cipher handle. The message digest is placed into the output buffer. The caller must ensure that the output buffer is large enough by using crypto_shash_digestsize.</p>
</blockquote>
<p>This is an example from SPDM digest calculation</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">	<span style="color:#fff;font-weight:bold">struct</span> crypto_shash *shash;
	<span style="color:#fff;font-weight:bold">struct</span> shash_desc *desc;
	size_t h;

	alg_name = <span style="color:#0ff;font-weight:bold">&#34;sha384&#34;</span>;

	shash = crypto_alloc_shash(alg_name, <span style="color:#ff0;font-weight:bold">0</span>, <span style="color:#ff0;font-weight:bold">0</span>);

	desc = kzalloc(<span style="color:#fff;font-weight:bold">sizeof</span>(*desc) +
				   crypto_shash_descsize(shash),
				   GFP_KERNEL);

	desc-&gt;tfm = shash;

	h = crypto_shash_digestsize(shash);

	rc = crypto_shash_init(desc);

	rc = crypto_shash_update(desc, (u8 *)req, req_sz);

	crypto_shash_final(desc, digest);
	<span style="color:#fff;font-weight:bold">if</span> (version &gt;= <span style="color:#ff0;font-weight:bold">0x12</span>) {
		message = kmalloc(h + <span style="color:#fff;font-weight:bold">sizeof</span>(spdm_prefix), GFP_KERNEL);
		memcpy(message, spdm_prefix, <span style="color:#fff;font-weight:bold">sizeof</span>(spdm_prefix));
		memcpy(message + <span style="color:#fff;font-weight:bold">sizeof</span>(spdm_prefix), digest, h);
		<span style="color:#007f7f">/*
</span><span style="color:#007f7f">		 * Not all 1.2 supported Asymmetric functions need this hashed
</span><span style="color:#007f7f">		 * but all the ones supported here do.
</span><span style="color:#007f7f">		 */</span>
		rc = crypto_shash_digest(desc, message,
					 h + <span style="color:#fff;font-weight:bold">sizeof</span>(spdm_prefix), digest);
		...
</code></pre></div><h1 id="public-key-verification">
  Public key verification
  <a class="heading-link" href="#public-key-verification">
    <i class="fa fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h1>
<p><code>verify_signature</code> takes 2 arguments to verify</p>
<ul>
<li>The signature</li>
<li><code>public_key_signature</code> structure</li>
</ul>
<p><code>public_key_signature</code> contains the information needed which are hash algorithm and signing algorithm.</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#fff;font-weight:bold">struct</span> public_key_signature {
	<span style="color:#fff;font-weight:bold">struct</span> asymmetric_key_id *auth_ids[<span style="color:#ff0;font-weight:bold">3</span>];
	u8 *s;			<span style="color:#007f7f">/* Signature */</span>
	u8 *digest;
	u32 s_size;		<span style="color:#007f7f">/* Number of bytes in signature */</span>
	u32 digest_size;	<span style="color:#007f7f">/* Number of bytes in digest */</span>
	<span style="color:#fff;font-weight:bold">const</span> <span style="color:#fff;font-weight:bold">char</span> *pkey_algo;
	<span style="color:#fff;font-weight:bold">const</span> <span style="color:#fff;font-weight:bold">char</span> *hash_algo;
	<span style="color:#fff;font-weight:bold">const</span> <span style="color:#fff;font-weight:bold">char</span> *encoding;
	<span style="color:#fff;font-weight:bold">const</span> <span style="color:#fff;font-weight:bold">void</span> *data;
	<span style="color:#fff;font-weight:bold">unsigned</span> <span style="color:#fff;font-weight:bold">int</span> data_size;
};
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#fff;font-weight:bold">extern</span> <span style="color:#fff;font-weight:bold">int</span> verify_signature(<span style="color:#fff;font-weight:bold">const</span> <span style="color:#fff;font-weight:bold">struct</span> key *,
			    <span style="color:#fff;font-weight:bold">const</span> <span style="color:#fff;font-weight:bold">struct</span> public_key_signature *);
</code></pre></div><p>This is an example from SPDM verification using <code>pcks1</code> and <code>sha384</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">	<span style="color:#fff;font-weight:bold">const</span> <span style="color:#fff;font-weight:bold">struct</span> asymmetric_key_ids *ids;
	<span style="color:#fff;font-weight:bold">struct</span> public_key_signature sig = {};
	<span style="color:#fff;font-weight:bold">unsigned</span> <span style="color:#fff;font-weight:bold">char</span> buffer2[<span style="color:#ff0;font-weight:bold">128</span>] = {};

	sig.s = sig_ptr;
	sig.s_size = s;
	sig.encoding = <span style="color:#0ff;font-weight:bold">&#34;pkcs1&#34;</span>;

	sig.digest = digest;
	sig.digest_size = digest_size;
	ids = asymmetric_key_ids(leaf_key);
	sig.auth_ids[<span style="color:#ff0;font-weight:bold">0</span>] = ids-&gt;id[<span style="color:#ff0;font-weight:bold">0</span>];
	sig.auth_ids[<span style="color:#ff0;font-weight:bold">1</span>] = ids-&gt;id[<span style="color:#ff0;font-weight:bold">1</span>];

	sig.hash_algo = <span style="color:#0ff;font-weight:bold">&#34;sha384&#34;</span>;

	rc = verify_signature(leaf_key, &amp;sig);
</code></pre></div>
      </div>


      <footer>
        


        
        
        
        
      </footer>
    </article>

    
  </section>

    </div>

    <footer class="footer">
  <section class="container">
    ©
    
    2023
    
    ·
    
    Powered by <a href="https://gohugo.io/">Hugo</a> & <a href="https://github.com/luizdepra/hugo-coder/">Coder</a>.
    
  </section>
</footer>

  </main>

  

  
  
  <script src="/js/coder.min.369d90111ae4409b4e51de5efd23a46b92663fcc82dc9a0efde7f70bffc3f949.js" integrity="sha256-Np2QERrkQJtOUd5e/SOka5JmP8yC3JoO/ef3C//D&#43;Uk="></script>
  

  

  


  

  

  

  

  

  

  

  

  

  

  

  
</body>

</html>