<!DOCTYPE html>
<html lang="en">

<head>
  <title>
  WireGuard and Linux kernel · Techiedeepdive
</title>
  <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="color-scheme" content="light dark">




<meta name="description" content="This post is hello world into vpn technologies (which i am not an expert in), technologies like openVPN and WireGuard and other good stuff.
Back story  Link to heading   Over the years, I mentained my own openVPN server on VPS machine and that setup was working for me. There were several advantages, well, it was cheap (actually free!) considering I was hosting my blog on that machine. But now that i am too old for sh!">
<meta name="keywords" content="">

<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content=""/>

<meta name="twitter:title" content="WireGuard and Linux kernel"/>
<meta name="twitter:description" content="This post is hello world into vpn technologies (which i am not an expert in), technologies like openVPN and WireGuard and other good stuff.
Back story  Link to heading   Over the years, I mentained my own openVPN server on VPS machine and that setup was working for me. There were several advantages, well, it was cheap (actually free!) considering I was hosting my blog on that machine. But now that i am too old for sh!"/>

<meta property="og:title" content="WireGuard and Linux kernel" />
<meta property="og:description" content="This post is hello world into vpn technologies (which i am not an expert in), technologies like openVPN and WireGuard and other good stuff.
Back story  Link to heading   Over the years, I mentained my own openVPN server on VPS machine and that setup was working for me. There were several advantages, well, it was cheap (actually free!) considering I was hosting my blog on that machine. But now that i am too old for sh!" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/2023/01/wireguard-and-linux-kernel/" /><meta property="og:image" content=""/><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-01-20T00:00:00+00:00" />
<meta property="article:modified_time" content="2023-01-20T00:00:00+00:00" /><meta property="og:site_name" content="Techiedeepdive" />





<link rel="canonical" href="/posts/2023/01/wireguard-and-linux-kernel/">


<link rel="preload" href="/fonts/fa-brands-400.woff2" as="font" type="font/woff2" crossorigin>
<link rel="preload" href="/fonts/fa-regular-400.woff2" as="font" type="font/woff2" crossorigin>
<link rel="preload" href="/fonts/fa-solid-900.woff2" as="font" type="font/woff2" crossorigin>


  
  
  <link rel="stylesheet" href="/css/coder.min.577e3c5ead537873430da16f0964b754a120fd87c4e2203a00686e7c75b51378.css" integrity="sha256-V348Xq1TeHNDDaFvCWS3VKEg/YfE4iA6AGhufHW1E3g=" crossorigin="anonymous" media="screen" />






  
    
    
    <link rel="stylesheet" href="/css/coder-dark.min.a00e6364bacbc8266ad1cc81230774a1397198f8cfb7bcba29b7d6fcb54ce57f.css" integrity="sha256-oA5jZLrLyCZq0cyBIwd0oTlxmPjPt7y6KbfW/LVM5X8=" crossorigin="anonymous" media="screen" />
  



 




<link rel="icon" type="image/svg+xml" href="/images/favicon.svg" sizes="any">
<link rel="icon" type="image/png" href="/images/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/images/favicon-16x16.png" sizes="16x16">

<link rel="apple-touch-icon" href="/images/apple-touch-icon.png">
<link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">

<link rel="manifest" href="/site.webmanifest">
<link rel="mask-icon" href="/images/safari-pinned-tab.svg" color="#5bbad5">









</head>






<body class="preload-transitions colorscheme-auto">
  
<div class="float-container">
    <a id="dark-mode-toggle" class="colorscheme-toggle">
        <i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i>
    </a>
</div>


  <main class="wrapper">
    <nav class="navigation">
  <section class="container">
    
    <a class="navigation-title" href="">
      Techiedeepdive
    </a>
    
    
      <input type="checkbox" id="menu-toggle" />
      <label class="menu-button float-right" for="menu-toggle">
        <i class="fa-solid fa-bars fa-fw" aria-hidden="true"></i>
      </label>
      <ul class="navigation-list">
        
          
            <li class="navigation-item">
              <a class="navigation-link " href="/posts">Blog</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link " href="/reading-list/">Reading list</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link " href="/tags/">Tags</a>
            </li>
          
        
        
      </ul>
    
  </section>
</nav>


    <div class="content">
      
  <section class="container post">
    <article>
      <header>
        <div class="post-title">
          <h1 class="title">
            <a class="title-link" href="/posts/2023/01/wireguard-and-linux-kernel/">
              WireGuard and Linux kernel
            </a>
          </h1>
        </div>
        <div class="post-meta">
          <div class="date">
            <span class="posted-on">
              <i class="fa-solid fa-calendar" aria-hidden="true"></i>
              <time datetime="2023-01-20T00:00:00Z">
                January 20, 2023
              </time>
            </span>
            <span class="reading-time">
              <i class="fa-solid fa-clock" aria-hidden="true"></i>
              4-minute read
            </span>
          </div>
          
          
          <div class="tags">
  <i class="fa-solid fa-tag" aria-hidden="true"></i>
    <span class="tag">
      <a href="/tags/ipsec/">ipsec</a>
    </span>
      <span class="separator">•</span>
    <span class="tag">
      <a href="/tags/linux/">linux</a>
    </span></div>

        </div>
      </header>

      <div class="post-content">
        
        <p>This post is hello world into vpn technologies (which i am not an expert in), technologies like openVPN and WireGuard and other good stuff.</p>
<h1 id="back-story">
  Back story
  <a class="heading-link" href="#back-story">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h1>
<p>Over the years, I mentained my own openVPN server on VPS machine and that setup was working for me. There were several advantages, well, it was cheap (actually free!) considering I was hosting my blog on that machine. But now that i am too old for sh!t and gave up that machine, and After soe research, I got myself Nordvpn. So naturally, I wanted to check if they use openVPN or WireGuard. Let&rsquo;s see.</p>
<h1 id="wireguard">
  WireGuard
  <a class="heading-link" href="#wireguard">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h1>
<p>A quick look at <code>ippadd</code> output show it&rsquo;s a tun network device called <code>nordlynx</code> which is an interesting name.</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">6: nordlynx: &lt;POINTOPOINT,UP,LOWER_UP&gt; mtu <span style="color:#ff0;font-weight:bold">1420</span> qdisc noqueue state UNKNOWN group default qlen <span style="color:#ff0;font-weight:bold">1000</span>
</code></pre></div><p>Anyway, nordvpn supports says the following, I guess it WireGuard after all.</p>
<blockquote>
<p>NordLynx is NordVPN’s revolutionary technology built around the WireGuard® VPN protocol. It helps you connect to NordVPN servers faster and improves your VPN connection speeds without compromising security or privacy.</p>
</blockquote>
<p>from WireGuard website:</p>
<blockquote>
<p>WireGuard® is an extremely simple yet fast and modern VPN that utilizes state-of-the-art cryptography. It aims to be faster, simpler, leaner, and more useful than IPsec, while avoiding the massive headache.</p>
</blockquote>
<p>IPSEC as defined in <a href="https://www.ietf.org/rfc/rfc4301.txt"  class="external-link" target="_blank" rel="noopener">RFC4301</a> has been part of the kernel for long time but over the years, people complained about how bad it was. That&rsquo;s why things like openVPN projects started. At some point, they came up with WireGuard which started as off-tree kernel module and eventually got up-streamed into linux kernel.</p>
<p>The protocol sounds simple enough</p>
<p><img src="/wg.png" alt="Example image"></p>
<h1 id="wireguard-tools">
  WireGuard Tools
  <a class="heading-link" href="#wireguard-tools">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h1>
<p>The low level WireGuard configuration can be done through <code>wg</code>. The subcommands for <code>wg</code> are interesting as it can be used to configure the interface parameters.</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">Available subcommands:
  show: Shows the current configuration and device information
  showconf: Shows the current configuration of a given WireGuard interface, <span style="color:#fff;font-weight:bold">for</span> use with <span style="color:#0ff;font-weight:bold">`</span>setconf<span style="color:#f00">&#39;</span>
  set: Change the current configuration, add peers, remove peers, or change peers
  setconf: Applies a configuration file to a WireGuard interface
  addconf: Appends a configuration file to a WireGuard interface
  syncconf: Synchronizes a configuration file to a WireGuard interface
  genkey: Generates a new private key and writes it to stdout
  genpsk: Generates a new preshared key and writes it to stdout
  pubkey: Reads a private key from stdin and writes a public key to stdout
</code></pre></div><p>I tried <code>wg</code> while i am connected, and i can see that Nordvpn already create the wireguard interface for us with the right parameters. For example, We can see the public and private(hidden though) keys. There is also endpoint(remote IP address for VPN server).</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ sudo wg show
interface: nordlynx
  public key: ........
  private key: (hidden)
  listening port: ....
  fwmark: ....

peer: .... 
  endpoint: .....
  allowed ips: .....
</code></pre></div><h1 id="linux-kernel">
  Linux kernel
  <a class="heading-link" href="#linux-kernel">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h1>
<p>As I mentioned, wireguard is part of the linux mainstream. So, Starting with module entry point where <code> wg_genetlink_init</code></p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">
<span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">int</span> __init wg_mod_init(<span style="color:#fff;font-weight:bold">void</span>)
{
	<span style="color:#fff;font-weight:bold">int</span> ret;

	wg_noise_init();

	ret = wg_peer_init();
	<span style="color:#fff;font-weight:bold">if</span> (ret &lt; <span style="color:#ff0;font-weight:bold">0</span>)
		<span style="color:#fff;font-weight:bold">goto</span> err_peer;

	ret = wg_device_init();
	<span style="color:#fff;font-weight:bold">if</span> (ret &lt; <span style="color:#ff0;font-weight:bold">0</span>)
		<span style="color:#fff;font-weight:bold">goto</span> err_device;

	ret = wg_genetlink_init();
	<span style="color:#fff;font-weight:bold">if</span> (ret &lt; <span style="color:#ff0;font-weight:bold">0</span>)
		<span style="color:#fff;font-weight:bold">goto</span> err_netlink;

	pr_info(<span style="color:#0ff;font-weight:bold">&#34;WireGuard &#34;</span> WIREGUARD_VERSION <span style="color:#0ff;font-weight:bold">&#34; loaded. See www.wireguard.com for information.</span><span style="color:#0ff;font-weight:bold">\n</span><span style="color:#0ff;font-weight:bold">&#34;</span>);
	pr_info(<span style="color:#0ff;font-weight:bold">&#34;Copyright (C) 2015-2019 Jason A. Donenfeld &lt;Jason@zx2c4.com&gt;. All Rights Reserved.</span><span style="color:#0ff;font-weight:bold">\n</span><span style="color:#0ff;font-weight:bold">&#34;</span>);
</code></pre></div><p><code> wg_gentlink_init</code> is important because it registers the netlink interface with <code>genl_family</code>. <code>genl_family</code> is part of linux netlink interface.</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">const</span> <span style="color:#fff;font-weight:bold">struct</span> genl_ops genl_ops[] = {
	{
		.cmd = WG_CMD_GET_DEVICE,
		.start = wg_get_device_start,
		.dumpit = wg_get_device_dump,
		.done = wg_get_device_done,
		.flags = GENL_UNS_ADMIN_PERM
	}, {
		.cmd = WG_CMD_SET_DEVICE,
		.doit = wg_set_device,
		.flags = GENL_UNS_ADMIN_PERM
	}
};

<span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">struct</span> genl_family genl_family __ro_after_init = {
	.ops = genl_ops,
	.n_ops = ARRAY_SIZE(genl_ops),
	.resv_start_op = WG_CMD_SET_DEVICE + <span style="color:#ff0;font-weight:bold">1</span>,
	.name = WG_GENL_NAME,
	.version = WG_GENL_VERSION,
	.maxattr = WGDEVICE_A_MAX,
	.module = THIS_MODULE,
	.policy = device_policy,
	.netnsok = <span style="color:#fff;font-weight:bold">true</span>
};

<span style="color:#fff;font-weight:bold">int</span> __init wg_genetlink_init(<span style="color:#fff;font-weight:bold">void</span>)
{
	<span style="color:#fff;font-weight:bold">return</span> genl_register_family(&amp;genl_family);
}

</code></pre></div><p>Let&rsquo;s look at <code>wg_get_device_start</code> which calls <code>lookup_interface</code></p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">int</span> wg_get_device_start(<span style="color:#fff;font-weight:bold">struct</span> netlink_callback *cb)
{
	<span style="color:#fff;font-weight:bold">struct</span> wg_device *wg;

	wg = lookup_interface(genl_dumpit_info(cb)-&gt;attrs, cb-&gt;skb);
	<span style="color:#fff;font-weight:bold">if</span> (IS_ERR(wg))
		<span style="color:#fff;font-weight:bold">return</span> PTR_ERR(wg);
	DUMP_CTX(cb)-&gt;wg = wg;
	<span style="color:#fff;font-weight:bold">return</span> <span style="color:#ff0;font-weight:bold">0</span>;
}
</code></pre></div><p><code>loop_interface</code> search and finds the device and returns the <code>priv</code> structure out of <code>dev</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">struct</span> wg_device *lookup_interface(<span style="color:#fff;font-weight:bold">struct</span> nlattr **attrs,
					  <span style="color:#fff;font-weight:bold">struct</span> sk_buff *skb)
{
	<span style="color:#fff;font-weight:bold">struct</span> net_device *dev = <span style="color:#fff;font-weight:bold">NULL</span>;

	<span style="color:#fff;font-weight:bold">if</span> (!attrs[WGDEVICE_A_IFINDEX] == !attrs[WGDEVICE_A_IFNAME])
		<span style="color:#fff;font-weight:bold">return</span> ERR_PTR(-EBADR);
	<span style="color:#fff;font-weight:bold">if</span> (attrs[WGDEVICE_A_IFINDEX])
		dev = dev_get_by_index(sock_net(skb-&gt;sk),
				       nla_get_u32(attrs[WGDEVICE_A_IFINDEX]));
	<span style="color:#fff;font-weight:bold">else</span> <span style="color:#fff;font-weight:bold">if</span> (attrs[WGDEVICE_A_IFNAME])
		dev = dev_get_by_name(sock_net(skb-&gt;sk),
				      nla_data(attrs[WGDEVICE_A_IFNAME]));
	<span style="color:#fff;font-weight:bold">if</span> (!dev)
		<span style="color:#fff;font-weight:bold">return</span> ERR_PTR(-ENODEV);
	<span style="color:#fff;font-weight:bold">if</span> (!dev-&gt;rtnl_link_ops || !dev-&gt;rtnl_link_ops-&gt;kind ||
	    strcmp(dev-&gt;rtnl_link_ops-&gt;kind, KBUILD_MODNAME)) {
		dev_put(dev);
		<span style="color:#fff;font-weight:bold">return</span> ERR_PTR(-EOPNOTSUPP);
	}
	<span style="color:#fff;font-weight:bold">return</span> netdev_priv(dev);
}
</code></pre></div>
      </div>


      <footer>
        


        
        
        
        
        

        
      </footer>
    </article>

    
  </section>

    </div>

    <footer class="footer">
  <section class="container">
    ©
    
    2024
    
    ·
    
      Licensed under <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">CC BY-SA-4.0</a>
    ·
    
    Powered by <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> & <a href="https://github.com/luizdepra/hugo-coder/" target="_blank" rel="noopener">Coder</a>.
    
  </section>
</footer>

  </main>

  

  
  
  <script src="/js/coder.min.369d90111ae4409b4e51de5efd23a46b92663fcc82dc9a0efde7f70bffc3f949.js" integrity="sha256-Np2QERrkQJtOUd5e/SOka5JmP8yC3JoO/ef3C//D&#43;Uk="></script>
  

  

  


  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  
</body>

</html>
