<!DOCTYPE html>
<html lang="en">

<head>
  <title>
  LLM - smolagents - Deep dive into the smolest agent Â· Techiedeepdive
</title>
  <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="color-scheme" content="light dark">




<meta name="description" content="smolagents is an interesting agent-based library by Huggingface. I like how simple and small it is. So, this is a deep dive into how smolagent works.

  Hello world - Ollama
  
    
    Link to heading
  

Starting with Ollama, This is a small example using Ollama and LiteLLM.
pip install smolagents[litellm]
from smolagents import CodeAgent, LiteLLMModel

model = LiteLLMModel(
    model_id=&#34;ollama_chat/llama3.2&#34;,
    api_base=&#34;http://localhost:11434&#34;,
    api_key=&#34;YOUR_API_KEY&#34;,
    num_ctx=8192
)

agent = CodeAgent(tools=[], model=model, add_base_tools=True)

agent.run(
    &#34;Could you give me the 118th number in the Fibonacci sequence?&#34;,
)

  Hello world - OpenAI
  
    
    Link to heading
  

Next, the smallest example using OpenAI API.">
<meta name="keywords" content="homepage, blog">



  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:image" content="/">
  <meta name="twitter:title" content="LLM - smolagents - Deep dive into the smolest agent">
  <meta name="twitter:description" content="smolagents is an interesting agent-based library by Huggingface. I like how simple and small it is. So, this is a deep dive into how smolagent works.
Hello world - Ollama Link to heading Starting with Ollama, This is a small example using Ollama and LiteLLM.
pip install smolagents[litellm] from smolagents import CodeAgent, LiteLLMModel model = LiteLLMModel( model_id=&#34;ollama_chat/llama3.2&#34;, api_base=&#34;http://localhost:11434&#34;, api_key=&#34;YOUR_API_KEY&#34;, num_ctx=8192 ) agent = CodeAgent(tools=[], model=model, add_base_tools=True) agent.run( &#34;Could you give me the 118th number in the Fibonacci sequence?&#34;, ) Hello world - OpenAI Link to heading Next, the smallest example using OpenAI API.">

<meta property="og:url" content="/posts/2025/06/llm-smolagents-deep-dive-into-the-smolest-agent/">
  <meta property="og:site_name" content="Techiedeepdive">
  <meta property="og:title" content="LLM - smolagents - Deep dive into the smolest agent">
  <meta property="og:description" content="smolagents is an interesting agent-based library by Huggingface. I like how simple and small it is. So, this is a deep dive into how smolagent works.
Hello world - Ollama Link to heading Starting with Ollama, This is a small example using Ollama and LiteLLM.
pip install smolagents[litellm] from smolagents import CodeAgent, LiteLLMModel model = LiteLLMModel( model_id=&#34;ollama_chat/llama3.2&#34;, api_base=&#34;http://localhost:11434&#34;, api_key=&#34;YOUR_API_KEY&#34;, num_ctx=8192 ) agent = CodeAgent(tools=[], model=model, add_base_tools=True) agent.run( &#34;Could you give me the 118th number in the Fibonacci sequence?&#34;, ) Hello world - OpenAI Link to heading Next, the smallest example using OpenAI API.">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2025-06-06T00:00:00+00:00">
    <meta property="article:modified_time" content="2025-06-06T00:00:00+00:00">
    <meta property="article:tag" content="Llm">
    <meta property="og:image" content="/">




<link rel="canonical" href="/posts/2025/06/llm-smolagents-deep-dive-into-the-smolest-agent/">


<link rel="preload" href="/fonts/fa-brands-400.woff2" as="font" type="font/woff2" crossorigin>
<link rel="preload" href="/fonts/fa-regular-400.woff2" as="font" type="font/woff2" crossorigin>
<link rel="preload" href="/fonts/fa-solid-900.woff2" as="font" type="font/woff2" crossorigin>


  
  
  <link rel="stylesheet" href="/css/coder.min.aa5ef26fa979d6793724ae2dbd71efa94fd16cb1c5c7db3b6651f21f9892a5fd.css" integrity="sha256-ql7yb6l51nk3JK4tvXHvqU/RbLHFx9s7ZlHyH5iSpf0=" crossorigin="anonymous" media="screen" />






  
    
    
    <link rel="stylesheet" href="/css/coder-dark.min.a00e6364bacbc8266ad1cc81230774a1397198f8cfb7bcba29b7d6fcb54ce57f.css" integrity="sha256-oA5jZLrLyCZq0cyBIwd0oTlxmPjPt7y6KbfW/LVM5X8=" crossorigin="anonymous" media="screen" />
  



 




<link rel="icon" type="image/svg+xml" href="/images/favicon.svg" sizes="any">
<link rel="icon" type="image/png" href="/images/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/images/favicon-16x16.png" sizes="16x16">

<link rel="apple-touch-icon" href="/images/apple-touch-icon.png">
<link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">

<link rel="manifest" href="/site.webmanifest">
<link rel="mask-icon" href="/images/safari-pinned-tab.svg" color="#5bbad5">









</head>






<body class="preload-transitions colorscheme-auto">
  
<div class="float-container">
    <a id="dark-mode-toggle" class="colorscheme-toggle">
        <i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i>
    </a>
</div>


  <main class="wrapper">
    <nav class="navigation">
  <section class="container">
    
    <a class="navigation-title" href="/">
      Techiedeepdive
    </a>
    
    
      <input type="checkbox" id="menu-toggle" />
      <label class="menu-button float-right" for="menu-toggle">
        <i class="fa-solid fa-bars fa-fw" aria-hidden="true"></i>
      </label>
      <ul class="navigation-list">
        
          
            <li class="navigation-item">
              <a class="navigation-link " href="/posts">Blog</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link " href="/reading-list/">Reading list</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link " href="/tags/">Tags</a>
            </li>
          
        
        
      </ul>
    
  </section>
</nav>


    <div class="content">
      
  <section class="container post">
    <article>
      <header>
        <div class="post-title">
          <h1 class="title">
            <a class="title-link" href="/posts/2025/06/llm-smolagents-deep-dive-into-the-smolest-agent/">
              LLM - smolagents - Deep dive into the smolest agent
            </a>
          </h1>
        </div>
        <div class="post-meta">
          <div class="date">
            <span class="posted-on">
              <i class="fa-solid fa-calendar" aria-hidden="true"></i>
              <time datetime="2025-06-06T00:00:00Z">
                June 6, 2025
              </time>
            </span>
            <span class="reading-time">
              <i class="fa-solid fa-clock" aria-hidden="true"></i>
              13-minute read
            </span>
          </div>
          
          
          <div class="tags">
  <i class="fa-solid fa-tag" aria-hidden="true"></i>
    <span class="tag">
      <a href="/tags/llm/">Llm</a>
    </span></div>

        </div>
      </header>

      <div class="post-content">
        
        <p><code>smolagents</code> is an interesting agent-based library by Huggingface. I like how simple and small it is. So, this is a deep dive into how smolagent works.</p>
<h1 id="hello-world---ollama">
  Hello world - Ollama
  <a class="heading-link" href="#hello-world---ollama">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h1>
<p>Starting with Ollama, This is a small example using Ollama and LiteLLM.</p>
<div class="highlight"><pre tabindex="0" style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>pip install smolagents<span style="color:#ff7b72;font-weight:bold">[</span>litellm<span style="color:#ff7b72;font-weight:bold">]</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#ff7b72">from</span> <span style="color:#ff7b72">smolagents</span> <span style="color:#ff7b72">import</span> CodeAgent, LiteLLMModel
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>model <span style="color:#ff7b72;font-weight:bold">=</span> LiteLLMModel(
</span></span><span style="display:flex;"><span>    model_id<span style="color:#ff7b72;font-weight:bold">=</span><span style="color:#a5d6ff">&#34;ollama_chat/llama3.2&#34;</span>,
</span></span><span style="display:flex;"><span>    api_base<span style="color:#ff7b72;font-weight:bold">=</span><span style="color:#a5d6ff">&#34;http://localhost:11434&#34;</span>,
</span></span><span style="display:flex;"><span>    api_key<span style="color:#ff7b72;font-weight:bold">=</span><span style="color:#a5d6ff">&#34;YOUR_API_KEY&#34;</span>,
</span></span><span style="display:flex;"><span>    num_ctx<span style="color:#ff7b72;font-weight:bold">=</span><span style="color:#a5d6ff">8192</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>agent <span style="color:#ff7b72;font-weight:bold">=</span> CodeAgent(tools<span style="color:#ff7b72;font-weight:bold">=</span>[], model<span style="color:#ff7b72;font-weight:bold">=</span>model, add_base_tools<span style="color:#ff7b72;font-weight:bold">=</span><span style="color:#79c0ff">True</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>agent<span style="color:#ff7b72;font-weight:bold">.</span>run(
</span></span><span style="display:flex;"><span>    <span style="color:#a5d6ff">&#34;Could you give me the 118th number in the Fibonacci sequence?&#34;</span>,
</span></span><span style="display:flex;"><span>)
</span></span></code></pre></div><h1 id="hello-world---openai">
  Hello world - OpenAI
  <a class="heading-link" href="#hello-world---openai">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h1>
<p>Next, the smallest example using OpenAI API.</p>
<div class="highlight"><pre tabindex="0" style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#ff7b72">import</span> <span style="color:#ff7b72">os</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff7b72">from</span> <span style="color:#ff7b72">smolagents</span> <span style="color:#ff7b72">import</span> CodeAgent, OpenAIServerModel, ToolCallingAgent, DuckDuckGoSearchTool
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>api_base <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#a5d6ff">&#34;https://api.openai.com/v1&#34;</span>
</span></span><span style="display:flex;"><span>model_id <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#a5d6ff">&#34;gpt-4o-mini&#34;</span>
</span></span><span style="display:flex;"><span>api_key <span style="color:#ff7b72;font-weight:bold">=</span> os<span style="color:#ff7b72;font-weight:bold">.</span>getenv(<span style="color:#a5d6ff">&#34;OPENAI_API_KEY&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#ff7b72">if</span> <span style="color:#ff7b72;font-weight:bold">not</span> api_key:
</span></span><span style="display:flex;"><span>    <span style="color:#ff7b72">raise</span> <span style="color:#f0883e;font-weight:bold">ValueError</span>(<span style="color:#a5d6ff">&#34;API key not found. Please set the OPENAI_API_KEY environment variable.&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>model <span style="color:#ff7b72;font-weight:bold">=</span> OpenAIServerModel(
</span></span><span style="display:flex;"><span>            model_id<span style="color:#ff7b72;font-weight:bold">=</span>model_id,
</span></span><span style="display:flex;"><span>            api_key<span style="color:#ff7b72;font-weight:bold">=</span>api_key,
</span></span><span style="display:flex;"><span>            api_base<span style="color:#ff7b72;font-weight:bold">=</span>api_base,
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>agent <span style="color:#ff7b72;font-weight:bold">=</span> ToolCallingAgent(tools<span style="color:#ff7b72;font-weight:bold">=</span>[DuckDuckGoSearchTool()], model<span style="color:#ff7b72;font-weight:bold">=</span>model)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>agent<span style="color:#ff7b72;font-weight:bold">.</span>run(<span style="color:#a5d6ff">&#34;What is the distance between Detroit and Chicago?&#34;</span>)
</span></span></code></pre></div><h1 id="litellmmodel-and-openaiservermodel">
  LiteLLMModel and OpenAIServerModel
  <a class="heading-link" href="#litellmmodel-and-openaiservermodel">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h1>
<p>Let&rsquo;s start with 2 models used above. <code>OpenAIServerModel</code> and <code>LiteLLMModel</code> both extend <code>Model</code>. They implement <code>__call__</code> to actually call the respective completion function to return a response.</p>
<div class="highlight"><pre tabindex="0" style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#ff7b72">class</span> <span style="color:#f0883e;font-weight:bold">LiteLLMModel</span>(Model):
</span></span><span style="display:flex;"><span>    <span style="color:#a5d6ff">&#34;&#34;&#34;This model connects to [LiteLLM](https://www.litellm.ai/) as a gateway to hundreds of LLMs.
</span></span></span><span style="display:flex;"><span><span style="color:#a5d6ff">
</span></span></span><span style="display:flex;"><span><span style="color:#a5d6ff">    Parameters:
</span></span></span><span style="display:flex;"><span><span style="color:#a5d6ff">        model_id (`str`):
</span></span></span><span style="display:flex;"><span><span style="color:#a5d6ff">            The model identifier to use on the server (e.g. &#34;gpt-3.5-turbo&#34;).
</span></span></span><span style="display:flex;"><span><span style="color:#a5d6ff">        api_base (`str`, *optional*):
</span></span></span><span style="display:flex;"><span><span style="color:#a5d6ff">            The base URL of the OpenAI-compatible API server.
</span></span></span><span style="display:flex;"><span><span style="color:#a5d6ff">        api_key (`str`, *optional*):
</span></span></span><span style="display:flex;"><span><span style="color:#a5d6ff">            The API key to use for authentication.
</span></span></span><span style="display:flex;"><span><span style="color:#a5d6ff">        custom_role_conversions (`dict[str, str]`, *optional*):
</span></span></span><span style="display:flex;"><span><span style="color:#a5d6ff">            Custom role conversion mapping to convert message roles in others.
</span></span></span><span style="display:flex;"><span><span style="color:#a5d6ff">            Useful for specific models that do not support specific message roles like &#34;system&#34;.
</span></span></span><span style="display:flex;"><span><span style="color:#a5d6ff">        **kwargs:
</span></span></span><span style="display:flex;"><span><span style="color:#a5d6ff">            Additional keyword arguments to pass to the OpenAI API.
</span></span></span><span style="display:flex;"><span><span style="color:#a5d6ff">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff7b72">def</span> <span style="color:#d2a8ff;font-weight:bold">__init__</span>(
</span></span><span style="display:flex;"><span>        self,
</span></span><span style="display:flex;"><span>        model_id: str <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#a5d6ff">&#34;anthropic/claude-3-5-sonnet-20240620&#34;</span>,
</span></span><span style="display:flex;"><span>        api_base<span style="color:#ff7b72;font-weight:bold">=</span><span style="color:#79c0ff">None</span>,
</span></span><span style="display:flex;"><span>        api_key<span style="color:#ff7b72;font-weight:bold">=</span><span style="color:#79c0ff">None</span>,
</span></span><span style="display:flex;"><span>        custom_role_conversions: Optional[Dict[str, str]] <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#79c0ff">None</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#ff7b72;font-weight:bold">**</span>kwargs,
</span></span><span style="display:flex;"><span>    ):
</span></span><span style="display:flex;"><span>    <span style="color:#ff7b72;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff7b72">def</span> <span style="color:#d2a8ff;font-weight:bold">__call__</span>(
</span></span><span style="display:flex;"><span>        self,
</span></span><span style="display:flex;"><span>        messages: List[Dict[str, str]],
</span></span><span style="display:flex;"><span>        stop_sequences: Optional[List[str]] <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#79c0ff">None</span>,
</span></span><span style="display:flex;"><span>        grammar: Optional[str] <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#79c0ff">None</span>,
</span></span><span style="display:flex;"><span>        tools_to_call_from: Optional[List[Tool]] <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#79c0ff">None</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#ff7b72;font-weight:bold">**</span>kwargs,
</span></span><span style="display:flex;"><span>    ) <span style="color:#ff7b72;font-weight:bold">-&gt;</span> ChatMessage:
</span></span><span style="display:flex;"><span>        <span style="color:#ff7b72">import</span> <span style="color:#ff7b72">litellm</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        completion_kwargs <span style="color:#ff7b72;font-weight:bold">=</span> self<span style="color:#ff7b72;font-weight:bold">.</span>_prepare_completion_kwargs(
</span></span><span style="display:flex;"><span>            messages<span style="color:#ff7b72;font-weight:bold">=</span>messages,
</span></span><span style="display:flex;"><span>            stop_sequences<span style="color:#ff7b72;font-weight:bold">=</span>stop_sequences,
</span></span><span style="display:flex;"><span>            grammar<span style="color:#ff7b72;font-weight:bold">=</span>grammar,
</span></span><span style="display:flex;"><span>            tools_to_call_from<span style="color:#ff7b72;font-weight:bold">=</span>tools_to_call_from,
</span></span><span style="display:flex;"><span>            model<span style="color:#ff7b72;font-weight:bold">=</span>self<span style="color:#ff7b72;font-weight:bold">.</span>model_id,
</span></span><span style="display:flex;"><span>            api_base<span style="color:#ff7b72;font-weight:bold">=</span>self<span style="color:#ff7b72;font-weight:bold">.</span>api_base,
</span></span><span style="display:flex;"><span>            api_key<span style="color:#ff7b72;font-weight:bold">=</span>self<span style="color:#ff7b72;font-weight:bold">.</span>api_key,
</span></span><span style="display:flex;"><span>            convert_images_to_image_urls<span style="color:#ff7b72;font-weight:bold">=</span><span style="color:#79c0ff">True</span>,
</span></span><span style="display:flex;"><span>            flatten_messages_as_text<span style="color:#ff7b72;font-weight:bold">=</span>self<span style="color:#ff7b72;font-weight:bold">.</span>model_id<span style="color:#ff7b72;font-weight:bold">.</span>startswith(<span style="color:#a5d6ff">&#34;ollama&#34;</span>),
</span></span><span style="display:flex;"><span>            custom_role_conversions<span style="color:#ff7b72;font-weight:bold">=</span>self<span style="color:#ff7b72;font-weight:bold">.</span>custom_role_conversions,
</span></span><span style="display:flex;"><span>            <span style="color:#ff7b72;font-weight:bold">**</span>kwargs,
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        response <span style="color:#ff7b72;font-weight:bold">=</span> litellm<span style="color:#ff7b72;font-weight:bold">.</span>completion(<span style="color:#ff7b72;font-weight:bold">**</span>completion_kwargs)
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#ff7b72">class</span> <span style="color:#f0883e;font-weight:bold">OpenAIServerModel</span>(Model):
</span></span><span style="display:flex;"><span>    <span style="color:#a5d6ff">&#34;&#34;&#34;This model connects to an OpenAI-compatible API server.
</span></span></span><span style="display:flex;"><span><span style="color:#a5d6ff">
</span></span></span><span style="display:flex;"><span><span style="color:#a5d6ff">    Parameters:
</span></span></span><span style="display:flex;"><span><span style="color:#a5d6ff">        model_id (`str`):
</span></span></span><span style="display:flex;"><span><span style="color:#a5d6ff">            The model identifier to use on the server (e.g. &#34;gpt-3.5-turbo&#34;).
</span></span></span><span style="display:flex;"><span><span style="color:#a5d6ff">        api_base (`str`, *optional*):
</span></span></span><span style="display:flex;"><span><span style="color:#a5d6ff">            The base URL of the OpenAI-compatible API server.
</span></span></span><span style="display:flex;"><span><span style="color:#a5d6ff">        api_key (`str`, *optional*):
</span></span></span><span style="display:flex;"><span><span style="color:#a5d6ff">            The API key to use for authentication.
</span></span></span><span style="display:flex;"><span><span style="color:#a5d6ff">        organization (`str`, *optional*):
</span></span></span><span style="display:flex;"><span><span style="color:#a5d6ff">            The organization to use for the API request.
</span></span></span><span style="display:flex;"><span><span style="color:#a5d6ff">        project (`str`, *optional*):
</span></span></span><span style="display:flex;"><span><span style="color:#a5d6ff">            The project to use for the API request.
</span></span></span><span style="display:flex;"><span><span style="color:#a5d6ff">        client_kwargs (`dict[str, Any]`, *optional*):
</span></span></span><span style="display:flex;"><span><span style="color:#a5d6ff">            Additional keyword arguments to pass to the OpenAI client (like organization, project, max_retries etc.).
</span></span></span><span style="display:flex;"><span><span style="color:#a5d6ff">        custom_role_conversions (`dict[str, str]`, *optional*):
</span></span></span><span style="display:flex;"><span><span style="color:#a5d6ff">            Custom role conversion mapping to convert message roles in others.
</span></span></span><span style="display:flex;"><span><span style="color:#a5d6ff">            Useful for specific models that do not support specific message roles like &#34;system&#34;.
</span></span></span><span style="display:flex;"><span><span style="color:#a5d6ff">        **kwargs:
</span></span></span><span style="display:flex;"><span><span style="color:#a5d6ff">            Additional keyword arguments to pass to the OpenAI API.
</span></span></span><span style="display:flex;"><span><span style="color:#a5d6ff">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff7b72">def</span> <span style="color:#d2a8ff;font-weight:bold">__init__</span>(
</span></span><span style="display:flex;"><span>        self,
</span></span><span style="display:flex;"><span>        model_id: str,
</span></span><span style="display:flex;"><span>        api_base: Optional[str] <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#79c0ff">None</span>,
</span></span><span style="display:flex;"><span>        api_key: Optional[str] <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#79c0ff">None</span>,
</span></span><span style="display:flex;"><span>        organization: Optional[str] <span style="color:#ff7b72;font-weight:bold">|</span> <span style="color:#79c0ff">None</span> <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#79c0ff">None</span>,
</span></span><span style="display:flex;"><span>        project: Optional[str] <span style="color:#ff7b72;font-weight:bold">|</span> <span style="color:#79c0ff">None</span> <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#79c0ff">None</span>,
</span></span><span style="display:flex;"><span>        client_kwargs: Optional[Dict[str, Any]] <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#79c0ff">None</span>,
</span></span><span style="display:flex;"><span>        custom_role_conversions: Optional[Dict[str, str]] <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#79c0ff">None</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#ff7b72;font-weight:bold">**</span>kwargs,
</span></span><span style="display:flex;"><span>    ):
</span></span><span style="display:flex;"><span>        <span style="color:#ff7b72">try</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#ff7b72">import</span> <span style="color:#ff7b72">openai</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff7b72">except</span> <span style="color:#f0883e;font-weight:bold">ModuleNotFoundError</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#ff7b72">raise</span> <span style="color:#f0883e;font-weight:bold">ModuleNotFoundError</span>(
</span></span><span style="display:flex;"><span>                <span style="color:#a5d6ff">&#34;Please install &#39;openai&#39; extra to use OpenAIServerModel: `pip install &#39;smolagents[openai]&#39;`&#34;</span>
</span></span><span style="display:flex;"><span>            ) <span style="color:#ff7b72">from</span> None
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        super()<span style="color:#ff7b72;font-weight:bold">.</span><span style="color:#d2a8ff;font-weight:bold">__init__</span>(<span style="color:#ff7b72;font-weight:bold">**</span>kwargs)
</span></span><span style="display:flex;"><span>        self<span style="color:#ff7b72;font-weight:bold">.</span>model_id <span style="color:#ff7b72;font-weight:bold">=</span> model_id
</span></span><span style="display:flex;"><span>        self<span style="color:#ff7b72;font-weight:bold">.</span>client <span style="color:#ff7b72;font-weight:bold">=</span> openai<span style="color:#ff7b72;font-weight:bold">.</span>OpenAI(
</span></span><span style="display:flex;"><span>            base_url<span style="color:#ff7b72;font-weight:bold">=</span>api_base,
</span></span><span style="display:flex;"><span>            api_key<span style="color:#ff7b72;font-weight:bold">=</span>api_key,
</span></span><span style="display:flex;"><span>            organization<span style="color:#ff7b72;font-weight:bold">=</span>organization,
</span></span><span style="display:flex;"><span>            project<span style="color:#ff7b72;font-weight:bold">=</span>project,
</span></span><span style="display:flex;"><span>            <span style="color:#ff7b72;font-weight:bold">**</span>(client_kwargs <span style="color:#ff7b72;font-weight:bold">or</span> {}),
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>        self<span style="color:#ff7b72;font-weight:bold">.</span>custom_role_conversions <span style="color:#ff7b72;font-weight:bold">=</span> custom_role_conversions
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff7b72">def</span> <span style="color:#d2a8ff;font-weight:bold">__call__</span>(
</span></span><span style="display:flex;"><span>        self,
</span></span><span style="display:flex;"><span>        messages: List[Dict[str, str]],
</span></span><span style="display:flex;"><span>        stop_sequences: Optional[List[str]] <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#79c0ff">None</span>,
</span></span><span style="display:flex;"><span>        grammar: Optional[str] <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#79c0ff">None</span>,
</span></span><span style="display:flex;"><span>        tools_to_call_from: Optional[List[Tool]] <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#79c0ff">None</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#ff7b72;font-weight:bold">**</span>kwargs,
</span></span><span style="display:flex;"><span>    ) <span style="color:#ff7b72;font-weight:bold">-&gt;</span> ChatMessage:
</span></span><span style="display:flex;"><span>        completion_kwargs <span style="color:#ff7b72;font-weight:bold">=</span> self<span style="color:#ff7b72;font-weight:bold">.</span>_prepare_completion_kwargs(
</span></span><span style="display:flex;"><span>            messages<span style="color:#ff7b72;font-weight:bold">=</span>messages,
</span></span><span style="display:flex;"><span>            stop_sequences<span style="color:#ff7b72;font-weight:bold">=</span>stop_sequences,
</span></span><span style="display:flex;"><span>            grammar<span style="color:#ff7b72;font-weight:bold">=</span>grammar,
</span></span><span style="display:flex;"><span>            tools_to_call_from<span style="color:#ff7b72;font-weight:bold">=</span>tools_to_call_from,
</span></span><span style="display:flex;"><span>            model<span style="color:#ff7b72;font-weight:bold">=</span>self<span style="color:#ff7b72;font-weight:bold">.</span>model_id,
</span></span><span style="display:flex;"><span>            custom_role_conversions<span style="color:#ff7b72;font-weight:bold">=</span>self<span style="color:#ff7b72;font-weight:bold">.</span>custom_role_conversions,
</span></span><span style="display:flex;"><span>            convert_images_to_image_urls<span style="color:#ff7b72;font-weight:bold">=</span><span style="color:#79c0ff">True</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#ff7b72;font-weight:bold">**</span>kwargs,
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>        response <span style="color:#ff7b72;font-weight:bold">=</span> self<span style="color:#ff7b72;font-weight:bold">.</span>client<span style="color:#ff7b72;font-weight:bold">.</span>chat<span style="color:#ff7b72;font-weight:bold">.</span>completions<span style="color:#ff7b72;font-weight:bold">.</span>create(<span style="color:#ff7b72;font-weight:bold">**</span>completion_kwargs)
</span></span><span style="display:flex;"><span>        self<span style="color:#ff7b72;font-weight:bold">.</span>last_input_token_count <span style="color:#ff7b72;font-weight:bold">=</span> response<span style="color:#ff7b72;font-weight:bold">.</span>usage<span style="color:#ff7b72;font-weight:bold">.</span>prompt_tokens
</span></span><span style="display:flex;"><span>        self<span style="color:#ff7b72;font-weight:bold">.</span>last_output_token_count <span style="color:#ff7b72;font-weight:bold">=</span> response<span style="color:#ff7b72;font-weight:bold">.</span>usage<span style="color:#ff7b72;font-weight:bold">.</span>completion_tokens
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        message <span style="color:#ff7b72;font-weight:bold">=</span> ChatMessage<span style="color:#ff7b72;font-weight:bold">.</span>from_dict(
</span></span><span style="display:flex;"><span>            response<span style="color:#ff7b72;font-weight:bold">.</span>choices[<span style="color:#a5d6ff">0</span>]<span style="color:#ff7b72;font-weight:bold">.</span>message<span style="color:#ff7b72;font-weight:bold">.</span>model_dump(include<span style="color:#ff7b72;font-weight:bold">=</span>{<span style="color:#a5d6ff">&#34;role&#34;</span>, <span style="color:#a5d6ff">&#34;content&#34;</span>, <span style="color:#a5d6ff">&#34;tool_calls&#34;</span>})
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>        message<span style="color:#ff7b72;font-weight:bold">.</span>raw <span style="color:#ff7b72;font-weight:bold">=</span> response
</span></span><span style="display:flex;"><span>        <span style="color:#ff7b72">if</span> tools_to_call_from <span style="color:#ff7b72;font-weight:bold">is</span> <span style="color:#ff7b72;font-weight:bold">not</span> <span style="color:#79c0ff">None</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#ff7b72">return</span> parse_tool_args_if_needed(message)
</span></span><span style="display:flex;"><span>        <span style="color:#ff7b72">return</span> message
</span></span></code></pre></div><h1 id="multistepagent">
  MultiStepAgent
  <a class="heading-link" href="#multistepagent">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h1>
<p>Now, we got the brain of the agent, Let&rsquo;s look at <code>MultiStepAgent</code>. It implements <code>run</code> which eventually calls <code>step()</code>. The child agents extends <code>MultiStepAgent</code> and implements <code>step()</code>. So, <code>run</code> create the prompt and calls <code>_run</code></p>
<div class="highlight"><pre tabindex="0" style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>    <span style="color:#ff7b72">def</span> <span style="color:#d2a8ff;font-weight:bold">run</span>(
</span></span><span style="display:flex;"><span>        self,
</span></span><span style="display:flex;"><span>        task: str,
</span></span><span style="display:flex;"><span>        stream: bool <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#79c0ff">False</span>,
</span></span><span style="display:flex;"><span>        reset: bool <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#79c0ff">True</span>,
</span></span><span style="display:flex;"><span>        images: Optional[List[str]] <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#79c0ff">None</span>,
</span></span><span style="display:flex;"><span>        additional_args: Optional[Dict] <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#79c0ff">None</span>,
</span></span><span style="display:flex;"><span>        max_steps: Optional[int] <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#79c0ff">None</span>,
</span></span><span style="display:flex;"><span>    ):
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        self<span style="color:#ff7b72;font-weight:bold">.</span>system_prompt <span style="color:#ff7b72;font-weight:bold">=</span> self<span style="color:#ff7b72;font-weight:bold">.</span>initialize_system_prompt()
</span></span><span style="display:flex;"><span>        self<span style="color:#ff7b72;font-weight:bold">.</span>memory<span style="color:#ff7b72;font-weight:bold">.</span>system_prompt <span style="color:#ff7b72;font-weight:bold">=</span> SystemPromptStep(system_prompt<span style="color:#ff7b72;font-weight:bold">=</span>self<span style="color:#ff7b72;font-weight:bold">.</span>system_prompt)
</span></span><span style="display:flex;"><span>        <span style="color:#ff7b72">if</span> reset:
</span></span><span style="display:flex;"><span>            self<span style="color:#ff7b72;font-weight:bold">.</span>memory<span style="color:#ff7b72;font-weight:bold">.</span>reset()
</span></span><span style="display:flex;"><span>            self<span style="color:#ff7b72;font-weight:bold">.</span>monitor<span style="color:#ff7b72;font-weight:bold">.</span>reset()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        self<span style="color:#ff7b72;font-weight:bold">.</span>logger<span style="color:#ff7b72;font-weight:bold">.</span>log_task(
</span></span><span style="display:flex;"><span>            content<span style="color:#ff7b72;font-weight:bold">=</span>self<span style="color:#ff7b72;font-weight:bold">.</span>task<span style="color:#ff7b72;font-weight:bold">.</span>strip(),
</span></span><span style="display:flex;"><span>            subtitle<span style="color:#ff7b72;font-weight:bold">=</span><span style="color:#79c0ff">f</span><span style="color:#a5d6ff">&#34;</span><span style="color:#a5d6ff">{</span>type(self<span style="color:#ff7b72;font-weight:bold">.</span>model)<span style="color:#ff7b72;font-weight:bold">.</span><span style="color:#79c0ff">__name__</span><span style="color:#a5d6ff">}</span><span style="color:#a5d6ff"> - </span><span style="color:#a5d6ff">{</span>(self<span style="color:#ff7b72;font-weight:bold">.</span>model<span style="color:#ff7b72;font-weight:bold">.</span>model_id <span style="color:#ff7b72">if</span> hasattr(self<span style="color:#ff7b72;font-weight:bold">.</span>model, <span style="color:#a5d6ff">&#39;model_id&#39;</span>) <span style="color:#ff7b72">else</span> <span style="color:#a5d6ff">&#39;&#39;</span>)<span style="color:#a5d6ff">}</span><span style="color:#a5d6ff">&#34;</span>,
</span></span><span style="display:flex;"><span>            level<span style="color:#ff7b72;font-weight:bold">=</span>LogLevel<span style="color:#ff7b72;font-weight:bold">.</span>INFO,
</span></span><span style="display:flex;"><span>            title<span style="color:#ff7b72;font-weight:bold">=</span>self<span style="color:#ff7b72;font-weight:bold">.</span>name <span style="color:#ff7b72">if</span> hasattr(self, <span style="color:#a5d6ff">&#34;name&#34;</span>) <span style="color:#ff7b72">else</span> <span style="color:#79c0ff">None</span>,
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>        self<span style="color:#ff7b72;font-weight:bold">.</span>memory<span style="color:#ff7b72;font-weight:bold">.</span>steps<span style="color:#ff7b72;font-weight:bold">.</span>append(TaskStep(task<span style="color:#ff7b72;font-weight:bold">=</span>self<span style="color:#ff7b72;font-weight:bold">.</span>task, task_images<span style="color:#ff7b72;font-weight:bold">=</span>images))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff7b72">if</span> getattr(self, <span style="color:#a5d6ff">&#34;python_executor&#34;</span>, <span style="color:#79c0ff">None</span>):
</span></span><span style="display:flex;"><span>            self<span style="color:#ff7b72;font-weight:bold">.</span>python_executor<span style="color:#ff7b72;font-weight:bold">.</span>send_variables(variables<span style="color:#ff7b72;font-weight:bold">=</span>self<span style="color:#ff7b72;font-weight:bold">.</span>state)
</span></span><span style="display:flex;"><span>            self<span style="color:#ff7b72;font-weight:bold">.</span>python_executor<span style="color:#ff7b72;font-weight:bold">.</span>send_tools({<span style="color:#ff7b72;font-weight:bold">**</span>self<span style="color:#ff7b72;font-weight:bold">.</span>tools, <span style="color:#ff7b72;font-weight:bold">**</span>self<span style="color:#ff7b72;font-weight:bold">.</span>managed_agents})
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff7b72">if</span> stream:
</span></span><span style="display:flex;"><span>            <span style="color:#8b949e;font-style:italic"># The steps are returned as they are executed through a generator to iterate on.</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff7b72">return</span> self<span style="color:#ff7b72;font-weight:bold">.</span>_run(task<span style="color:#ff7b72;font-weight:bold">=</span>self<span style="color:#ff7b72;font-weight:bold">.</span>task, max_steps<span style="color:#ff7b72;font-weight:bold">=</span>max_steps, images<span style="color:#ff7b72;font-weight:bold">=</span>images)
</span></span><span style="display:flex;"><span>        <span style="color:#8b949e;font-style:italic"># Outputs are returned only at the end. We only look at the last step.</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff7b72">return</span> deque(self<span style="color:#ff7b72;font-weight:bold">.</span>_run(task<span style="color:#ff7b72;font-weight:bold">=</span>self<span style="color:#ff7b72;font-weight:bold">.</span>task, max_steps<span style="color:#ff7b72;font-weight:bold">=</span>max_steps, images<span style="color:#ff7b72;font-weight:bold">=</span>images), maxlen<span style="color:#ff7b72;font-weight:bold">=</span><span style="color:#a5d6ff">1</span>)[<span style="color:#a5d6ff">0</span>]
</span></span></code></pre></div><p><code>_run</code> calls <code>_execute_step</code> which eventually calls <code>step</code></p>
<div class="highlight"><pre tabindex="0" style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>    <span style="color:#ff7b72">def</span> <span style="color:#d2a8ff;font-weight:bold">_run</span>(
</span></span><span style="display:flex;"><span>        self, task: str, max_steps: int, images: List[str] <span style="color:#ff7b72;font-weight:bold">|</span> <span style="color:#79c0ff">None</span> <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#79c0ff">None</span>
</span></span><span style="display:flex;"><span>    ) <span style="color:#ff7b72;font-weight:bold">-&gt;</span> Generator[ActionStep <span style="color:#ff7b72;font-weight:bold">|</span> AgentType, <span style="color:#79c0ff">None</span>, <span style="color:#79c0ff">None</span>]:
</span></span><span style="display:flex;"><span>        final_answer <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#79c0ff">None</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#ff7b72;font-weight:bold">.</span>step_number <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#a5d6ff">1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff7b72">while</span> final_answer <span style="color:#ff7b72;font-weight:bold">is</span> <span style="color:#79c0ff">None</span> <span style="color:#ff7b72;font-weight:bold">and</span> self<span style="color:#ff7b72;font-weight:bold">.</span>step_number <span style="color:#ff7b72;font-weight:bold">&lt;=</span> max_steps:
</span></span><span style="display:flex;"><span>            step_start_time <span style="color:#ff7b72;font-weight:bold">=</span> time<span style="color:#ff7b72;font-weight:bold">.</span>time()
</span></span><span style="display:flex;"><span>            memory_step <span style="color:#ff7b72;font-weight:bold">=</span> self<span style="color:#ff7b72;font-weight:bold">.</span>_create_memory_step(step_start_time, images)
</span></span><span style="display:flex;"><span>            <span style="color:#ff7b72">try</span>:
</span></span><span style="display:flex;"><span>                final_answer <span style="color:#ff7b72;font-weight:bold">=</span> self<span style="color:#ff7b72;font-weight:bold">.</span>_execute_step(task, memory_step)
</span></span><span style="display:flex;"><span>            <span style="color:#ff7b72">except</span> AgentError <span style="color:#ff7b72">as</span> e:
</span></span><span style="display:flex;"><span>                memory_step<span style="color:#ff7b72;font-weight:bold">.</span>error <span style="color:#ff7b72;font-weight:bold">=</span> e
</span></span><span style="display:flex;"><span>            <span style="color:#ff7b72">finally</span>:
</span></span><span style="display:flex;"><span>                self<span style="color:#ff7b72;font-weight:bold">.</span>_finalize_step(memory_step, step_start_time)
</span></span><span style="display:flex;"><span>                <span style="color:#ff7b72">yield</span> memory_step
</span></span><span style="display:flex;"><span>                self<span style="color:#ff7b72;font-weight:bold">.</span>step_number <span style="color:#ff7b72;font-weight:bold">+=</span> <span style="color:#a5d6ff">1</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>    <span style="color:#ff7b72">def</span> <span style="color:#d2a8ff;font-weight:bold">_execute_step</span>(self, task: str, memory_step: ActionStep) <span style="color:#ff7b72;font-weight:bold">-&gt;</span> Union[<span style="color:#79c0ff">None</span>, Any]:
</span></span><span style="display:flex;"><span>        <span style="color:#ff7b72">if</span> self<span style="color:#ff7b72;font-weight:bold">.</span>planning_interval <span style="color:#ff7b72;font-weight:bold">is</span> <span style="color:#ff7b72;font-weight:bold">not</span> <span style="color:#79c0ff">None</span> <span style="color:#ff7b72;font-weight:bold">and</span> self<span style="color:#ff7b72;font-weight:bold">.</span>step_number <span style="color:#ff7b72;font-weight:bold">%</span> self<span style="color:#ff7b72;font-weight:bold">.</span>planning_interval <span style="color:#ff7b72;font-weight:bold">==</span> <span style="color:#a5d6ff">1</span>:
</span></span><span style="display:flex;"><span>            self<span style="color:#ff7b72;font-weight:bold">.</span>planning_step(task, is_first_step<span style="color:#ff7b72;font-weight:bold">=</span>(self<span style="color:#ff7b72;font-weight:bold">.</span>step_number <span style="color:#ff7b72;font-weight:bold">==</span> <span style="color:#a5d6ff">1</span>), step<span style="color:#ff7b72;font-weight:bold">=</span>self<span style="color:#ff7b72;font-weight:bold">.</span>step_number)
</span></span><span style="display:flex;"><span>        self<span style="color:#ff7b72;font-weight:bold">.</span>logger<span style="color:#ff7b72;font-weight:bold">.</span>log_rule(<span style="color:#79c0ff">f</span><span style="color:#a5d6ff">&#34;Step </span><span style="color:#a5d6ff">{</span>self<span style="color:#ff7b72;font-weight:bold">.</span>step_number<span style="color:#a5d6ff">}</span><span style="color:#a5d6ff">&#34;</span>, level<span style="color:#ff7b72;font-weight:bold">=</span>LogLevel<span style="color:#ff7b72;font-weight:bold">.</span>INFO)
</span></span><span style="display:flex;"><span>        final_answer <span style="color:#ff7b72;font-weight:bold">=</span> self<span style="color:#ff7b72;font-weight:bold">.</span>step(memory_step)
</span></span><span style="display:flex;"><span>        <span style="color:#ff7b72">if</span> final_answer <span style="color:#ff7b72;font-weight:bold">is</span> <span style="color:#ff7b72;font-weight:bold">not</span> <span style="color:#79c0ff">None</span> <span style="color:#ff7b72;font-weight:bold">and</span> self<span style="color:#ff7b72;font-weight:bold">.</span>final_answer_checks:
</span></span><span style="display:flex;"><span>            self<span style="color:#ff7b72;font-weight:bold">.</span>_validate_final_answer(final_answer)
</span></span><span style="display:flex;"><span>        <span style="color:#ff7b72">return</span> final_answer
</span></span></code></pre></div><h1 id="toolcallingagent">
  ToolCallingAgent
  <a class="heading-link" href="#toolcallingagent">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h1>
<p>Looking deeper at <code>ToolCallingAgent</code>, that takes list of tools, model and other kargs.</p>
<div class="highlight"><pre tabindex="0" style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#ff7b72">class</span> <span style="color:#f0883e;font-weight:bold">ToolCallingAgent</span>(MultiStepAgent):
</span></span><span style="display:flex;"><span>    <span style="color:#a5d6ff">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#a5d6ff">    This agent uses JSON-like tool calls, using method `model.get_tool_call` to leverage the LLM engine&#39;s tool calling capabilities.
</span></span></span><span style="display:flex;"><span><span style="color:#a5d6ff">
</span></span></span><span style="display:flex;"><span><span style="color:#a5d6ff">    Args:
</span></span></span><span style="display:flex;"><span><span style="color:#a5d6ff">        tools (`list[Tool]`): [`Tool`]s that the agent can use.
</span></span></span><span style="display:flex;"><span><span style="color:#a5d6ff">        model (`Callable[[list[dict[str, str]]], ChatMessage]`): Model that will generate the agent&#39;s actions.
</span></span></span><span style="display:flex;"><span><span style="color:#a5d6ff">        prompt_templates ([`~agents.PromptTemplates`], *optional*): Prompt templates.
</span></span></span><span style="display:flex;"><span><span style="color:#a5d6ff">        planning_interval (`int`, *optional*): Interval at which the agent will run a planning step.
</span></span></span><span style="display:flex;"><span><span style="color:#a5d6ff">        **kwargs: Additional keyword arguments.
</span></span></span><span style="display:flex;"><span><span style="color:#a5d6ff">    &#34;&#34;&#34;</span>
</span></span></code></pre></div><p><code>step</code> picks the argument for function calling formatted by the model. The does <code>ToolCall</code> passing the arguments. There is a tool called <code>final_answer</code> that print the final results of prompts.</p>
<div class="highlight"><pre tabindex="0" style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>    <span style="color:#ff7b72">def</span> <span style="color:#d2a8ff;font-weight:bold">step</span>(self, memory_step: ActionStep) <span style="color:#ff7b72;font-weight:bold">-&gt;</span> Union[<span style="color:#79c0ff">None</span>, Any]:
</span></span><span style="display:flex;"><span>        <span style="color:#a5d6ff">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#a5d6ff">        Perform one step in the ReAct framework: the agent thinks, acts, and observes the result.
</span></span></span><span style="display:flex;"><span><span style="color:#a5d6ff">        Returns None if the step is not final.
</span></span></span><span style="display:flex;"><span><span style="color:#a5d6ff">        &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        memory_messages <span style="color:#ff7b72;font-weight:bold">=</span> self<span style="color:#ff7b72;font-weight:bold">.</span>write_memory_to_messages()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        self<span style="color:#ff7b72;font-weight:bold">.</span>input_messages <span style="color:#ff7b72;font-weight:bold">=</span> memory_messages
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#8b949e;font-style:italic"># Add new step in logs</span>
</span></span><span style="display:flex;"><span>        memory_step<span style="color:#ff7b72;font-weight:bold">.</span>model_input_messages <span style="color:#ff7b72;font-weight:bold">=</span> memory_messages<span style="color:#ff7b72;font-weight:bold">.</span>copy()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff7b72">try</span>:
</span></span><span style="display:flex;"><span>            model_message: ChatMessage <span style="color:#ff7b72;font-weight:bold">=</span> self<span style="color:#ff7b72;font-weight:bold">.</span>model(
</span></span><span style="display:flex;"><span>                memory_messages,
</span></span><span style="display:flex;"><span>                tools_to_call_from<span style="color:#ff7b72;font-weight:bold">=</span>list(self<span style="color:#ff7b72;font-weight:bold">.</span>tools<span style="color:#ff7b72;font-weight:bold">.</span>values()),
</span></span><span style="display:flex;"><span>                stop_sequences<span style="color:#ff7b72;font-weight:bold">=</span>[<span style="color:#a5d6ff">&#34;Observation:&#34;</span>],
</span></span><span style="display:flex;"><span>            )
</span></span><span style="display:flex;"><span>            memory_step<span style="color:#ff7b72;font-weight:bold">.</span>model_output_message <span style="color:#ff7b72;font-weight:bold">=</span> model_message
</span></span><span style="display:flex;"><span>            <span style="color:#ff7b72">if</span> model_message<span style="color:#ff7b72;font-weight:bold">.</span>tool_calls <span style="color:#ff7b72;font-weight:bold">is</span> <span style="color:#79c0ff">None</span> <span style="color:#ff7b72;font-weight:bold">or</span> len(model_message<span style="color:#ff7b72;font-weight:bold">.</span>tool_calls) <span style="color:#ff7b72;font-weight:bold">==</span> <span style="color:#a5d6ff">0</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#ff7b72">raise</span> <span style="color:#f0883e;font-weight:bold">Exception</span>(<span style="color:#a5d6ff">&#34;Model did not call any tools. Call `final_answer` tool to return a final answer.&#34;</span>)
</span></span><span style="display:flex;"><span>            tool_call <span style="color:#ff7b72;font-weight:bold">=</span> model_message<span style="color:#ff7b72;font-weight:bold">.</span>tool_calls[<span style="color:#a5d6ff">0</span>]
</span></span><span style="display:flex;"><span>            tool_name, tool_call_id <span style="color:#ff7b72;font-weight:bold">=</span> tool_call<span style="color:#ff7b72;font-weight:bold">.</span>function<span style="color:#ff7b72;font-weight:bold">.</span>name, tool_call<span style="color:#ff7b72;font-weight:bold">.</span>id
</span></span><span style="display:flex;"><span>            tool_arguments <span style="color:#ff7b72;font-weight:bold">=</span> tool_call<span style="color:#ff7b72;font-weight:bold">.</span>function<span style="color:#ff7b72;font-weight:bold">.</span>arguments
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff7b72">except</span> <span style="color:#f0883e;font-weight:bold">Exception</span> <span style="color:#ff7b72">as</span> e:
</span></span><span style="display:flex;"><span>            <span style="color:#ff7b72">raise</span> AgentGenerationError(<span style="color:#79c0ff">f</span><span style="color:#a5d6ff">&#34;Error in generating tool call with model:</span><span style="color:#79c0ff">\n</span><span style="color:#a5d6ff">{</span>e<span style="color:#a5d6ff">}</span><span style="color:#a5d6ff">&#34;</span>, self<span style="color:#ff7b72;font-weight:bold">.</span>logger) <span style="color:#ff7b72">from</span> <span style="color:#ff7b72">e</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        memory_step<span style="color:#ff7b72;font-weight:bold">.</span>tool_calls <span style="color:#ff7b72;font-weight:bold">=</span> [ToolCall(name<span style="color:#ff7b72;font-weight:bold">=</span>tool_name, arguments<span style="color:#ff7b72;font-weight:bold">=</span>tool_arguments, id<span style="color:#ff7b72;font-weight:bold">=</span>tool_call_id)]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#8b949e;font-style:italic"># Execute</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#ff7b72;font-weight:bold">.</span>logger<span style="color:#ff7b72;font-weight:bold">.</span>log(
</span></span><span style="display:flex;"><span>            Panel(Text(<span style="color:#79c0ff">f</span><span style="color:#a5d6ff">&#34;Calling tool: &#39;</span><span style="color:#a5d6ff">{</span>tool_name<span style="color:#a5d6ff">}</span><span style="color:#a5d6ff">&#39; with arguments: </span><span style="color:#a5d6ff">{</span>tool_arguments<span style="color:#a5d6ff">}</span><span style="color:#a5d6ff">&#34;</span>)),
</span></span><span style="display:flex;"><span>            level<span style="color:#ff7b72;font-weight:bold">=</span>LogLevel<span style="color:#ff7b72;font-weight:bold">.</span>INFO,
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>        <span style="color:#ff7b72">if</span> tool_name <span style="color:#ff7b72;font-weight:bold">==</span> <span style="color:#a5d6ff">&#34;final_answer&#34;</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#ff7b72">if</span> isinstance(tool_arguments, dict):
</span></span><span style="display:flex;"><span>                <span style="color:#ff7b72">if</span> <span style="color:#a5d6ff">&#34;answer&#34;</span> <span style="color:#ff7b72;font-weight:bold">in</span> tool_arguments:
</span></span><span style="display:flex;"><span>                    answer <span style="color:#ff7b72;font-weight:bold">=</span> tool_arguments[<span style="color:#a5d6ff">&#34;answer&#34;</span>]
</span></span><span style="display:flex;"><span>                <span style="color:#ff7b72">else</span>:
</span></span><span style="display:flex;"><span>                    answer <span style="color:#ff7b72;font-weight:bold">=</span> tool_arguments
</span></span><span style="display:flex;"><span>            <span style="color:#ff7b72">else</span>:
</span></span><span style="display:flex;"><span>                answer <span style="color:#ff7b72;font-weight:bold">=</span> tool_arguments
</span></span><span style="display:flex;"><span>            <span style="color:#ff7b72">if</span> (
</span></span><span style="display:flex;"><span>                isinstance(answer, str) <span style="color:#ff7b72;font-weight:bold">and</span> answer <span style="color:#ff7b72;font-weight:bold">in</span> self<span style="color:#ff7b72;font-weight:bold">.</span>state<span style="color:#ff7b72;font-weight:bold">.</span>keys()
</span></span><span style="display:flex;"><span>            ):  <span style="color:#8b949e;font-style:italic"># if the answer is a state variable, return the value</span>
</span></span><span style="display:flex;"><span>                final_answer <span style="color:#ff7b72;font-weight:bold">=</span> self<span style="color:#ff7b72;font-weight:bold">.</span>state[answer]
</span></span><span style="display:flex;"><span>                self<span style="color:#ff7b72;font-weight:bold">.</span>logger<span style="color:#ff7b72;font-weight:bold">.</span>log(
</span></span><span style="display:flex;"><span>                    <span style="color:#79c0ff">f</span><span style="color:#a5d6ff">&#34;[bold </span><span style="color:#a5d6ff">{</span>YELLOW_HEX<span style="color:#a5d6ff">}</span><span style="color:#a5d6ff">]Final answer:[/bold </span><span style="color:#a5d6ff">{</span>YELLOW_HEX<span style="color:#a5d6ff">}</span><span style="color:#a5d6ff">] Extracting key &#39;</span><span style="color:#a5d6ff">{</span>answer<span style="color:#a5d6ff">}</span><span style="color:#a5d6ff">&#39; from state to return value &#39;</span><span style="color:#a5d6ff">{</span>final_answer<span style="color:#a5d6ff">}</span><span style="color:#a5d6ff">&#39;.&#34;</span>,
</span></span><span style="display:flex;"><span>                    level<span style="color:#ff7b72;font-weight:bold">=</span>LogLevel<span style="color:#ff7b72;font-weight:bold">.</span>INFO,
</span></span><span style="display:flex;"><span>                )
</span></span><span style="display:flex;"><span>            <span style="color:#ff7b72">else</span>:
</span></span><span style="display:flex;"><span>                final_answer <span style="color:#ff7b72;font-weight:bold">=</span> answer
</span></span><span style="display:flex;"><span>                self<span style="color:#ff7b72;font-weight:bold">.</span>logger<span style="color:#ff7b72;font-weight:bold">.</span>log(
</span></span><span style="display:flex;"><span>                    Text(<span style="color:#79c0ff">f</span><span style="color:#a5d6ff">&#34;Final answer: </span><span style="color:#a5d6ff">{</span>final_answer<span style="color:#a5d6ff">}</span><span style="color:#a5d6ff">&#34;</span>, style<span style="color:#ff7b72;font-weight:bold">=</span><span style="color:#79c0ff">f</span><span style="color:#a5d6ff">&#34;bold </span><span style="color:#a5d6ff">{</span>YELLOW_HEX<span style="color:#a5d6ff">}</span><span style="color:#a5d6ff">&#34;</span>),
</span></span><span style="display:flex;"><span>                    level<span style="color:#ff7b72;font-weight:bold">=</span>LogLevel<span style="color:#ff7b72;font-weight:bold">.</span>INFO,
</span></span><span style="display:flex;"><span>                )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            memory_step<span style="color:#ff7b72;font-weight:bold">.</span>action_output <span style="color:#ff7b72;font-weight:bold">=</span> final_answer
</span></span><span style="display:flex;"><span>            <span style="color:#ff7b72">return</span> final_answer
</span></span><span style="display:flex;"><span>        <span style="color:#ff7b72">else</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#ff7b72">if</span> tool_arguments <span style="color:#ff7b72;font-weight:bold">is</span> <span style="color:#79c0ff">None</span>:
</span></span><span style="display:flex;"><span>                tool_arguments <span style="color:#ff7b72;font-weight:bold">=</span> {}
</span></span><span style="display:flex;"><span>            observation <span style="color:#ff7b72;font-weight:bold">=</span> self<span style="color:#ff7b72;font-weight:bold">.</span>execute_tool_call(tool_name, tool_arguments)
</span></span><span style="display:flex;"><span>            observation_type <span style="color:#ff7b72;font-weight:bold">=</span> type(observation)
</span></span><span style="display:flex;"><span>            <span style="color:#ff7b72">if</span> observation_type <span style="color:#ff7b72;font-weight:bold">in</span> [AgentImage, AgentAudio]:
</span></span><span style="display:flex;"><span>                <span style="color:#ff7b72">if</span> observation_type <span style="color:#ff7b72;font-weight:bold">==</span> AgentImage:
</span></span><span style="display:flex;"><span>                    observation_name <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#a5d6ff">&#34;image.png&#34;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#ff7b72">elif</span> observation_type <span style="color:#ff7b72;font-weight:bold">==</span> AgentAudio:
</span></span><span style="display:flex;"><span>                    observation_name <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#a5d6ff">&#34;audio.mp3&#34;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#8b949e;font-style:italic"># TODO: observation naming could allow for different names of same type</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                self<span style="color:#ff7b72;font-weight:bold">.</span>state[observation_name] <span style="color:#ff7b72;font-weight:bold">=</span> observation
</span></span><span style="display:flex;"><span>                updated_information <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#79c0ff">f</span><span style="color:#a5d6ff">&#34;Stored &#39;</span><span style="color:#a5d6ff">{</span>observation_name<span style="color:#a5d6ff">}</span><span style="color:#a5d6ff">&#39; in memory.&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff7b72">else</span>:
</span></span><span style="display:flex;"><span>                updated_information <span style="color:#ff7b72;font-weight:bold">=</span> str(observation)<span style="color:#ff7b72;font-weight:bold">.</span>strip()
</span></span><span style="display:flex;"><span>            self<span style="color:#ff7b72;font-weight:bold">.</span>logger<span style="color:#ff7b72;font-weight:bold">.</span>log(
</span></span><span style="display:flex;"><span>                <span style="color:#79c0ff">f</span><span style="color:#a5d6ff">&#34;Observations: </span><span style="color:#a5d6ff">{</span>updated_information<span style="color:#ff7b72;font-weight:bold">.</span>replace(<span style="color:#a5d6ff">&#39;[&#39;</span>, <span style="color:#a5d6ff">&#39;|&#39;</span>)<span style="color:#a5d6ff">}</span><span style="color:#a5d6ff">&#34;</span>,  <span style="color:#8b949e;font-style:italic"># escape potential rich-tag-like components</span>
</span></span><span style="display:flex;"><span>                level<span style="color:#ff7b72;font-weight:bold">=</span>LogLevel<span style="color:#ff7b72;font-weight:bold">.</span>INFO,
</span></span><span style="display:flex;"><span>            )
</span></span><span style="display:flex;"><span>            memory_step<span style="color:#ff7b72;font-weight:bold">.</span>observations <span style="color:#ff7b72;font-weight:bold">=</span> updated_information
</span></span><span style="display:flex;"><span>            <span style="color:#ff7b72">return</span> <span style="color:#79c0ff">None</span>
</span></span></code></pre></div><h1 id="codeagent">
  CodeAgent
  <a class="heading-link" href="#codeagent">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h1>
<p><code>CodeAgent</code> seems interesting as it is not using JSON tool calling that <code>llamaIndex</code> ReAct agent used. Well, <code>smolagents</code> still provides <code>ToolCallingAgent</code> which is exactly that.</p>
<div class="highlight"><pre tabindex="0" style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#ff7b72">class</span> <span style="color:#f0883e;font-weight:bold">CodeAgent</span>(MultiStepAgent):
</span></span><span style="display:flex;"><span>    <span style="color:#a5d6ff">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#a5d6ff">    In this agent, the tool calls will be formulated by the LLM in code format, then parsed and executed.
</span></span></span><span style="display:flex;"><span><span style="color:#a5d6ff">
</span></span></span><span style="display:flex;"><span><span style="color:#a5d6ff">    Args:
</span></span></span><span style="display:flex;"><span><span style="color:#a5d6ff">        tools (`list[Tool]`): [`Tool`]s that the agent can use.
</span></span></span><span style="display:flex;"><span><span style="color:#a5d6ff">        model (`Callable[[list[dict[str, str]]], ChatMessage]`): Model that will generate the agent&#39;s actions.
</span></span></span><span style="display:flex;"><span><span style="color:#a5d6ff">        prompt_templates (`dict`, *optional*): Prompt templates.
</span></span></span><span style="display:flex;"><span><span style="color:#a5d6ff">        grammar (`dict[str, str]`, *optional*): Grammar used to parse the LLM output.
</span></span></span><span style="display:flex;"><span><span style="color:#a5d6ff">        additional_authorized_imports (`list[str]`, *optional*): Additional authorized imports for the agent.
</span></span></span><span style="display:flex;"><span><span style="color:#a5d6ff">        planning_interval (`int`, *optional*): Interval at which the agent will run a planning step.
</span></span></span><span style="display:flex;"><span><span style="color:#a5d6ff">        use_e2b_executor (`bool`, default `False`): Whether to use the E2B executor for remote code execution.
</span></span></span><span style="display:flex;"><span><span style="color:#a5d6ff">        max_print_outputs_length (`int`, *optional*): Maximum length of the print outputs.
</span></span></span><span style="display:flex;"><span><span style="color:#a5d6ff">        **kwargs: Additional keyword arguments.
</span></span></span><span style="display:flex;"><span><span style="color:#a5d6ff">
</span></span></span><span style="display:flex;"><span><span style="color:#a5d6ff">    &#34;&#34;&#34;</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>    <span style="color:#ff7b72">def</span> <span style="color:#d2a8ff;font-weight:bold">step</span>(self, memory_step: ActionStep) <span style="color:#ff7b72;font-weight:bold">-&gt;</span> Union[<span style="color:#79c0ff">None</span>, Any]:
</span></span><span style="display:flex;"><span>        <span style="color:#a5d6ff">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#a5d6ff">        Perform one step in the ReAct framework: the agent thinks, acts, and observes the result.
</span></span></span><span style="display:flex;"><span><span style="color:#a5d6ff">        Returns None if the step is not final.
</span></span></span><span style="display:flex;"><span><span style="color:#a5d6ff">        &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        memory_messages <span style="color:#ff7b72;font-weight:bold">=</span> self<span style="color:#ff7b72;font-weight:bold">.</span>write_memory_to_messages()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        self<span style="color:#ff7b72;font-weight:bold">.</span>input_messages <span style="color:#ff7b72;font-weight:bold">=</span> memory_messages<span style="color:#ff7b72;font-weight:bold">.</span>copy()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#8b949e;font-style:italic"># Add new step in logs</span>
</span></span><span style="display:flex;"><span>        memory_step<span style="color:#ff7b72;font-weight:bold">.</span>model_input_messages <span style="color:#ff7b72;font-weight:bold">=</span> memory_messages<span style="color:#ff7b72;font-weight:bold">.</span>copy()
</span></span><span style="display:flex;"><span>        <span style="color:#ff7b72">try</span>:
</span></span><span style="display:flex;"><span>            additional_args <span style="color:#ff7b72;font-weight:bold">=</span> {<span style="color:#a5d6ff">&#34;grammar&#34;</span>: self<span style="color:#ff7b72;font-weight:bold">.</span>grammar} <span style="color:#ff7b72">if</span> self<span style="color:#ff7b72;font-weight:bold">.</span>grammar <span style="color:#ff7b72;font-weight:bold">is</span> <span style="color:#ff7b72;font-weight:bold">not</span> <span style="color:#79c0ff">None</span> <span style="color:#ff7b72">else</span> {}
</span></span><span style="display:flex;"><span>            chat_message: ChatMessage <span style="color:#ff7b72;font-weight:bold">=</span> self<span style="color:#ff7b72;font-weight:bold">.</span>model(
</span></span><span style="display:flex;"><span>                self<span style="color:#ff7b72;font-weight:bold">.</span>input_messages,
</span></span><span style="display:flex;"><span>                stop_sequences<span style="color:#ff7b72;font-weight:bold">=</span>[<span style="color:#a5d6ff">&#34;&lt;end_code&gt;&#34;</span>, <span style="color:#a5d6ff">&#34;Observation:&#34;</span>],
</span></span><span style="display:flex;"><span>                <span style="color:#ff7b72;font-weight:bold">**</span>additional_args,
</span></span><span style="display:flex;"><span>            )
</span></span><span style="display:flex;"><span>            memory_step<span style="color:#ff7b72;font-weight:bold">.</span>model_output_message <span style="color:#ff7b72;font-weight:bold">=</span> chat_message
</span></span><span style="display:flex;"><span>            model_output <span style="color:#ff7b72;font-weight:bold">=</span> chat_message<span style="color:#ff7b72;font-weight:bold">.</span>content
</span></span><span style="display:flex;"><span>            memory_step<span style="color:#ff7b72;font-weight:bold">.</span>model_output <span style="color:#ff7b72;font-weight:bold">=</span> model_output
</span></span><span style="display:flex;"><span>        <span style="color:#ff7b72">except</span> <span style="color:#f0883e;font-weight:bold">Exception</span> <span style="color:#ff7b72">as</span> e:
</span></span><span style="display:flex;"><span>            <span style="color:#ff7b72">raise</span> AgentGenerationError(<span style="color:#79c0ff">f</span><span style="color:#a5d6ff">&#34;Error in generating model output:</span><span style="color:#79c0ff">\n</span><span style="color:#a5d6ff">{</span>e<span style="color:#a5d6ff">}</span><span style="color:#a5d6ff">&#34;</span>, self<span style="color:#ff7b72;font-weight:bold">.</span>logger) <span style="color:#ff7b72">from</span> <span style="color:#ff7b72">e</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        self<span style="color:#ff7b72;font-weight:bold">.</span>logger<span style="color:#ff7b72;font-weight:bold">.</span>log_markdown(
</span></span><span style="display:flex;"><span>            content<span style="color:#ff7b72;font-weight:bold">=</span>model_output,
</span></span><span style="display:flex;"><span>            title<span style="color:#ff7b72;font-weight:bold">=</span><span style="color:#a5d6ff">&#34;Output message of the LLM:&#34;</span>,
</span></span><span style="display:flex;"><span>            level<span style="color:#ff7b72;font-weight:bold">=</span>LogLevel<span style="color:#ff7b72;font-weight:bold">.</span>DEBUG,
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#8b949e;font-style:italic"># Parse</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff7b72">try</span>:
</span></span><span style="display:flex;"><span>            code_action <span style="color:#ff7b72;font-weight:bold">=</span> fix_final_answer_code(parse_code_blobs(model_output))
</span></span><span style="display:flex;"><span>        <span style="color:#ff7b72">except</span> <span style="color:#f0883e;font-weight:bold">Exception</span> <span style="color:#ff7b72">as</span> e:
</span></span><span style="display:flex;"><span>            error_msg <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#79c0ff">f</span><span style="color:#a5d6ff">&#34;Error in code parsing:</span><span style="color:#79c0ff">\n</span><span style="color:#a5d6ff">{</span>e<span style="color:#a5d6ff">}</span><span style="color:#79c0ff">\n</span><span style="color:#a5d6ff">Make sure to provide correct code blobs.&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff7b72">raise</span> AgentParsingError(error_msg, self<span style="color:#ff7b72;font-weight:bold">.</span>logger)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        memory_step<span style="color:#ff7b72;font-weight:bold">.</span>tool_calls <span style="color:#ff7b72;font-weight:bold">=</span> [
</span></span><span style="display:flex;"><span>            ToolCall(
</span></span><span style="display:flex;"><span>                name<span style="color:#ff7b72;font-weight:bold">=</span><span style="color:#a5d6ff">&#34;python_interpreter&#34;</span>,
</span></span><span style="display:flex;"><span>                arguments<span style="color:#ff7b72;font-weight:bold">=</span>code_action,
</span></span><span style="display:flex;"><span>                id<span style="color:#ff7b72;font-weight:bold">=</span><span style="color:#79c0ff">f</span><span style="color:#a5d6ff">&#34;call_</span><span style="color:#a5d6ff">{</span>len(self<span style="color:#ff7b72;font-weight:bold">.</span>memory<span style="color:#ff7b72;font-weight:bold">.</span>steps)<span style="color:#a5d6ff">}</span><span style="color:#a5d6ff">&#34;</span>,
</span></span><span style="display:flex;"><span>            )
</span></span><span style="display:flex;"><span>        ]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#8b949e;font-style:italic"># Execute</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#ff7b72;font-weight:bold">.</span>logger<span style="color:#ff7b72;font-weight:bold">.</span>log_code(title<span style="color:#ff7b72;font-weight:bold">=</span><span style="color:#a5d6ff">&#34;Executing parsed code:&#34;</span>, content<span style="color:#ff7b72;font-weight:bold">=</span>code_action, level<span style="color:#ff7b72;font-weight:bold">=</span>LogLevel<span style="color:#ff7b72;font-weight:bold">.</span>INFO)
</span></span><span style="display:flex;"><span>        is_final_answer <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#79c0ff">False</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff7b72">try</span>:
</span></span><span style="display:flex;"><span>            output, execution_logs, is_final_answer <span style="color:#ff7b72;font-weight:bold">=</span> self<span style="color:#ff7b72;font-weight:bold">.</span>python_executor(code_action)
</span></span><span style="display:flex;"><span>            execution_outputs_console <span style="color:#ff7b72;font-weight:bold">=</span> []
</span></span><span style="display:flex;"><span>            <span style="color:#ff7b72">if</span> len(execution_logs) <span style="color:#ff7b72;font-weight:bold">&gt;</span> <span style="color:#a5d6ff">0</span>:
</span></span><span style="display:flex;"><span>                execution_outputs_console <span style="color:#ff7b72;font-weight:bold">+=</span> [
</span></span><span style="display:flex;"><span>                    Text(<span style="color:#a5d6ff">&#34;Execution logs:&#34;</span>, style<span style="color:#ff7b72;font-weight:bold">=</span><span style="color:#a5d6ff">&#34;bold&#34;</span>),
</span></span><span style="display:flex;"><span>                    Text(execution_logs),
</span></span><span style="display:flex;"><span>                ]
</span></span><span style="display:flex;"><span>            observation <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#a5d6ff">&#34;Execution logs:</span><span style="color:#79c0ff">\n</span><span style="color:#a5d6ff">&#34;</span> <span style="color:#ff7b72;font-weight:bold">+</span> execution_logs
</span></span><span style="display:flex;"><span>        <span style="color:#ff7b72">except</span> <span style="color:#f0883e;font-weight:bold">Exception</span> <span style="color:#ff7b72">as</span> e:
</span></span><span style="display:flex;"><span>            <span style="color:#ff7b72">if</span> hasattr(self<span style="color:#ff7b72;font-weight:bold">.</span>python_executor, <span style="color:#a5d6ff">&#34;state&#34;</span>) <span style="color:#ff7b72;font-weight:bold">and</span> <span style="color:#a5d6ff">&#34;_print_outputs&#34;</span> <span style="color:#ff7b72;font-weight:bold">in</span> self<span style="color:#ff7b72;font-weight:bold">.</span>python_executor<span style="color:#ff7b72;font-weight:bold">.</span>state:
</span></span><span style="display:flex;"><span>                execution_logs <span style="color:#ff7b72;font-weight:bold">=</span> str(self<span style="color:#ff7b72;font-weight:bold">.</span>python_executor<span style="color:#ff7b72;font-weight:bold">.</span>state[<span style="color:#a5d6ff">&#34;_print_outputs&#34;</span>])
</span></span><span style="display:flex;"><span>                <span style="color:#ff7b72">if</span> len(execution_logs) <span style="color:#ff7b72;font-weight:bold">&gt;</span> <span style="color:#a5d6ff">0</span>:
</span></span><span style="display:flex;"><span>                    execution_outputs_console <span style="color:#ff7b72;font-weight:bold">=</span> [
</span></span><span style="display:flex;"><span>                        Text(<span style="color:#a5d6ff">&#34;Execution logs:&#34;</span>, style<span style="color:#ff7b72;font-weight:bold">=</span><span style="color:#a5d6ff">&#34;bold&#34;</span>),
</span></span><span style="display:flex;"><span>                        Text(execution_logs),
</span></span><span style="display:flex;"><span>                    ]
</span></span><span style="display:flex;"><span>                    memory_step<span style="color:#ff7b72;font-weight:bold">.</span>observations <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#a5d6ff">&#34;Execution logs:</span><span style="color:#79c0ff">\n</span><span style="color:#a5d6ff">&#34;</span> <span style="color:#ff7b72;font-weight:bold">+</span> execution_logs
</span></span><span style="display:flex;"><span>                    self<span style="color:#ff7b72;font-weight:bold">.</span>logger<span style="color:#ff7b72;font-weight:bold">.</span>log(Group(<span style="color:#ff7b72;font-weight:bold">*</span>execution_outputs_console), level<span style="color:#ff7b72;font-weight:bold">=</span>LogLevel<span style="color:#ff7b72;font-weight:bold">.</span>INFO)
</span></span><span style="display:flex;"><span>            error_msg <span style="color:#ff7b72;font-weight:bold">=</span> str(e)
</span></span><span style="display:flex;"><span>            <span style="color:#ff7b72">if</span> <span style="color:#a5d6ff">&#34;Import of &#34;</span> <span style="color:#ff7b72;font-weight:bold">in</span> error_msg <span style="color:#ff7b72;font-weight:bold">and</span> <span style="color:#a5d6ff">&#34; is not allowed&#34;</span> <span style="color:#ff7b72;font-weight:bold">in</span> error_msg:
</span></span><span style="display:flex;"><span>                self<span style="color:#ff7b72;font-weight:bold">.</span>logger<span style="color:#ff7b72;font-weight:bold">.</span>log(
</span></span><span style="display:flex;"><span>                    <span style="color:#a5d6ff">&#34;[bold red]Warning to user: Code execution failed due to an unauthorized import - Consider passing said import under `additional_authorized_imports` when initializing your CodeAgent.&#34;</span>,
</span></span><span style="display:flex;"><span>                    level<span style="color:#ff7b72;font-weight:bold">=</span>LogLevel<span style="color:#ff7b72;font-weight:bold">.</span>INFO,
</span></span><span style="display:flex;"><span>                )
</span></span><span style="display:flex;"><span>            <span style="color:#ff7b72">raise</span> AgentExecutionError(error_msg, self<span style="color:#ff7b72;font-weight:bold">.</span>logger)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        truncated_output <span style="color:#ff7b72;font-weight:bold">=</span> truncate_content(str(output))
</span></span><span style="display:flex;"><span>        observation <span style="color:#ff7b72;font-weight:bold">+=</span> <span style="color:#a5d6ff">&#34;Last output from code snippet:</span><span style="color:#79c0ff">\n</span><span style="color:#a5d6ff">&#34;</span> <span style="color:#ff7b72;font-weight:bold">+</span> truncated_output
</span></span><span style="display:flex;"><span>        memory_step<span style="color:#ff7b72;font-weight:bold">.</span>observations <span style="color:#ff7b72;font-weight:bold">=</span> observation
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        execution_outputs_console <span style="color:#ff7b72;font-weight:bold">+=</span> [
</span></span><span style="display:flex;"><span>            Text(
</span></span><span style="display:flex;"><span>                <span style="color:#79c0ff">f</span><span style="color:#a5d6ff">&#34;</span><span style="color:#a5d6ff">{</span>(<span style="color:#a5d6ff">&#39;Out - Final answer&#39;</span> <span style="color:#ff7b72">if</span> is_final_answer <span style="color:#ff7b72">else</span> <span style="color:#a5d6ff">&#39;Out&#39;</span>)<span style="color:#a5d6ff">}</span><span style="color:#a5d6ff">: </span><span style="color:#a5d6ff">{</span>truncated_output<span style="color:#a5d6ff">}</span><span style="color:#a5d6ff">&#34;</span>,
</span></span><span style="display:flex;"><span>                style<span style="color:#ff7b72;font-weight:bold">=</span>(<span style="color:#79c0ff">f</span><span style="color:#a5d6ff">&#34;bold </span><span style="color:#a5d6ff">{</span>YELLOW_HEX<span style="color:#a5d6ff">}</span><span style="color:#a5d6ff">&#34;</span> <span style="color:#ff7b72">if</span> is_final_answer <span style="color:#ff7b72">else</span> <span style="color:#a5d6ff">&#34;&#34;</span>),
</span></span><span style="display:flex;"><span>            ),
</span></span><span style="display:flex;"><span>        ]
</span></span><span style="display:flex;"><span>        self<span style="color:#ff7b72;font-weight:bold">.</span>logger<span style="color:#ff7b72;font-weight:bold">.</span>log(Group(<span style="color:#ff7b72;font-weight:bold">*</span>execution_outputs_console), level<span style="color:#ff7b72;font-weight:bold">=</span>LogLevel<span style="color:#ff7b72;font-weight:bold">.</span>INFO)
</span></span><span style="display:flex;"><span>        memory_step<span style="color:#ff7b72;font-weight:bold">.</span>action_output <span style="color:#ff7b72;font-weight:bold">=</span> output
</span></span><span style="display:flex;"><span>        <span style="color:#ff7b72">return</span> output <span style="color:#ff7b72">if</span> is_final_answer <span style="color:#ff7b72">else</span> <span style="color:#79c0ff">None</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>        <span style="color:#ff7b72">if</span> use_e2b_executor:
</span></span><span style="display:flex;"><span>            self<span style="color:#ff7b72;font-weight:bold">.</span>python_executor <span style="color:#ff7b72;font-weight:bold">=</span> E2BExecutor(
</span></span><span style="display:flex;"><span>                self<span style="color:#ff7b72;font-weight:bold">.</span>additional_authorized_imports,
</span></span><span style="display:flex;"><span>                list(all_tools<span style="color:#ff7b72;font-weight:bold">.</span>values()),
</span></span><span style="display:flex;"><span>                self<span style="color:#ff7b72;font-weight:bold">.</span>logger,
</span></span><span style="display:flex;"><span>            )
</span></span><span style="display:flex;"><span>        <span style="color:#ff7b72">else</span>:
</span></span><span style="display:flex;"><span>            self<span style="color:#ff7b72;font-weight:bold">.</span>python_executor <span style="color:#ff7b72;font-weight:bold">=</span> LocalPythonInterpreter(
</span></span><span style="display:flex;"><span>                self<span style="color:#ff7b72;font-weight:bold">.</span>additional_authorized_imports,
</span></span><span style="display:flex;"><span>                all_tools,
</span></span><span style="display:flex;"><span>                max_print_outputs_length<span style="color:#ff7b72;font-weight:bold">=</span>max_print_outputs_length,
</span></span><span style="display:flex;"><span>            )
</span></span></code></pre></div><h2 id="system-prompt">
  System prompt
  <a class="heading-link" href="#system-prompt">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h2>
<p><code>smolagents</code> have very verbose and well written prompts to generate code. You can find the full prompt <code>src/smolagents/prompts/code_agent.yaml</code>. The interesting part is the example code for the LLM to generate a task, thought and observation.</p>
<div class="highlight"><pre tabindex="0" style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>  You are an expert assistant who can solve any task using code blobs. You will be given a task to solve as best you can.
</span></span><span style="display:flex;"><span>  To do so, you have been given access to a list of tools: these tools are basically Python functions which you can call with code.
</span></span><span style="display:flex;"><span>  To solve the task, you must plan forward to proceed in a series of steps, in a cycle of &#39;Thought:&#39;, &#39;Code:&#39;, and &#39;Observation:&#39; sequences.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  At each step, in the &#39;Thought:&#39; sequence, you should first explain your reasoning towards solving the task and the tools that you want to use.
</span></span><span style="display:flex;"><span>  Then in the &#39;Code:&#39; sequence, you should write the code in simple Python. The code sequence must end with &#39;&lt;end_code&gt;&#39; sequence.
</span></span><span style="display:flex;"><span>  During each intermediate step, you can use &#39;print()&#39; to save whatever important information you will then need.
</span></span><span style="display:flex;"><span>  These print outputs will then appear in the &#39;Observation:&#39; field, which will be available as input for the next step.
</span></span><span style="display:flex;"><span>  In the end you have to return a final answer using the `final_answer` tool.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  Here are a few examples using notional tools:
</span></span><span style="display:flex;"><span>  ---
</span></span><span style="display:flex;"><span>  Task: &#34;Generate an image of the oldest person in this document.&#34;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  Thought: I will proceed step by step and use the following tools: `document_qa` to find the oldest person in the document, then `image_generator` to generate an image according to the answer.
</span></span><span style="display:flex;"><span>  Code:
</span></span><span style="display:flex;"><span>  ```py
</span></span><span style="display:flex;"><span>  answer = document_qa(document=document, question=&#34;Who is the oldest person mentioned?&#34;)
</span></span><span style="display:flex;"><span>  print(answer)
</span></span><span style="display:flex;"><span>  ```&lt;end_code&gt;
</span></span><span style="display:flex;"><span>  Observation: &#34;The oldest person in the document is John Doe, a 55 year old lumberjack living in Newfoundland.&#34;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  Thought: I will now generate an image showcasing the oldest person.
</span></span><span style="display:flex;"><span>  Code:
</span></span><span style="display:flex;"><span>  ```py
</span></span><span style="display:flex;"><span>  image = image_generator(&#34;A portrait of John Doe, a 55-year-old man living in Canada.&#34;)
</span></span><span style="display:flex;"><span>  final_answer(image)
</span></span><span style="display:flex;"><span>  ```&lt;end_code&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  ---
</span></span></code></pre></div><p>And at the end, There are some rules for the LLM to generate the code:</p>
<div class="highlight"><pre tabindex="0" style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>  Here are the rules you should always follow to solve your task:
</span></span><span style="display:flex;"><span>  1. Always provide a &#39;Thought:&#39; sequence, and a &#39;Code:\n```py&#39; sequence ending with &#39;```&lt;end_code&gt;&#39; sequence, else you will fail.
</span></span><span style="display:flex;"><span>  2. Use only variables that you have defined!
</span></span><span style="display:flex;"><span>  3. Always use the right arguments for the tools. DO NOT pass the arguments as a dict as in &#39;answer = wiki({&#39;query&#39;: &#34;What is the place where James Bond lives?&#34;})&#39;, but use the arguments directly as in &#39;answer = wiki(query=&#34;What is the place where James Bond lives?&#34;)&#39;.
</span></span><span style="display:flex;"><span>  4. Take care to not chain too many sequential tool calls in the same code block, especially when the output format is unpredictable. For instance, a call to search has an unpredictable return format, so do not have another tool call that depends on its output in the same block: rather output results with print() to use them in the next block.
</span></span><span style="display:flex;"><span>  5. Call a tool only when needed, and never re-do a tool call that you previously did with the exact same parameters.
</span></span><span style="display:flex;"><span>  6. Don&#39;t name any new variable with the same name as a tool: for instance don&#39;t name a variable &#39;final_answer&#39;.
</span></span><span style="display:flex;"><span>  7. Never create any notional variables in our code, as having these in your logs will derail you from the true variables.
</span></span><span style="display:flex;"><span>  8. You can use imports in your code, but only from the following list of modules: {{authorized_imports}}
</span></span><span style="display:flex;"><span>  9. The state persists between code executions: so if in one step you&#39;ve created variables or imported modules, these will all persist.
</span></span><span style="display:flex;"><span>  10. Don&#39;t give up! You&#39;re in charge of solving the task, not providing directions to solve it.
</span></span></code></pre></div><h2 id="localpythoninterpreter">
  LocalPythonInterpreter
  <a class="heading-link" href="#localpythoninterpreter">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h2>
<p>For the code generation and execution, it&rsquo;s always good idea to sand-box to stop malicious code executing <code>CodeAgent</code> can use <code>LocalPythonInterpreter</code> to limit the code specific packages(imports and call). To enforce that, it uses AST to evaluate the generate code. <code>__call__</code> calls <code>evaluate_python_code</code> that processes the ast.</p>
<div class="highlight"><pre tabindex="0" style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#ff7b72">class</span> <span style="color:#f0883e;font-weight:bold">LocalPythonInterpreter</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff7b72">def</span> <span style="color:#d2a8ff;font-weight:bold">__init__</span>(
</span></span><span style="display:flex;"><span>        self,
</span></span><span style="display:flex;"><span>        additional_authorized_imports: List[str],
</span></span><span style="display:flex;"><span>        tools: Dict,
</span></span><span style="display:flex;"><span>        max_print_outputs_length: Optional[int] <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#79c0ff">None</span>,
</span></span><span style="display:flex;"><span>    ):
</span></span><span style="display:flex;"><span>        self<span style="color:#ff7b72;font-weight:bold">.</span>custom_tools <span style="color:#ff7b72;font-weight:bold">=</span> {}
</span></span><span style="display:flex;"><span>        self<span style="color:#ff7b72;font-weight:bold">.</span>state <span style="color:#ff7b72;font-weight:bold">=</span> {}
</span></span><span style="display:flex;"><span>        self<span style="color:#ff7b72;font-weight:bold">.</span>max_print_outputs_length <span style="color:#ff7b72;font-weight:bold">=</span> max_print_outputs_length
</span></span><span style="display:flex;"><span>        <span style="color:#ff7b72">if</span> max_print_outputs_length <span style="color:#ff7b72;font-weight:bold">is</span> <span style="color:#79c0ff">None</span>:
</span></span><span style="display:flex;"><span>            self<span style="color:#ff7b72;font-weight:bold">.</span>max_print_outputs_length <span style="color:#ff7b72;font-weight:bold">=</span> DEFAULT_MAX_LEN_OUTPUT
</span></span><span style="display:flex;"><span>        self<span style="color:#ff7b72;font-weight:bold">.</span>additional_authorized_imports <span style="color:#ff7b72;font-weight:bold">=</span> additional_authorized_imports
</span></span><span style="display:flex;"><span>        self<span style="color:#ff7b72;font-weight:bold">.</span>authorized_imports <span style="color:#ff7b72;font-weight:bold">=</span> list(set(BASE_BUILTIN_MODULES) <span style="color:#ff7b72;font-weight:bold">|</span> set(self<span style="color:#ff7b72;font-weight:bold">.</span>additional_authorized_imports))
</span></span><span style="display:flex;"><span>        <span style="color:#8b949e;font-style:italic"># Add base trusted tools to list</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#ff7b72;font-weight:bold">.</span>static_tools <span style="color:#ff7b72;font-weight:bold">=</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#ff7b72;font-weight:bold">**</span>tools,
</span></span><span style="display:flex;"><span>            <span style="color:#ff7b72;font-weight:bold">**</span>BASE_PYTHON_TOOLS<span style="color:#ff7b72;font-weight:bold">.</span>copy(),
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#8b949e;font-style:italic"># TODO: assert self.authorized imports are all installed locally</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff7b72">def</span> <span style="color:#d2a8ff;font-weight:bold">__call__</span>(self, code_action: str, additional_variables: Dict) <span style="color:#ff7b72;font-weight:bold">-&gt;</span> Tuple[Any, str, bool]:
</span></span><span style="display:flex;"><span>        self<span style="color:#ff7b72;font-weight:bold">.</span>state<span style="color:#ff7b72;font-weight:bold">.</span>update(additional_variables)
</span></span><span style="display:flex;"><span>        output, is_final_answer <span style="color:#ff7b72;font-weight:bold">=</span> evaluate_python_code(
</span></span><span style="display:flex;"><span>            code_action,
</span></span><span style="display:flex;"><span>            static_tools<span style="color:#ff7b72;font-weight:bold">=</span>self<span style="color:#ff7b72;font-weight:bold">.</span>static_tools,
</span></span><span style="display:flex;"><span>            custom_tools<span style="color:#ff7b72;font-weight:bold">=</span>self<span style="color:#ff7b72;font-weight:bold">.</span>custom_tools,
</span></span><span style="display:flex;"><span>            state<span style="color:#ff7b72;font-weight:bold">=</span>self<span style="color:#ff7b72;font-weight:bold">.</span>state,
</span></span><span style="display:flex;"><span>            authorized_imports<span style="color:#ff7b72;font-weight:bold">=</span>self<span style="color:#ff7b72;font-weight:bold">.</span>authorized_imports,
</span></span><span style="display:flex;"><span>            max_print_outputs_length<span style="color:#ff7b72;font-weight:bold">=</span>self<span style="color:#ff7b72;font-weight:bold">.</span>max_print_outputs_length,
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>        logs <span style="color:#ff7b72;font-weight:bold">=</span> str(self<span style="color:#ff7b72;font-weight:bold">.</span>state[<span style="color:#a5d6ff">&#34;_print_outputs&#34;</span>])
</span></span><span style="display:flex;"><span>        <span style="color:#ff7b72">return</span> output, logs, is_final_answer
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#ff7b72">def</span> <span style="color:#d2a8ff;font-weight:bold">evaluate_python_code</span>(
</span></span><span style="display:flex;"><span>    code: str,
</span></span><span style="display:flex;"><span>    static_tools: Optional[Dict[str, Callable]] <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#79c0ff">None</span>,
</span></span><span style="display:flex;"><span>    custom_tools: Optional[Dict[str, Callable]] <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#79c0ff">None</span>,
</span></span><span style="display:flex;"><span>    state: Optional[Dict[str, Any]] <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#79c0ff">None</span>,
</span></span><span style="display:flex;"><span>    authorized_imports: List[str] <span style="color:#ff7b72;font-weight:bold">=</span> BASE_BUILTIN_MODULES,
</span></span><span style="display:flex;"><span>    max_print_outputs_length: int <span style="color:#ff7b72;font-weight:bold">=</span> DEFAULT_MAX_LEN_OUTPUT,
</span></span><span style="display:flex;"><span>):
</span></span><span style="display:flex;"><span>    <span style="color:#a5d6ff">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#a5d6ff">    Evaluate a python expression using the content of the variables stored in a state and only evaluating a given set
</span></span></span><span style="display:flex;"><span><span style="color:#a5d6ff">    of functions.
</span></span></span><span style="display:flex;"><span><span style="color:#a5d6ff">
</span></span></span><span style="display:flex;"><span><span style="color:#a5d6ff">    This function will recurse through the nodes of the tree provided.
</span></span></span><span style="display:flex;"><span><span style="color:#a5d6ff">
</span></span></span><span style="display:flex;"><span><span style="color:#a5d6ff">    Args:
</span></span></span><span style="display:flex;"><span><span style="color:#a5d6ff">        code (`str`):
</span></span></span><span style="display:flex;"><span><span style="color:#a5d6ff">            The code to evaluate.
</span></span></span><span style="display:flex;"><span><span style="color:#a5d6ff">        static_tools (`Dict[str, Callable]`):
</span></span></span><span style="display:flex;"><span><span style="color:#a5d6ff">            The functions that may be called during the evaluation. These can also be agents in a multiagent setting.
</span></span></span><span style="display:flex;"><span><span style="color:#a5d6ff">            These tools cannot be overwritten in the code: any assignment to their name will raise an error.
</span></span></span><span style="display:flex;"><span><span style="color:#a5d6ff">        custom_tools (`Dict[str, Callable]`):
</span></span></span><span style="display:flex;"><span><span style="color:#a5d6ff">            The functions that may be called during the evaluation.
</span></span></span><span style="display:flex;"><span><span style="color:#a5d6ff">            These tools can be overwritten in the code: any assignment to their name will overwrite them.
</span></span></span><span style="display:flex;"><span><span style="color:#a5d6ff">        state (`Dict[str, Any]`):
</span></span></span><span style="display:flex;"><span><span style="color:#a5d6ff">            A dictionary mapping variable names to values. The `state` should contain the initial inputs but will be
</span></span></span><span style="display:flex;"><span><span style="color:#a5d6ff">            updated by this function to contain all variables as they are evaluated.
</span></span></span><span style="display:flex;"><span><span style="color:#a5d6ff">            The print outputs will be stored in the state under the key &#34;_print_outputs&#34;.
</span></span></span><span style="display:flex;"><span><span style="color:#a5d6ff">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff7b72">try</span>:
</span></span><span style="display:flex;"><span>        expression <span style="color:#ff7b72;font-weight:bold">=</span> ast<span style="color:#ff7b72;font-weight:bold">.</span>parse(code)
</span></span><span style="display:flex;"><span>    <span style="color:#ff7b72">except</span> <span style="color:#f0883e;font-weight:bold">SyntaxError</span> <span style="color:#ff7b72">as</span> e:
</span></span><span style="display:flex;"><span>        <span style="color:#ff7b72">raise</span> InterpreterError(
</span></span><span style="display:flex;"><span>            <span style="color:#79c0ff">f</span><span style="color:#a5d6ff">&#34;Code parsing failed on line </span><span style="color:#a5d6ff">{</span>e<span style="color:#ff7b72;font-weight:bold">.</span>lineno<span style="color:#a5d6ff">}</span><span style="color:#a5d6ff"> due to: </span><span style="color:#a5d6ff">{</span>type(e)<span style="color:#ff7b72;font-weight:bold">.</span><span style="color:#79c0ff">__name__</span><span style="color:#a5d6ff">}</span><span style="color:#79c0ff">\n</span><span style="color:#a5d6ff">&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#79c0ff">f</span><span style="color:#a5d6ff">&#34;</span><span style="color:#a5d6ff">{</span>e<span style="color:#ff7b72;font-weight:bold">.</span>text<span style="color:#a5d6ff">}</span><span style="color:#a5d6ff">&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#79c0ff">f</span><span style="color:#a5d6ff">&#34;</span><span style="color:#a5d6ff">{</span><span style="color:#a5d6ff">&#39; &#39;</span> <span style="color:#ff7b72;font-weight:bold">*</span> (e<span style="color:#ff7b72;font-weight:bold">.</span>offset <span style="color:#ff7b72;font-weight:bold">or</span> <span style="color:#a5d6ff">0</span>)<span style="color:#a5d6ff">}</span><span style="color:#a5d6ff">^</span><span style="color:#79c0ff">\n</span><span style="color:#a5d6ff">&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#79c0ff">f</span><span style="color:#a5d6ff">&#34;Error: </span><span style="color:#a5d6ff">{</span>str(e)<span style="color:#a5d6ff">}</span><span style="color:#a5d6ff">&#34;</span>
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff7b72">if</span> state <span style="color:#ff7b72;font-weight:bold">is</span> <span style="color:#79c0ff">None</span>:
</span></span><span style="display:flex;"><span>        state <span style="color:#ff7b72;font-weight:bold">=</span> {}
</span></span><span style="display:flex;"><span>    static_tools <span style="color:#ff7b72;font-weight:bold">=</span> static_tools<span style="color:#ff7b72;font-weight:bold">.</span>copy() <span style="color:#ff7b72">if</span> static_tools <span style="color:#ff7b72;font-weight:bold">is</span> <span style="color:#ff7b72;font-weight:bold">not</span> <span style="color:#79c0ff">None</span> <span style="color:#ff7b72">else</span> {}
</span></span><span style="display:flex;"><span>    custom_tools <span style="color:#ff7b72;font-weight:bold">=</span> custom_tools <span style="color:#ff7b72">if</span> custom_tools <span style="color:#ff7b72;font-weight:bold">is</span> <span style="color:#ff7b72;font-weight:bold">not</span> <span style="color:#79c0ff">None</span> <span style="color:#ff7b72">else</span> {}
</span></span><span style="display:flex;"><span>    result <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#79c0ff">None</span>
</span></span><span style="display:flex;"><span>    state[<span style="color:#a5d6ff">&#34;_print_outputs&#34;</span>] <span style="color:#ff7b72;font-weight:bold">=</span> PrintContainer()
</span></span><span style="display:flex;"><span>    state[<span style="color:#a5d6ff">&#34;_operations_count&#34;</span>] <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#a5d6ff">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff7b72">def</span> <span style="color:#d2a8ff;font-weight:bold">final_answer</span>(value):
</span></span><span style="display:flex;"><span>        <span style="color:#ff7b72">raise</span> FinalAnswerException(value)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    static_tools[<span style="color:#a5d6ff">&#34;final_answer&#34;</span>] <span style="color:#ff7b72;font-weight:bold">=</span> final_answer
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff7b72">try</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff7b72">for</span> node <span style="color:#ff7b72;font-weight:bold">in</span> expression<span style="color:#ff7b72;font-weight:bold">.</span>body:
</span></span><span style="display:flex;"><span>            result <span style="color:#ff7b72;font-weight:bold">=</span> evaluate_ast(node, state, static_tools, custom_tools, authorized_imports)
</span></span><span style="display:flex;"><span>        state[<span style="color:#a5d6ff">&#34;_print_outputs&#34;</span>]<span style="color:#ff7b72;font-weight:bold">.</span>value <span style="color:#ff7b72;font-weight:bold">=</span> truncate_content(
</span></span><span style="display:flex;"><span>            str(state[<span style="color:#a5d6ff">&#34;_print_outputs&#34;</span>]), max_length<span style="color:#ff7b72;font-weight:bold">=</span>max_print_outputs_length
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>        is_final_answer <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#79c0ff">False</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff7b72">return</span> result, is_final_answer
</span></span><span style="display:flex;"><span>    <span style="color:#ff7b72">except</span> FinalAnswerException <span style="color:#ff7b72">as</span> e:
</span></span><span style="display:flex;"><span>        state[<span style="color:#a5d6ff">&#34;_print_outputs&#34;</span>]<span style="color:#ff7b72;font-weight:bold">.</span>value <span style="color:#ff7b72;font-weight:bold">=</span> truncate_content(
</span></span><span style="display:flex;"><span>            str(state[<span style="color:#a5d6ff">&#34;_print_outputs&#34;</span>]), max_length<span style="color:#ff7b72;font-weight:bold">=</span>max_print_outputs_length
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>        is_final_answer <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#79c0ff">True</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff7b72">return</span> e<span style="color:#ff7b72;font-weight:bold">.</span>value, is_final_answer
</span></span><span style="display:flex;"><span>    <span style="color:#ff7b72">except</span> <span style="color:#f0883e;font-weight:bold">Exception</span> <span style="color:#ff7b72">as</span> e:
</span></span><span style="display:flex;"><span>        exception_type <span style="color:#ff7b72;font-weight:bold">=</span> type(e)<span style="color:#ff7b72;font-weight:bold">.</span><span style="color:#79c0ff">__name__</span>
</span></span><span style="display:flex;"><span>        state[<span style="color:#a5d6ff">&#34;_print_outputs&#34;</span>]<span style="color:#ff7b72;font-weight:bold">.</span>value <span style="color:#ff7b72;font-weight:bold">=</span> truncate_content(
</span></span><span style="display:flex;"><span>            str(state[<span style="color:#a5d6ff">&#34;_print_outputs&#34;</span>]), max_length<span style="color:#ff7b72;font-weight:bold">=</span>max_print_outputs_length
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>        <span style="color:#ff7b72">raise</span> InterpreterError(
</span></span><span style="display:flex;"><span>            <span style="color:#79c0ff">f</span><span style="color:#a5d6ff">&#34;Code execution failed at line &#39;</span><span style="color:#a5d6ff">{</span>ast<span style="color:#ff7b72;font-weight:bold">.</span>get_source_segment(code, node)<span style="color:#a5d6ff">}</span><span style="color:#a5d6ff">&#39; due to: </span><span style="color:#a5d6ff">{</span>exception_type<span style="color:#a5d6ff">}</span><span style="color:#a5d6ff">:</span><span style="color:#a5d6ff">{</span>str(e)<span style="color:#a5d6ff">}</span><span style="color:#a5d6ff">&#34;</span>
</span></span><span style="display:flex;"><span>        )
</span></span></code></pre></div>
      </div>


      <footer>
        


        
        
        
        
        
        
        
      </footer>
    </article>

    
  </section>

    </div>

    <footer class="footer">
  <section class="container">
    Â©
    
    2026
    
    Â·
    
      Licensed under <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">CC BY-SA-4.0</a>
    Â·
    
    Powered by <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> & <a href="https://github.com/luizdepra/hugo-coder/" target="_blank" rel="noopener">Coder</a>.
    
  </section>
</footer>

  </main>

  

  
  
  <script src="/js/coder.min.6ae284be93d2d19dad1f02b0039508d9aab3180a12a06dcc71b0b0ef7825a317.js" integrity="sha256-auKEvpPS0Z2tHwKwA5UI2aqzGAoSoG3McbCw73gloxc="></script>
  

  

  


  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  
</body>

</html>
