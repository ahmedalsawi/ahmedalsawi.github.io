<!DOCTYPE html>
<html lang="en">

<head>
  <title>
  How much riscv verilog I can write in 5 hours · Techiedeepdive
</title>
  <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="color-scheme" content="light dark">




<meta name="description" content="While I was waiting for my weekly chicken roast to cook, I had this really bad idea for a challenge. how much riscv verilog i can write from scratch in the next 2 hours until the chicken is done?
So, yeah that&rsquo;s what I did on the last day of new year vacation.
2 hours to V hours  Link to heading   I thought to start with a skeleton for single-cycle (See [H and H][1]) and try to build the blocks bottom up style.">
<meta name="keywords" content="">

<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content=""/>

<meta name="twitter:title" content="How much riscv verilog I can write in 5 hours"/>
<meta name="twitter:description" content="While I was waiting for my weekly chicken roast to cook, I had this really bad idea for a challenge. how much riscv verilog i can write from scratch in the next 2 hours until the chicken is done?
So, yeah that&rsquo;s what I did on the last day of new year vacation.
2 hours to V hours  Link to heading   I thought to start with a skeleton for single-cycle (See [H and H][1]) and try to build the blocks bottom up style."/>

<meta property="og:title" content="How much riscv verilog I can write in 5 hours" />
<meta property="og:description" content="While I was waiting for my weekly chicken roast to cook, I had this really bad idea for a challenge. how much riscv verilog i can write from scratch in the next 2 hours until the chicken is done?
So, yeah that&rsquo;s what I did on the last day of new year vacation.
2 hours to V hours  Link to heading   I thought to start with a skeleton for single-cycle (See [H and H][1]) and try to build the blocks bottom up style." />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/2022/01/how-much-riscv-verilog-i-can-write-in-5-hours/" /><meta property="og:image" content=""/><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-01-03T00:00:00+00:00" />
<meta property="article:modified_time" content="2022-01-03T00:00:00+00:00" /><meta property="og:site_name" content="Techiedeepdive" />





<link rel="canonical" href="/posts/2022/01/how-much-riscv-verilog-i-can-write-in-5-hours/">


<link rel="preload" href="/fonts/fa-brands-400.woff2" as="font" type="font/woff2" crossorigin>
<link rel="preload" href="/fonts/fa-regular-400.woff2" as="font" type="font/woff2" crossorigin>
<link rel="preload" href="/fonts/fa-solid-900.woff2" as="font" type="font/woff2" crossorigin>


  
  
  <link rel="stylesheet" href="/css/coder.min.577e3c5ead537873430da16f0964b754a120fd87c4e2203a00686e7c75b51378.css" integrity="sha256-V348Xq1TeHNDDaFvCWS3VKEg/YfE4iA6AGhufHW1E3g=" crossorigin="anonymous" media="screen" />






  
    
    
    <link rel="stylesheet" href="/css/coder-dark.min.a00e6364bacbc8266ad1cc81230774a1397198f8cfb7bcba29b7d6fcb54ce57f.css" integrity="sha256-oA5jZLrLyCZq0cyBIwd0oTlxmPjPt7y6KbfW/LVM5X8=" crossorigin="anonymous" media="screen" />
  



 




<link rel="icon" type="image/svg+xml" href="/images/favicon.svg" sizes="any">
<link rel="icon" type="image/png" href="/images/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/images/favicon-16x16.png" sizes="16x16">

<link rel="apple-touch-icon" href="/images/apple-touch-icon.png">
<link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">

<link rel="manifest" href="/site.webmanifest">
<link rel="mask-icon" href="/images/safari-pinned-tab.svg" color="#5bbad5">









</head>






<body class="preload-transitions colorscheme-auto">
  
<div class="float-container">
    <a id="dark-mode-toggle" class="colorscheme-toggle">
        <i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i>
    </a>
</div>


  <main class="wrapper">
    <nav class="navigation">
  <section class="container">
    
    <a class="navigation-title" href="">
      Techiedeepdive
    </a>
    
    
      <input type="checkbox" id="menu-toggle" />
      <label class="menu-button float-right" for="menu-toggle">
        <i class="fa-solid fa-bars fa-fw" aria-hidden="true"></i>
      </label>
      <ul class="navigation-list">
        
          
            <li class="navigation-item">
              <a class="navigation-link " href="/posts">Blog</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link " href="/reading-list/">Reading list</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link " href="/tags/">Tags</a>
            </li>
          
        
        
      </ul>
    
  </section>
</nav>


    <div class="content">
      
  <section class="container post">
    <article>
      <header>
        <div class="post-title">
          <h1 class="title">
            <a class="title-link" href="/posts/2022/01/how-much-riscv-verilog-i-can-write-in-5-hours/">
              How much riscv verilog I can write in 5 hours
            </a>
          </h1>
        </div>
        <div class="post-meta">
          <div class="date">
            <span class="posted-on">
              <i class="fa-solid fa-calendar" aria-hidden="true"></i>
              <time datetime="2022-01-03T00:00:00Z">
                January 3, 2022
              </time>
            </span>
            <span class="reading-time">
              <i class="fa-solid fa-clock" aria-hidden="true"></i>
              3-minute read
            </span>
          </div>
          
          
          <div class="tags">
  <i class="fa-solid fa-tag" aria-hidden="true"></i>
    <span class="tag">
      <a href="/tags/riscv/">riscv</a>
    </span>
      <span class="separator">•</span>
    <span class="tag">
      <a href="/tags/verilog/">verilog</a>
    </span></div>

        </div>
      </header>

      <div class="post-content">
        
        <p>While I was waiting for my weekly chicken roast to cook, I had this really bad idea for a challenge. <strong>how much riscv verilog i can write from scratch in the next 2 hours until the chicken is done?</strong></p>
<p>So, yeah that&rsquo;s what I did on the last day of new year vacation.</p>
<h1 id="2-hours-to-v-hours">
  2 hours to V hours
  <a class="heading-link" href="#2-hours-to-v-hours">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h1>
<p>I thought to start with a skeleton for single-cycle (See [H and H][1]) and try to build the blocks bottom up style.</p>
<p>At the 2 hour mark(minus the chicken prep time), I wrote</p>
<ul>
<li>Basic small blocks.</li>
<li>Loaded make-shift hex.</li>
<li>Spent 20 minutes to make VCD work with iverilog(I want that time back)</li>
</ul>
<p>Not bad but it was obvious I failed the 2-hour challenge. So, I changed  it to 5 hours instead. It seemed like a lucky number :)</p>
<h1 id="basic-blocks">
  Basic blocks
  <a class="heading-link" href="#basic-blocks">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h1>
<ul>
<li>RAM</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-verilog" data-lang="verilog"><span style="color:#fff;font-weight:bold">module</span> ram #(<span style="color:#fff;font-weight:bold">parameter</span> WIDTH=<span style="color:#ff0;font-weight:bold">32</span>, <span style="color:#fff;font-weight:bold">parameter</span> ADDR=<span style="color:#ff0;font-weight:bold">32</span>) (
	<span style="color:#fff;font-weight:bold">input</span> <span style="color:#fff;font-weight:bold">wire</span> clk,
	<span style="color:#fff;font-weight:bold">input</span> <span style="color:#fff;font-weight:bold">wire</span> we,
    <span style="color:#fff;font-weight:bold">input</span> <span style="color:#fff;font-weight:bold">wire</span> [ WIDTH - <span style="color:#ff0;font-weight:bold">1</span>: <span style="color:#ff0;font-weight:bold">0</span>] din,
    <span style="color:#fff;font-weight:bold">input</span> <span style="color:#fff;font-weight:bold">wire</span> [ADDR-<span style="color:#ff0;font-weight:bold">1</span> : <span style="color:#ff0;font-weight:bold">0</span>] addr,
    <span style="color:#fff;font-weight:bold">output</span> <span style="color:#fff;font-weight:bold">wire</span> [ WIDTH - <span style="color:#ff0;font-weight:bold">1</span>: <span style="color:#ff0;font-weight:bold">0</span>] dout
);
	<span style="color:#fff;font-weight:bold">reg</span> [WIDTH-<span style="color:#ff0;font-weight:bold">1</span>:<span style="color:#ff0;font-weight:bold">0</span>] mem [ <span style="color:#ff0;font-weight:bold">100</span> : <span style="color:#ff0;font-weight:bold">0</span>]; 

	<span style="color:#fff;font-weight:bold">assign</span> dout = mem[addr]; 


	<span style="color:#fff;font-weight:bold">always</span> @(<span style="color:#fff;font-weight:bold">posedge</span> clk) 	<span style="color:#fff;font-weight:bold">begin</span>
		<span style="color:#fff;font-weight:bold">if</span> (we) <span style="color:#fff;font-weight:bold">begin</span>
			<span style="color:#fff;font-weight:bold">$display</span>(<span style="color:#0ff;font-weight:bold">&#34;%t Writing ram[0x%0x]=0x%0x&#34;</span>, <span style="color:#fff;font-weight:bold">$time</span>, addr, din);
			mem[addr] = din;
		<span style="color:#fff;font-weight:bold">end</span>
	<span style="color:#fff;font-weight:bold">end</span>
<span style="color:#fff;font-weight:bold">endmodule</span>
</code></pre></div><ul>
<li>ROM</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-verilog" data-lang="verilog">
<span style="color:#fff;font-weight:bold">module</span> rom #(<span style="color:#fff;font-weight:bold">parameter</span> WIDTH=<span style="color:#ff0;font-weight:bold">32</span>, <span style="color:#fff;font-weight:bold">parameter</span> ADDR=<span style="color:#ff0;font-weight:bold">32</span>) (
    <span style="color:#fff;font-weight:bold">input</span>  <span style="color:#fff;font-weight:bold">wire</span> [ADDR  - <span style="color:#ff0;font-weight:bold">1</span> : <span style="color:#ff0;font-weight:bold">0</span>] addr,
    <span style="color:#fff;font-weight:bold">output</span> <span style="color:#fff;font-weight:bold">wire</span> [WIDTH - <span style="color:#ff0;font-weight:bold">1</span> : <span style="color:#ff0;font-weight:bold">0</span>] dout
);

	<span style="color:#fff;font-weight:bold">reg</span> [WIDTH-<span style="color:#ff0;font-weight:bold">1</span>:<span style="color:#ff0;font-weight:bold">0</span>] mem [ <span style="color:#ff0;font-weight:bold">100</span> : <span style="color:#ff0;font-weight:bold">0</span>];

	<span style="color:#fff;font-weight:bold">assign</span> dout = mem[addr]; 
<span style="color:#fff;font-weight:bold">endmodule</span>
</code></pre></div><ul>
<li>Register file</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-verilog" data-lang="verilog"><span style="color:#fff;font-weight:bold">module</span> regfile#(<span style="color:#fff;font-weight:bold">parameter</span> WIDTH=<span style="color:#ff0;font-weight:bold">32</span>) (
	<span style="color:#fff;font-weight:bold">input</span> clk,
	<span style="color:#fff;font-weight:bold">input</span> [<span style="color:#ff0;font-weight:bold">4</span>:<span style="color:#ff0;font-weight:bold">0</span>] addr1,
	<span style="color:#fff;font-weight:bold">output</span> [<span style="color:#ff0;font-weight:bold">31</span>:<span style="color:#ff0;font-weight:bold">0</span>] dout1,
	
	<span style="color:#fff;font-weight:bold">input</span> [<span style="color:#ff0;font-weight:bold">4</span>:<span style="color:#ff0;font-weight:bold">0</span>] addr2,
	<span style="color:#fff;font-weight:bold">output</span> [<span style="color:#ff0;font-weight:bold">31</span>:<span style="color:#ff0;font-weight:bold">0</span>] dout2,

	<span style="color:#fff;font-weight:bold">input</span> [<span style="color:#ff0;font-weight:bold">4</span>:<span style="color:#ff0;font-weight:bold">0</span>] addr3,
	<span style="color:#fff;font-weight:bold">input</span> [<span style="color:#ff0;font-weight:bold">31</span>:<span style="color:#ff0;font-weight:bold">0</span>] din3,
	<span style="color:#fff;font-weight:bold">input</span> we3
);
	<span style="color:#fff;font-weight:bold">reg</span> [WIDTH-<span style="color:#ff0;font-weight:bold">1</span>:<span style="color:#ff0;font-weight:bold">0</span>] mem [<span style="color:#ff0;font-weight:bold">0</span>:<span style="color:#ff0;font-weight:bold">31</span>] ;
	
	<span style="color:#007f7f">// x0 is zero
</span><span style="color:#007f7f"></span>	<span style="color:#fff;font-weight:bold">assign</span> dout1 = addr1 == <span style="color:#ff0;font-weight:bold">0</span> ? <span style="color:#ff0;font-weight:bold">5</span><span style="color:#ff0;font-weight:bold">&#39;b00000</span>: mem[addr1];
	<span style="color:#fff;font-weight:bold">assign</span> dout2 = addr2 == <span style="color:#ff0;font-weight:bold">0</span> ? <span style="color:#ff0;font-weight:bold">5</span><span style="color:#ff0;font-weight:bold">&#39;b00000</span>: mem[addr2];

	<span style="color:#fff;font-weight:bold">always</span> @(<span style="color:#fff;font-weight:bold">posedge</span> clk) <span style="color:#fff;font-weight:bold">begin</span>
		<span style="color:#007f7f">// Don&#39;t write to x0
</span><span style="color:#007f7f"></span>		<span style="color:#fff;font-weight:bold">if</span> (we3 &amp;&amp; (addr3 != <span style="color:#ff0;font-weight:bold">5</span><span style="color:#ff0;font-weight:bold">&#39;b00000</span>)) <span style="color:#fff;font-weight:bold">begin</span>
			<span style="color:#fff;font-weight:bold">$display</span>(<span style="color:#0ff;font-weight:bold">&#34;%t Writing regfile[%0d]=0x%0x&#34;</span>, <span style="color:#fff;font-weight:bold">$time</span>, addr3, din3);
			mem[addr3] &lt;= din3;
		<span style="color:#fff;font-weight:bold">end</span>
	<span style="color:#fff;font-weight:bold">end</span>

<span style="color:#fff;font-weight:bold">endmodule</span>
</code></pre></div><ul>
<li>ALU(add only)</li>
</ul>
<h1 id="data-path-and-control-unit">
  Data-path and control unit
  <a class="heading-link" href="#data-path-and-control-unit">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h1>
<p>I started with <code>LW</code> datapath then control to pipe-clean the connection all the way to memory and back to regfile and I used the usual stages:</p>
<ul>
<li>Fetch</li>
<li>Decode</li>
<li>Execute</li>
<li>Write-back</li>
</ul>
<p><code>LW</code> and <code>SW</code> follow similar format except the immediate. So, Decoding was not that hard</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-verilog" data-lang="verilog">        <span style="color:#fff;font-weight:bold">assign</span> opcode   = instr[`OP_RANGE];
        <span style="color:#fff;font-weight:bold">assign</span> funct3   = instr[`FUNCT3_RANGE];
        <span style="color:#fff;font-weight:bold">assign</span> rf1              = instr[`RS1_RANGE];
        <span style="color:#fff;font-weight:bold">assign</span> rf2              = instr[`RS2_RANGE];
        <span style="color:#fff;font-weight:bold">assign</span> rf3              = instr[`RD_RANGE];
        <span style="color:#fff;font-weight:bold">assign</span> imm11_0 = (imm_mux == <span style="color:#ff0;font-weight:bold">0</span> )? instr[`IMM_11_0_RANGE] : {instr[<span style="color:#ff0;font-weight:bold">31</span>:<span style="color:#ff0;font-weight:bold">25</span>], instr[<span style="color:#ff0;font-weight:bold">11</span>:<span style="color:#ff0;font-weight:bold">7</span>]};
</code></pre></div><p>And control unit is not complicated as well.</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-verilog" data-lang="verilog">       <span style="color:#fff;font-weight:bold">case</span> (opcode)
                        <span style="color:#ff0;font-weight:bold">7</span><span style="color:#ff0;font-weight:bold">&#39;b0000011</span> :
                                <span style="color:#fff;font-weight:bold">case</span> (funct3)
                                <span style="color:#ff0;font-weight:bold">3</span><span style="color:#ff0;font-weight:bold">&#39;b010</span> : <span style="color:#007f7f">// LW
</span><span style="color:#007f7f"></span>                                        <span style="color:#fff;font-weight:bold">begin</span>
                                                rf3_we_control  &lt;= <span style="color:#ff0;font-weight:bold">1</span>;
                                                alu_control     &lt;= <span style="color:#ff0;font-weight:bold">0</span>;
                                                mem_we                  &lt;= <span style="color:#ff0;font-weight:bold">0</span>;
                                                imm_mux                 &lt;= <span style="color:#ff0;font-weight:bold">0</span>;
                                        <span style="color:#fff;font-weight:bold">end</span>
                                <span style="color:#fff;font-weight:bold">endcase</span>

                        <span style="color:#ff0;font-weight:bold">7</span><span style="color:#ff0;font-weight:bold">&#39;b0100011</span> :
                                <span style="color:#fff;font-weight:bold">case</span> (funct3)
                                <span style="color:#ff0;font-weight:bold">3</span><span style="color:#ff0;font-weight:bold">&#39;b010</span> : <span style="color:#007f7f">//SW
</span><span style="color:#007f7f"></span>                                        <span style="color:#fff;font-weight:bold">begin</span>
                                                rf3_we_control  &lt;= <span style="color:#ff0;font-weight:bold">0</span>;
                                                alu_control     &lt;= <span style="color:#ff0;font-weight:bold">0</span>;
                                                mem_we                  &lt;= <span style="color:#ff0;font-weight:bold">1</span>;
                                                imm_mux                 &lt;= <span style="color:#ff0;font-weight:bold">1</span>;
                                        <span style="color:#fff;font-weight:bold">end</span>
                                <span style="color:#fff;font-weight:bold">endcase</span>
                        <span style="color:#fff;font-weight:bold">endcase</span>
                <span style="color:#fff;font-weight:bold">end</span>
        <span style="color:#fff;font-weight:bold">end</span>

</code></pre></div><p>I used machine code from previous post. Hopefully I can complete the simple assembler to generate hex myself. For now, I used the following two instruction:</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"> fe042623                sw      zero,-20(s0)
 fec42783                lw      a5,-20(s0)
</code></pre></div><p>And it works! Kinda!</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">                  <span style="color:#ff0;font-weight:bold">25</span> Writing ram[0xa]=0x0
                  <span style="color:#ff0;font-weight:bold">35</span> Writing regfile[15]=0x0
</code></pre></div><p>and mandatory gtkwave pic</p>
<p><img src="/rv5_gtkwave.png" alt="Example image"></p>
<h1 id="gotchas">
  Gotchas
  <a class="heading-link" href="#gotchas">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h1>
<p><strong>Issue 1</strong> iverilog doesn&rsquo;t play nice with multi-dim arrays(ie memories)</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-verilog" data-lang="verilog">`ifdef SIM
<span style="color:#fff;font-weight:bold">generate</span>
  <span style="color:#fff;font-weight:bold">genvar</span> idx;
  <span style="color:#fff;font-weight:bold">for</span>(idx = <span style="color:#ff0;font-weight:bold">0</span>; idx &lt; <span style="color:#ff0;font-weight:bold">32</span>; idx = idx+<span style="color:#ff0;font-weight:bold">1</span>) <span style="color:#fff;font-weight:bold">begin</span>: x
    <span style="color:#fff;font-weight:bold">wire</span> [<span style="color:#ff0;font-weight:bold">31</span>:<span style="color:#ff0;font-weight:bold">0</span>] tmp;
    <span style="color:#fff;font-weight:bold">assign</span> tmp = mem[idx];
  <span style="color:#fff;font-weight:bold">end</span>
<span style="color:#fff;font-weight:bold">endgenerate</span>
`endif
</code></pre></div><p><strong>Issue 2</strong> Reset to control unit
as i start the PC at 0, after reset the first instruction is executed twice until the PC changes to next instruction.
The solution(Hacky as hell), feed reset to control unit and keep default control signals to prevent regfile or memory write in reset.</p>
<p>[1] <a href="https://www.amazon.co.uk/Digital-Design-Computer-Architecture-2012-12-25/dp/B01MZ3QSGK/ref=sr_1_2?crid=1XTIG8ZPN6M62&amp;keywords=digital-Design-Computer-Architecture-Harris&amp;qid=1641236355&amp;sprefix=digital-design-computer-architecture-harris%2Caps%2C423&amp;sr=8-2"  class="external-link" target="_blank" rel="noopener">https://www.amazon.co.uk/Digital-Design-Computer-Architecture-2012-12-25/dp/B01MZ3QSGK/ref=sr_1_2?crid=1XTIG8ZPN6M62&keywords=digital-Design-Computer-Architecture-Harris&qid=1641236355&sprefix=digital-design-computer-architecture-harris%2Caps%2C423&sr=8-2</a></p>
<p>[2] RISCV specs</p>

      </div>


      <footer>
        


        
        
        
        
        

        
      </footer>
    </article>

    
  </section>

    </div>

    <footer class="footer">
  <section class="container">
    ©
    
    2024
    
    ·
    
      Licensed under <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">CC BY-SA-4.0</a>
    ·
    
    Powered by <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> & <a href="https://github.com/luizdepra/hugo-coder/" target="_blank" rel="noopener">Coder</a>.
    
  </section>
</footer>

  </main>

  

  
  
  <script src="/js/coder.min.369d90111ae4409b4e51de5efd23a46b92663fcc82dc9a0efde7f70bffc3f949.js" integrity="sha256-Np2QERrkQJtOUd5e/SOka5JmP8yC3JoO/ef3C//D&#43;Uk="></script>
  

  

  


  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  
</body>

</html>
