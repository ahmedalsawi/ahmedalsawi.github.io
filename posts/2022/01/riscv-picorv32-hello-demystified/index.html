<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="author" content="">
<meta name="description" content="This is a post about hello test in piscorv32. I am not going to dig deep into picorv32 itself. Just the firmware.
Where to start As usual, It makes sense to start with Makefile and work backward.
make -n test After removing verilog related commands and tests, We have the following commands for the firmware.
/opt/riscv32i/bin/riscv32-unknown-elf-gcc -c -mabi=ilp32 -march=rv32imc -o firmware/start.o firmware/start.S /opt/riscv32i/bin/riscv32-unknown-elf-gcc -c -mabi=ilp32 -march=rv32ic -Os --std=c99 -Werror -Wall -Wextra -Wshadow -Wundef -Wpointer-arith -Wcast-qual -Wcast-align -Wwrite-strings -Wredundant-decls -Wstrict-prototypes -Wmissing-prototypes -pedantic -ffreestanding -nostdlib -o firmware/irq." />
<meta name="keywords" content=", riscv, embedded, picorv32" />
<meta name="robots" content="noodp" />
<meta name="theme-color" content="" />
<link rel="canonical" href="/posts/2022/01/riscv-picorv32-hello-demystified/" />


    <title>
        
            riscv picorv32 hello demystified :: Techiedeepdive 
        
    </title>



<link href="https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.5.0/css/flag-icon.min.css" rel="stylesheet"
    type="text/css">



<link rel="stylesheet" href="/main.de188b3201233c251f4fd6306dbd2cb41e408fb8846c09781b2925de7df5025c.css">






<meta itemprop="name" content="riscv picorv32 hello demystified">
<meta itemprop="description" content="This is a post about hello test in piscorv32. I am not going to dig deep into picorv32 itself. Just the firmware.
Where to start As usual, It makes sense to start with Makefile and work backward.
make -n test After removing verilog related commands and tests, We have the following commands for the firmware.
/opt/riscv32i/bin/riscv32-unknown-elf-gcc -c -mabi=ilp32 -march=rv32imc -o firmware/start.o firmware/start.S /opt/riscv32i/bin/riscv32-unknown-elf-gcc -c -mabi=ilp32 -march=rv32ic -Os --std=c99 -Werror -Wall -Wextra -Wshadow -Wundef -Wpointer-arith -Wcast-qual -Wcast-align -Wwrite-strings -Wredundant-decls -Wstrict-prototypes -Wmissing-prototypes -pedantic -ffreestanding -nostdlib -o firmware/irq."><meta itemprop="datePublished" content="2022-01-14T00:00:00+00:00" />
<meta itemprop="dateModified" content="2022-01-14T00:00:00+00:00" />
<meta itemprop="wordCount" content="995"><meta itemprop="image" content=""/>
<meta itemprop="keywords" content="riscv,embedded,picorv32," />
<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content=""/>

<meta name="twitter:title" content="riscv picorv32 hello demystified"/>
<meta name="twitter:description" content="This is a post about hello test in piscorv32. I am not going to dig deep into picorv32 itself. Just the firmware.
Where to start As usual, It makes sense to start with Makefile and work backward.
make -n test After removing verilog related commands and tests, We have the following commands for the firmware.
/opt/riscv32i/bin/riscv32-unknown-elf-gcc -c -mabi=ilp32 -march=rv32imc -o firmware/start.o firmware/start.S /opt/riscv32i/bin/riscv32-unknown-elf-gcc -c -mabi=ilp32 -march=rv32ic -Os --std=c99 -Werror -Wall -Wextra -Wshadow -Wundef -Wpointer-arith -Wcast-qual -Wcast-align -Wwrite-strings -Wredundant-decls -Wstrict-prototypes -Wmissing-prototypes -pedantic -ffreestanding -nostdlib -o firmware/irq."/>




    <meta property="og:title" content="riscv picorv32 hello demystified" />
<meta property="og:description" content="This is a post about hello test in piscorv32. I am not going to dig deep into picorv32 itself. Just the firmware.
Where to start As usual, It makes sense to start with Makefile and work backward.
make -n test After removing verilog related commands and tests, We have the following commands for the firmware.
/opt/riscv32i/bin/riscv32-unknown-elf-gcc -c -mabi=ilp32 -march=rv32imc -o firmware/start.o firmware/start.S /opt/riscv32i/bin/riscv32-unknown-elf-gcc -c -mabi=ilp32 -march=rv32ic -Os --std=c99 -Werror -Wall -Wextra -Wshadow -Wundef -Wpointer-arith -Wcast-qual -Wcast-align -Wwrite-strings -Wredundant-decls -Wstrict-prototypes -Wmissing-prototypes -pedantic -ffreestanding -nostdlib -o firmware/irq." />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/2022/01/riscv-picorv32-hello-demystified/" /><meta property="og:image" content=""/><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-01-14T00:00:00+00:00" />
<meta property="article:modified_time" content="2022-01-14T00:00:00+00:00" /><meta property="og:site_name" content="Techiedeepdive" />







    <meta property="article:published_time" content="2022-01-14 00:00:00 &#43;0000 UTC" />








    </head>

    
        <body>
    
    
        <div class="container">
            <header class="header">
    <span class="header__inner">
        <a href="/" style="text-decoration: none;">
    <div class="logo">
        
            <span class="logo__mark">></span>
            <span class="logo__text">$ cd /home/</span>
            <span class="logo__cursor" style=
                  "
                   
                   ">
            </span>
        
    </div>
</a>


        <span class="header__right">
            
                <nav class="menu">
    <ul class="menu__inner"><li><a href="/about/">About</a></li><li><a href="/posts">Blog</a></li><li><a href="/reading-list/">Reading list</a></li>
    </ul>
</nav>

                <span class="menu-trigger">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path d="M0 0h24v24H0z" fill="none"/>
                        <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
                    </svg>
                </span>
            
        </span>
    </span>
</header>


            <div class="content">
                
  <main class="post">

    <div class="post-info">
      <p>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock">
          <circle cx="12" cy="12" r="10"></circle>
          <polyline points="12 6 12 12 16 14"></polyline>
        </svg>
        5 minutes

        
      </p>
    </div>

    <article>
      <h1 class="post-title">
        <a href="/posts/2022/01/riscv-picorv32-hello-demystified/">riscv picorv32 hello demystified</a>
      </h1>

      

      

      <div class="post-content">
        <p>This is a post about hello test in <a href="https://github.com/YosysHQ/picorv32">piscorv32</a>. I am not going to dig deep into picorv32 itself. Just the firmware.</p>
<h1 id="where-to-start">Where to start</h1>
<p>As usual, It makes sense to start with <code>Makefile</code> and work backward.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">make -n test
</code></pre></div><p>After removing verilog related commands and tests, We have the following commands for the firmware.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">/opt/riscv32i/bin/riscv32-unknown-elf-gcc -c -mabi<span style="color:#f92672">=</span>ilp32 -march<span style="color:#f92672">=</span>rv32imc -o firmware/start.o firmware/start.S

/opt/riscv32i/bin/riscv32-unknown-elf-gcc -c -mabi<span style="color:#f92672">=</span>ilp32 -march<span style="color:#f92672">=</span>rv32ic -Os --std<span style="color:#f92672">=</span>c99 -Werror -Wall -Wextra -Wshadow -Wundef -Wpointer-arith -Wcast-qual -Wcast-align -Wwrite-strings -Wredundant-decls -Wstrict-prototypes -Wmissing-prototypes -pedantic  -ffreestanding -nostdlib -o firmware/irq.o firmware/irq.c
/opt/riscv32i/bin/riscv32-unknown-elf-gcc -c -mabi<span style="color:#f92672">=</span>ilp32 -march<span style="color:#f92672">=</span>rv32ic -Os --std<span style="color:#f92672">=</span>c99 -Werror -Wall -Wextra -Wshadow -Wundef -Wpointer-arith -Wcast-qual -Wcast-align -Wwrite-strings -Wredundant-decls -Wstrict-prototypes -Wmissing-prototypes -pedantic  -ffreestanding -nostdlib -o firmware/print.o firmware/print.c
/opt/riscv32i/bin/riscv32-unknown-elf-gcc -c -mabi<span style="color:#f92672">=</span>ilp32 -march<span style="color:#f92672">=</span>rv32ic -Os --std<span style="color:#f92672">=</span>c99 -Werror -Wall -Wextra -Wshadow -Wundef -Wpointer-arith -Wcast-qual -Wcast-align -Wwrite-strings -Wredundant-decls -Wstrict-prototypes -Wmissing-prototypes -pedantic  -ffreestanding -nostdlib -o firmware/hello.o firmware/hello.c
/opt/riscv32i/bin/riscv32-unknown-elf-gcc -c -mabi<span style="color:#f92672">=</span>ilp32 -march<span style="color:#f92672">=</span>rv32ic -Os --std<span style="color:#f92672">=</span>c99 -Werror -Wall -Wextra -Wshadow -Wundef -Wpointer-arith -Wcast-qual -Wcast-align -Wwrite-strings -Wredundant-decls -Wstrict-prototypes -Wmissing-prototypes -pedantic  -ffreestanding -nostdlib -o firmware/sieve.o firmware/sieve.c
/opt/riscv32i/bin/riscv32-unknown-elf-gcc -c -mabi<span style="color:#f92672">=</span>ilp32 -march<span style="color:#f92672">=</span>rv32ic -Os --std<span style="color:#f92672">=</span>c99 -Werror -Wall -Wextra -Wshadow -Wundef -Wpointer-arith -Wcast-qual -Wcast-align -Wwrite-strings -Wredundant-decls -Wstrict-prototypes -Wmissing-prototypes -pedantic  -ffreestanding -nostdlib -o firmware/multest.o firmware/multest.c
/opt/riscv32i/bin/riscv32-unknown-elf-gcc -c -mabi<span style="color:#f92672">=</span>ilp32 -march<span style="color:#f92672">=</span>rv32ic -Os --std<span style="color:#f92672">=</span>c99 -Werror -Wall -Wextra -Wshadow -Wundef -Wpointer-arith -Wcast-qual -Wcast-align -Wwrite-strings -Wredundant-decls -Wstrict-prototypes -Wmissing-prototypes -pedantic  -ffreestanding -nostdlib -o firmware/stats.o firmware/stats.c

/opt/riscv32i/bin/riscv32-unknown-elf-gcc -Os -mabi<span style="color:#f92672">=</span>ilp32 -march<span style="color:#f92672">=</span>rv32imc -ffreestanding -nostdlib -o firmware/firmware.elf <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>	-Wl,--build-id<span style="color:#f92672">=</span>none,-Bstatic,-T,firmware/sections.lds,-Map,firmware/firmware.map,--strip-debug <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>	firmware/start.o firmware/irq.o firmware/print.o firmware/hello.o firmware/sieve.o firmware/multest.o firmware/stats.o -lgcc

/opt/riscv32i/bin/riscv32-unknown-elf-objcopy -O binary firmware/firmware.elf firmware/firmware.bin

python3 firmware/makehex.py firmware/firmware.bin <span style="color:#ae81ff">32768</span> &gt; firmware/firmware.hex
</code></pre></div><h1 id="startup-assembly">Startup assembly</h1>
<p>Probably the most important part(beside linking):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">/opt/riscv32i/bin/riscv32-unknown-elf-gcc -c -mabi<span style="color:#f92672">=</span>ilp32 -march<span style="color:#f92672">=</span>rv32imc -o firmware/start.o firmware/start.S
</code></pre></div><h2 id="reset-vector">Reset Vector</h2>
<p>At the start of file <code>start.S</code>, <code>reseet_vector</code> label defines two instructions(2 * 4 Bytes), Then jumps to <code>start</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-asm" data-lang="asm">reset_vec:
        <span style="color:#960050;background-color:#1e0010">//</span> <span style="color:#a6e22e">no</span> <span style="color:#66d9ef">more</span> <span style="color:#66d9ef">than</span> <span style="color:#ae81ff">16</span> <span style="color:#66d9ef">bytes</span> <span style="color:#66d9ef">here</span> !
        <span style="color:#a6e22e">picorv32_waitirq_insn</span>(<span style="color:#66d9ef">zero</span>)
        <span style="color:#a6e22e">picorv32_maskirq_insn</span>(<span style="color:#66d9ef">zero</span>, <span style="color:#66d9ef">zero</span>)
        <span style="color:#a6e22e">j</span> <span style="color:#66d9ef">start</span>
</code></pre></div><p>The macros eventually expand to <code>.word</code> (which is 4  bytes). It literally stitch parts of the instruction together.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-asm" data-lang="asm"><span style="color:#75715e">#define r_type_insn(_f7, _rs2, _rs1, _f3, _rd, _opc) \
</span><span style="color:#75715e"></span><span style="color:#a6e22e">.word</span> (((<span style="color:#66d9ef">_f7</span>) <span style="color:#960050;background-color:#1e0010">&lt;&lt;</span> <span style="color:#ae81ff">25</span>) <span style="color:#960050;background-color:#1e0010">|</span> ((<span style="color:#66d9ef">_rs2</span>) <span style="color:#960050;background-color:#1e0010">&lt;&lt;</span> <span style="color:#ae81ff">20</span>) <span style="color:#960050;background-color:#1e0010">|</span> ((<span style="color:#66d9ef">_rs1</span>) <span style="color:#960050;background-color:#1e0010">&lt;&lt;</span> <span style="color:#ae81ff">15</span>) <span style="color:#960050;background-color:#1e0010">|</span> ((<span style="color:#66d9ef">_f3</span>) <span style="color:#960050;background-color:#1e0010">&lt;&lt;</span> <span style="color:#ae81ff">12</span>) <span style="color:#960050;background-color:#1e0010">|</span> ((<span style="color:#66d9ef">_rd</span>) <span style="color:#960050;background-color:#1e0010">&lt;&lt;</span> <span style="color:#ae81ff">7</span>) <span style="color:#960050;background-color:#1e0010">|</span> ((<span style="color:#66d9ef">_opc</span>) <span style="color:#960050;background-color:#1e0010">&lt;&lt;</span> <span style="color:#ae81ff">0</span>))

<span style="color:#75715e">#define picorv32_retirq_insn() \
</span><span style="color:#75715e"></span><span style="color:#a6e22e">r_type_insn</span>(<span style="color:#ae81ff">0</span><span style="color:#66d9ef">b0000010</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span><span style="color:#66d9ef">b000</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span><span style="color:#66d9ef">b0001011</span>)

<span style="color:#75715e">#define picorv32_maskirq_insn(_rd, _rs) \
</span><span style="color:#75715e"></span><span style="color:#a6e22e">r_type_insn</span>(<span style="color:#ae81ff">0</span><span style="color:#66d9ef">b0000011</span>, <span style="color:#ae81ff">0</span>, <span style="color:#66d9ef">regnum_</span> <span style="color:#75715e">## _rs, 0b110, regnum_ ## _rd, 0b0001011)
</span></code></pre></div><h2 id="start-routine">Start routine</h2>
<p><code>start</code> zeros out GPRs.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-asm" data-lang="asm">start:
        <span style="color:#960050;background-color:#1e0010">/*</span> <span style="color:#a6e22e">zero-initialize</span> <span style="color:#66d9ef">all</span> <span style="color:#66d9ef">registers</span> *<span style="color:#960050;background-color:#1e0010">/</span>

        <span style="color:#a6e22e">addi</span> <span style="color:#66d9ef">x1</span>, <span style="color:#66d9ef">zero</span>, <span style="color:#ae81ff">0</span>
        <span style="color:#a6e22e">addi</span> <span style="color:#66d9ef">x2</span>, <span style="color:#66d9ef">zero</span>, <span style="color:#ae81ff">0</span>
        <span style="color:#a6e22e">addi</span> <span style="color:#66d9ef">x3</span>, <span style="color:#66d9ef">zero</span>, <span style="color:#ae81ff">0</span>
        <span style="color:#a6e22e">addi</span> <span style="color:#66d9ef">x4</span>, <span style="color:#66d9ef">zero</span>, <span style="color:#ae81ff">0</span>
<span style="color:#a6e22e">...</span>
<span style="color:#a6e22e">...</span>
</code></pre></div><p>Then initializes the stack pointer to <code>0x20000</code> as <code>lui</code> does the following</p>
<blockquote>
<p>LUI (load upper immediate) uses the same opcode as RV32I. LUI places the 20-bit U-immediate into bits 31–12 of register rd and places zero in the lowest 12 bits.</p>
</blockquote>
<p>so, <code>sp</code> will have <code>hex(128*1024) = 0x20000</code> which is the end of  the address space.</p>
<p>Then calls one of the test functions</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-asm" data-lang="asm"><span style="color:#75715e">#ifdef ENABLE_HELLO
</span><span style="color:#75715e"></span>        <span style="color:#960050;background-color:#1e0010">/*</span> <span style="color:#a6e22e">set</span> <span style="color:#66d9ef">stack</span> <span style="color:#66d9ef">pointer</span> *<span style="color:#960050;background-color:#1e0010">/</span>
        <span style="color:#a6e22e">lui</span> <span style="color:#66d9ef">sp</span>,(<span style="color:#ae81ff">128</span>*<span style="color:#ae81ff">1024</span>)<span style="color:#960050;background-color:#1e0010">&gt;&gt;</span><span style="color:#ae81ff">12</span>

        <span style="color:#960050;background-color:#1e0010">/*</span> <span style="color:#a6e22e">call</span> <span style="color:#66d9ef">hello</span> <span style="color:#66d9ef">C</span> <span style="color:#66d9ef">code</span> *<span style="color:#960050;background-color:#1e0010">/</span>
        <span style="color:#a6e22e">jal</span> <span style="color:#66d9ef">ra</span>,<span style="color:#66d9ef">hello</span>
<span style="color:#75715e">#endif
</span></code></pre></div><h1 id="hello-example">hello example</h1>
<h2 id="software">Software</h2>
<p>For the sake of this post, the important files are <code>hello.c</code> and <code>print.c</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">/opt/riscv32i/bin/riscv32-unknown-elf-gcc -c -mabi<span style="color:#f92672">=</span>ilp32 -march<span style="color:#f92672">=</span>rv32ic -Os --std<span style="color:#f92672">=</span>c99 -Werror -Wall -Wextra -Wshadow -Wundef -Wpointer-arith -Wcast-qual -Wcast-align -Wwrite-strings -Wredundant-decls -Wstrict-prototypes -Wmissing-prototypes -pedantic  -ffreestanding -nostdlib -o firmware/print.o firmware/print.c
/opt/riscv32i/bin/riscv32-unknown-elf-gcc -c -mabi<span style="color:#f92672">=</span>ilp32 -march<span style="color:#f92672">=</span>rv32ic -Os --std<span style="color:#f92672">=</span>c99 -Werror -Wall -Wextra -Wshadow -Wundef -Wpointer-arith -Wcast-qual -Wcast-align -Wwrite-strings -Wredundant-decls -Wstrict-prototypes -Wmissing-prototypes -pedantic  -ffreestanding -nostdlib -o firmware/hello.o firmware/hello.c
</code></pre></div><p>From <code>print.c</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">hello</span>(<span style="color:#66d9ef">void</span>)
{
        print_str(<span style="color:#e6db74">&#34;hello world</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
}
</code></pre></div><p><code>print_str</code> is a loop to write to address <code>0x10000000</code> which should map to something(will see on <code>testbench.v</code>)</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#define OUTPORT 0x10000000
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">print_chr</span>(<span style="color:#66d9ef">char</span> ch)
{
        <span style="color:#f92672">*</span>((<span style="color:#66d9ef">volatile</span> <span style="color:#66d9ef">uint32_t</span><span style="color:#f92672">*</span>)OUTPORT) <span style="color:#f92672">=</span> ch;
}

<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">print_str</span>(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>p)
{
        <span style="color:#66d9ef">while</span> (<span style="color:#f92672">*</span>p <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>)
                <span style="color:#f92672">*</span>((<span style="color:#66d9ef">volatile</span> <span style="color:#66d9ef">uint32_t</span><span style="color:#f92672">*</span>)OUTPORT) <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>(p<span style="color:#f92672">++</span>);
}
</code></pre></div><p>And the assembly generated by GCC</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-asm" data-lang="asm"><span style="color:#960050;background-color:#1e0010">00000008</span> <span style="color:#960050;background-color:#1e0010">&lt;</span><span style="color:#a6e22e">print_str</span><span style="color:#960050;background-color:#1e0010">&gt;</span>:
   <span style="color:#960050;background-color:#1e0010">8:</span>   <span style="color:#960050;background-color:#1e0010">10000737</span>                <span style="color:#a6e22e">lui</span>     <span style="color:#66d9ef">a4</span>,<span style="color:#ae81ff">0x10000</span>

<span style="color:#960050;background-color:#1e0010">0000000</span><span style="color:#a6e22e">c</span> <span style="color:#960050;background-color:#1e0010">&lt;</span><span style="color:#66d9ef">.L3</span><span style="color:#960050;background-color:#1e0010">&gt;</span>:
   c:   <span style="color:#960050;background-color:#1e0010">00054783</span>                <span style="color:#a6e22e">lbu</span>     <span style="color:#66d9ef">a5</span>,<span style="color:#ae81ff">0</span>(<span style="color:#66d9ef">a0</span>)
  <span style="color:#960050;background-color:#1e0010">10:</span>   <span style="color:#a6e22e">e391</span>                    <span style="color:#66d9ef">bnez</span>    <span style="color:#66d9ef">a5</span>,<span style="color:#ae81ff">14</span> &lt;<span style="color:#66d9ef">.L4</span>&gt;
  <span style="color:#960050;background-color:#1e0010">12:</span>   <span style="color:#960050;background-color:#1e0010">8082</span>                    <span style="color:#a6e22e">ret</span>

<span style="color:#960050;background-color:#1e0010">00000014</span> <span style="color:#960050;background-color:#1e0010">&lt;</span><span style="color:#a6e22e">.L4</span><span style="color:#960050;background-color:#1e0010">&gt;</span>:
  <span style="color:#960050;background-color:#1e0010">14:</span>   <span style="color:#960050;background-color:#1e0010">0505</span>                    <span style="color:#a6e22e">addi</span>    <span style="color:#66d9ef">a0</span>,<span style="color:#66d9ef">a0</span>,<span style="color:#ae81ff">1</span>
  <span style="color:#960050;background-color:#1e0010">16:</span>   <span style="color:#a6e22e">c31c</span>                    <span style="color:#66d9ef">sw</span>      <span style="color:#66d9ef">a5</span>,<span style="color:#ae81ff">0</span>(<span style="color:#66d9ef">a4</span>)
  <span style="color:#960050;background-color:#1e0010">18:</span>   <span style="color:#a6e22e">bfd5</span>                    <span style="color:#66d9ef">j</span>       <span style="color:#ae81ff">c</span> &lt;<span style="color:#66d9ef">.L3</span>&gt;

</code></pre></div><h2 id="hardware">Hardware</h2>
<p>From Hardware side, address <code>0x10000000</code> should map to address space allocated for uart but for simulation, <code>testbench.v</code> just <code>$display</code> the characters.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-verilog" data-lang="verilog">                <span style="color:#66d9ef">if</span> (latched_waddr <span style="color:#f92672">==</span> <span style="color:#ae81ff">32&#39;h1000</span>_0000) <span style="color:#66d9ef">begin</span>
                        <span style="color:#66d9ef">if</span> (verbose) <span style="color:#66d9ef">begin</span>
                                <span style="color:#66d9ef">if</span> (<span style="color:#ae81ff">32</span> <span style="color:#f92672">&lt;=</span> latched_wdata <span style="color:#f92672">&amp;&amp;</span> latched_wdata <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">128</span>)
                                        $display(<span style="color:#e6db74">&#34;OUT: &#39;%c&#39;&#34;</span>, latched_wdata[<span style="color:#ae81ff">7</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>]);
                                <span style="color:#66d9ef">else</span>
                                        $display(<span style="color:#e6db74">&#34;OUT: %3d&#34;</span>, latched_wdata);
                        <span style="color:#66d9ef">end</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">begin</span>
                                $write(<span style="color:#e6db74">&#34;%c&#34;</span>, latched_wdata[<span style="color:#ae81ff">7</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>]);
<span style="color:#66d9ef">`ifndef</span> VERILATOR
                                $fflush();
<span style="color:#66d9ef">`endif</span>
                        <span style="color:#66d9ef">end</span>
                <span style="color:#66d9ef">end</span> <span style="color:#66d9ef">else</span>
</code></pre></div><h1 id="linking">Linking</h1>
<p>There are several things to unpack in the linker command</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">/opt/riscv32i/bin/riscv32-unknown-elf-gcc -Os -mabi<span style="color:#f92672">=</span>ilp32 -march<span style="color:#f92672">=</span>rv32imc -ffreestanding -nostdlib -o firmware/firmware.elf <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>	-Wl,--build-id<span style="color:#f92672">=</span>none,-Bstatic,-T,firmware/sections.lds,-Map,firmware/firmware.map,--strip-debug <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>	firmware/start.o firmware/irq.o firmware/print.o firmware/hello.o firmware/sieve.o firmware/multest.o firmware/stats.o -lgcc
</code></pre></div><h2 id="options">Options</h2>
<p><strong><code>-ffreestanding</code></strong>
This one is important as we don&rsquo;t have libc here. So, we have to tell gcc that. from <a href="https://stackoverflow.com/questions/17692428/what-is-ffreestanding-option-in-gcc">Stack overflow</a></p>
<blockquote>
<p>A freestanding environment is one in which the standard library may not exist, and program startup may not necessarily be at &ldquo;main&rdquo;. The option -ffreestanding directs the compiler to not assume that standard functions have their usual definition.</p>
</blockquote>
<p><strong>-<code>-nostdlib</code></strong>
from <a href="https://gcc.gnu.org/onlinedocs/gcc/Link-Options.html">GCC docs</a></p>
<blockquote>
<p>Do not use the standard system startup files or libraries when linking. No startup files and only the libraries you specify are passed to the linker, and options specifying linkage of the system libraries, such as -static-libgcc or -shared-libgcc, are ignored.</p>
</blockquote>
<h2 id="linker-script">Linker script</h2>
<p><code>sections.lds</code> sets <code>mem</code> to start of <code>0x0</code> and lenght of <code>96k</code>.  Note that sp pointer was init to point to <code>0x20000</code> which 128k. Which leaves 32k for stack. Other than that, typical text and data ELF section mapping.</p>
<pre tabindex="0"><code>MEMORY {
        /* the memory in the testbench is 128k in size;
         * set LENGTH=96k and leave at least 32k for stack */
        mem : ORIGIN = 0x00000000, LENGTH = 0x00018000
}

SECTIONS {
        .memory : {
                . = 0x000000;
                start*(.text);
                *(.text);
                *(*);
                end = .;
                . = ALIGN(4);
        } &gt; mem
}
</code></pre><h1 id="elf-to-bin-conversion">elf to bin Conversion</h1>
<p>That is straightforward <code>objcopy</code> to convert elf to binary</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">/opt/riscv32i/bin/riscv32-unknown-elf-objcopy -O binary firmware/firmware.elf firmware/firmware.bin
</code></pre></div><h1 id="bin-to-hex-conversion">bin to hex Conversion</h1>
<p>The final touch is converting bin file to hex file for <code>$readmemh</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">python3 firmware/makehex.py firmware/firmware.bin <span style="color:#ae81ff">32768</span> &gt; firmware/firmware.hex
</code></pre></div><p>Snippet from <code>makehex.py</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(nwords):
    <span style="color:#66d9ef">if</span> i <span style="color:#f92672">&lt;</span> len(bindata) <span style="color:#f92672">//</span> <span style="color:#ae81ff">4</span>:
        w <span style="color:#f92672">=</span> bindata[<span style="color:#ae81ff">4</span><span style="color:#f92672">*</span>i : <span style="color:#ae81ff">4</span><span style="color:#f92672">*</span>i<span style="color:#f92672">+</span><span style="color:#ae81ff">4</span>]
        print(<span style="color:#e6db74">&#34;</span><span style="color:#e6db74">%02x%02x%02x%02x</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">%</span> (w[<span style="color:#ae81ff">3</span>], w[<span style="color:#ae81ff">2</span>], w[<span style="color:#ae81ff">1</span>], w[<span style="color:#ae81ff">0</span>]))
    <span style="color:#66d9ef">else</span>:
        print(<span style="color:#e6db74">&#34;0&#34;</span>)
</code></pre></div><p>And <code>$readmemh</code> in <code>testbench.v</code> to load the <code>firmware.hex</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-verilog" data-lang="verilog">        <span style="color:#66d9ef">initial</span> <span style="color:#66d9ef">begin</span>
                <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>$value$plusargs(<span style="color:#e6db74">&#34;firmware=%s&#34;</span>, firmware_file))
                        firmware_file <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;firmware/firmware.hex&#34;</span>;
                $readmemh(firmware_file, mem.memory);
        <span style="color:#66d9ef">end</span>
</code></pre></div>
      </div>
    </article>

    <hr />

    <div class="post-info">
      
    <p>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7" y2="7"></line></svg>

        <span class="tag"><a href="tags/riscv/">riscv</a></span>
        <span class="tag"><a href="tags/embedded/">embedded</a></span>
        <span class="tag"><a href="tags/picorv32/">picorv32</a></span>
        
    </p>

      

      <p>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text">
          <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
          <polyline points="14 2 14 8 20 8"></polyline>
          <line x1="16" y1="13" x2="8" y2="13"></line>
          <line x1="16" y1="17" x2="8" y2="17"></line>
          <polyline points="10 9 9 9 8 9"></polyline>
        </svg>
        995 Words
      </p>

      <p>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar">
          <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
          <line x1="16" y1="2" x2="16" y2="6"></line>
          <line x1="8" y1="2" x2="8" y2="6"></line>
          <line x1="3" y1="10" x2="21" y2="10"></line>
        </svg>
        
          2022-01-14 00:00 &#43;0000
        

         
          
        
      </p>
    </div>

    
      <div class="pagination">
        <div class="pagination__title">
          <span class="pagination__title-h">Read other posts</span>
          <hr />
        </div>

        <div class="pagination__buttons">
          
            <span class="button previous">
              <a href="/posts/2022/01/cocotb-internals-cocotb-startup-vpi-bootstrap-to-python/">
                <span class="button__icon">←</span>
                <span class="button__text">Cocotb Internals - Cocotb Startup VPI bootstrap to Python</span>
              </a>
            </span>
          

          
            <span class="button next">
              <a href="/posts/2022/01/riscv-memory-consistency-model-basics/">
                <span class="button__text">RISCV Memory Consistency Model Basics</span>
                <span class="button__icon">→</span>
              </a>
            </span>
          
        </div>
      </div>
    


    

    

  </main>

            </div>

            
                <footer class="footer">
    <div class="footer__inner">
        <div class="footer__content">
            <span>&copy; 2023</span>
            
            <span><a href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank" rel="noopener">CC BY-NC 4.0</a></span><span><a href="posts/index.xml" target="_blank" title="rss"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle></svg></a></span>
        </div>
    </div>
    <div class="footer__inner">
        <div class="footer__content">
            <span>Powered by <a href="http://gohugo.io">Hugo</a></span>
            <span>Made with &#10084; by <a href="https://github.com/rhazdon">Djordje Atlialp</a></span>
          </div>
    </div>
</footer>

            
        </div>

        



<script type="text/javascript" src="/bundle.min.2ce64ea6ea44a72b13dd812fc2eb5cca3efe878cce258a47c137c17edf46e0602a05e422b618a5b80b5939c731b7a293351c2f2222a21f6ee27e54a8448dd20e.js" integrity="sha512-LOZOpupEpysT3YEvwutcyj7&#43;h4zOJYpHwTfBft9G4GAqBeQithiluAtZOccxt6KTNRwvIiKiH27iflSoRI3SDg=="></script>



    </body>
</html>
