<!DOCTYPE html>
<html lang="en">

<head>
  <title>
  PCIe SRIOV linux initialization · Techiedeepdive
</title>
  <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="color-scheme" content="light dark">




<meta name="description" content="single root input/output virtualization (SR-IOV) is PCIe specifications that provide virtual function (in this context, the usual PCIe function would be physical function). virtual function is used VM for better performance. It allows flow the data like physical function with limited capabilities.
Finding SRIOV capabilities space  Link to heading   897 int pci_iov_init(struct pci_dev *dev) 898 { 899 int pos; 900 901 if (!pci_is_pcie(dev)) 902 return -ENODEV; 903 904 pos = pci_find_ext_capability(dev, PCI_EXT_CAP_ID_SRIOV); 905 if (pos) 906 return sriov_init(dev, pos); 907 908 return -ENODEV; 909 } pos is found by pci_find_ext_capability which calls pci_find_next_ext_capability to get the extended configuration capabilities with SRIOV ID.">
<meta name="keywords" content="">

<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content=""/>

<meta name="twitter:title" content="PCIe SRIOV linux initialization"/>
<meta name="twitter:description" content="single root input/output virtualization (SR-IOV) is PCIe specifications that provide virtual function (in this context, the usual PCIe function would be physical function). virtual function is used VM for better performance. It allows flow the data like physical function with limited capabilities.
Finding SRIOV capabilities space  Link to heading   897 int pci_iov_init(struct pci_dev *dev) 898 { 899 int pos; 900 901 if (!pci_is_pcie(dev)) 902 return -ENODEV; 903 904 pos = pci_find_ext_capability(dev, PCI_EXT_CAP_ID_SRIOV); 905 if (pos) 906 return sriov_init(dev, pos); 907 908 return -ENODEV; 909 } pos is found by pci_find_ext_capability which calls pci_find_next_ext_capability to get the extended configuration capabilities with SRIOV ID."/>

<meta property="og:title" content="PCIe SRIOV linux initialization" />
<meta property="og:description" content="single root input/output virtualization (SR-IOV) is PCIe specifications that provide virtual function (in this context, the usual PCIe function would be physical function). virtual function is used VM for better performance. It allows flow the data like physical function with limited capabilities.
Finding SRIOV capabilities space  Link to heading   897 int pci_iov_init(struct pci_dev *dev) 898 { 899 int pos; 900 901 if (!pci_is_pcie(dev)) 902 return -ENODEV; 903 904 pos = pci_find_ext_capability(dev, PCI_EXT_CAP_ID_SRIOV); 905 if (pos) 906 return sriov_init(dev, pos); 907 908 return -ENODEV; 909 } pos is found by pci_find_ext_capability which calls pci_find_next_ext_capability to get the extended configuration capabilities with SRIOV ID." />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/2022/08/pcie-sriov-linux-initialization/" /><meta property="og:image" content=""/><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-08-27T00:00:00+00:00" />
<meta property="article:modified_time" content="2022-08-27T00:00:00+00:00" /><meta property="og:site_name" content="Techiedeepdive" />





<link rel="canonical" href="/posts/2022/08/pcie-sriov-linux-initialization/">


<link rel="preload" href="/fonts/fa-brands-400.woff2" as="font" type="font/woff2" crossorigin>
<link rel="preload" href="/fonts/fa-regular-400.woff2" as="font" type="font/woff2" crossorigin>
<link rel="preload" href="/fonts/fa-solid-900.woff2" as="font" type="font/woff2" crossorigin>


  
  
  <link rel="stylesheet" href="/css/coder.min.577e3c5ead537873430da16f0964b754a120fd87c4e2203a00686e7c75b51378.css" integrity="sha256-V348Xq1TeHNDDaFvCWS3VKEg/YfE4iA6AGhufHW1E3g=" crossorigin="anonymous" media="screen" />






  
    
    
    <link rel="stylesheet" href="/css/coder-dark.min.a00e6364bacbc8266ad1cc81230774a1397198f8cfb7bcba29b7d6fcb54ce57f.css" integrity="sha256-oA5jZLrLyCZq0cyBIwd0oTlxmPjPt7y6KbfW/LVM5X8=" crossorigin="anonymous" media="screen" />
  



 




<link rel="icon" type="image/svg+xml" href="/images/favicon.svg" sizes="any">
<link rel="icon" type="image/png" href="/images/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/images/favicon-16x16.png" sizes="16x16">

<link rel="apple-touch-icon" href="/images/apple-touch-icon.png">
<link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">

<link rel="manifest" href="/site.webmanifest">
<link rel="mask-icon" href="/images/safari-pinned-tab.svg" color="#5bbad5">









</head>






<body class="preload-transitions colorscheme-auto">
  
<div class="float-container">
    <a id="dark-mode-toggle" class="colorscheme-toggle">
        <i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i>
    </a>
</div>


  <main class="wrapper">
    <nav class="navigation">
  <section class="container">
    
    <a class="navigation-title" href="">
      Techiedeepdive
    </a>
    
    
      <input type="checkbox" id="menu-toggle" />
      <label class="menu-button float-right" for="menu-toggle">
        <i class="fa-solid fa-bars fa-fw" aria-hidden="true"></i>
      </label>
      <ul class="navigation-list">
        
          
            <li class="navigation-item">
              <a class="navigation-link " href="/posts">Blog</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link " href="/reading-list/">Reading list</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link " href="/tags/">Tags</a>
            </li>
          
        
        
      </ul>
    
  </section>
</nav>


    <div class="content">
      
  <section class="container post">
    <article>
      <header>
        <div class="post-title">
          <h1 class="title">
            <a class="title-link" href="/posts/2022/08/pcie-sriov-linux-initialization/">
              PCIe SRIOV linux initialization
            </a>
          </h1>
        </div>
        <div class="post-meta">
          <div class="date">
            <span class="posted-on">
              <i class="fa-solid fa-calendar" aria-hidden="true"></i>
              <time datetime="2022-08-27T00:00:00Z">
                August 27, 2022
              </time>
            </span>
            <span class="reading-time">
              <i class="fa-solid fa-clock" aria-hidden="true"></i>
              3-minute read
            </span>
          </div>
          
          
          <div class="tags">
  <i class="fa-solid fa-tag" aria-hidden="true"></i>
    <span class="tag">
      <a href="/tags/pcie/">pcie</a>
    </span>
      <span class="separator">•</span>
    <span class="tag">
      <a href="/tags/linux/">linux</a>
    </span></div>

        </div>
      </header>

      <div class="post-content">
        
        <p>single root input/output virtualization (SR-IOV) is PCIe specifications that provide virtual function (in this context, the usual PCIe function would be physical function). virtual function is used VM for better performance. It allows flow the data like physical function with limited capabilities.</p>
<h1 id="finding-sriov-capabilities-space">
  Finding SRIOV capabilities space
  <a class="heading-link" href="#finding-sriov-capabilities-space">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h1>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"> <span style="color:#ff0;font-weight:bold">897</span> <span style="color:#fff;font-weight:bold">int</span> pci_iov_init(<span style="color:#fff;font-weight:bold">struct</span> pci_dev *dev)
 <span style="color:#ff0;font-weight:bold">898</span> {
 <span style="color:#ff0;font-weight:bold">899</span>     <span style="color:#fff;font-weight:bold">int</span> pos;
 <span style="color:#ff0;font-weight:bold">900</span>
 <span style="color:#ff0;font-weight:bold">901</span>     <span style="color:#fff;font-weight:bold">if</span> (!pci_is_pcie(dev))
 <span style="color:#ff0;font-weight:bold">902</span>         <span style="color:#fff;font-weight:bold">return</span> -ENODEV;
 <span style="color:#ff0;font-weight:bold">903</span>
 <span style="color:#ff0;font-weight:bold">904</span>     pos = pci_find_ext_capability(dev, PCI_EXT_CAP_ID_SRIOV);
 <span style="color:#ff0;font-weight:bold">905</span>     <span style="color:#fff;font-weight:bold">if</span> (pos)
 <span style="color:#ff0;font-weight:bold">906</span>         <span style="color:#fff;font-weight:bold">return</span> sriov_init(dev, pos);
 <span style="color:#ff0;font-weight:bold">907</span>
 <span style="color:#ff0;font-weight:bold">908</span>     <span style="color:#fff;font-weight:bold">return</span> -ENODEV;
 <span style="color:#ff0;font-weight:bold">909</span> }
</code></pre></div><p><code>pos</code> is found by <code>pci_find_ext_capability</code> which calls <code>pci_find_next_ext_capability</code> to get the extended configuration capabilities with SRIOV ID. Note the comare at line 566.</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"> <span style="color:#ff0;font-weight:bold">540</span> u16 pci_find_next_ext_capability(<span style="color:#fff;font-weight:bold">struct</span> pci_dev *dev, u16 start, <span style="color:#fff;font-weight:bold">int</span> cap)
 <span style="color:#ff0;font-weight:bold">541</span> {
...
...
 <span style="color:#ff0;font-weight:bold">565</span>     <span style="color:#fff;font-weight:bold">while</span> (ttl-- &gt; <span style="color:#ff0;font-weight:bold">0</span>) {
 <span style="color:#ff0;font-weight:bold">566</span>         <span style="color:#fff;font-weight:bold">if</span> (PCI_EXT_CAP_ID(header) == cap &amp;&amp; pos != start)
 <span style="color:#ff0;font-weight:bold">567</span>             <span style="color:#fff;font-weight:bold">return</span> pos;
 <span style="color:#ff0;font-weight:bold">568</span>
 <span style="color:#ff0;font-weight:bold">569</span>         pos = PCI_EXT_CAP_NEXT(header);
 <span style="color:#ff0;font-weight:bold">570</span>         <span style="color:#fff;font-weight:bold">if</span> (pos &lt; PCI_CFG_SPACE_SIZE)
 <span style="color:#ff0;font-weight:bold">571</span>             <span style="color:#fff;font-weight:bold">break</span>;
 <span style="color:#ff0;font-weight:bold">572</span>
 <span style="color:#ff0;font-weight:bold">573</span>         <span style="color:#fff;font-weight:bold">if</span> (pci_read_config_dword(dev, pos, &amp;header) != PCIBIOS_SUCCESSFUL)
 <span style="color:#ff0;font-weight:bold">574</span>             <span style="color:#fff;font-weight:bold">break</span>;
 <span style="color:#ff0;font-weight:bold">575</span>     }
 <span style="color:#ff0;font-weight:bold">576</span>

</code></pre></div><p>Once we have the position, The next phase is reading SRIOV configuration space in <code>sriov_init</code></p>
<h1 id="iov-initialization">
  iov initialization
  <a class="heading-link" href="#iov-initialization">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h1>
<p>The configuration space for SRIOV as follows
<img src="/sriov.png" alt="Example image"></p>
<p>in<code>sriov_init</code>, The first things is getting some parameter above.</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"> <span style="color:#ff0;font-weight:bold">768</span>
 <span style="color:#ff0;font-weight:bold">769</span>     pci_read_config_word(dev, pos + PCI_SRIOV_TOTAL_VF, &amp;total);
 <span style="color:#ff0;font-weight:bold">770</span>     if (!total)
 <span style="color:#ff0;font-weight:bold">771</span>         <span style="color:#fff;font-weight:bold">return</span> <span style="color:#ff0;font-weight:bold">0</span>;
 <span style="color:#ff0;font-weight:bold">772</span>
 <span style="color:#ff0;font-weight:bold">773</span>     pci_read_config_dword(dev, pos + PCI_SRIOV_SUP_PGSIZE, &amp;pgsz);
 <span style="color:#ff0;font-weight:bold">774</span>     i = PAGE_SHIFT &gt; <span style="color:#ff0;font-weight:bold">12</span> ? PAGE_SHIFT - <span style="color:#ff0;font-weight:bold">12</span> : <span style="color:#ff0;font-weight:bold">0</span>;
 <span style="color:#ff0;font-weight:bold">775</span>     pgsz &amp;= ~((<span style="color:#ff0;font-weight:bold">1</span> &lt;&lt; i) - <span style="color:#ff0;font-weight:bold">1</span>);
 <span style="color:#ff0;font-weight:bold">776</span>     if (!pgsz)
 <span style="color:#ff0;font-weight:bold">777</span>         <span style="color:#fff;font-weight:bold">return</span> -EIO;
 <span style="color:#ff0;font-weight:bold">778</span>
 <span style="color:#ff0;font-weight:bold">779</span>     pgsz &amp;= ~(pgsz - <span style="color:#ff0;font-weight:bold">1</span>);
 <span style="color:#ff0;font-weight:bold">780</span>     pci_write_config_dword(dev, pos + PCI_SRIOV_SYS_PGSIZE, pgsz);
</code></pre></div><p>Next step is parsing the virtual function BAR(base address register) and store info in <code>iov</code></p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"> <span style="color:#ff0;font-weight:bold">786</span>     nres = <span style="color:#ff0;font-weight:bold">0</span>;
 <span style="color:#ff0;font-weight:bold">787</span>     <span style="color:#fff;font-weight:bold">for</span> (i = <span style="color:#ff0;font-weight:bold">0</span>; i &lt; PCI_SRIOV_NUM_BARS; i++) {
 <span style="color:#ff0;font-weight:bold">788</span>         res = &amp;dev-&gt;resource[i + PCI_IOV_RESOURCES];
 <span style="color:#ff0;font-weight:bold">789</span>         <span style="color:#007f7f">/*
</span><span style="color:#007f7f"> 790          * If it is already FIXED, don&#39;t change it, something
</span><span style="color:#007f7f"> 791          * (perhaps EA or header fixups) wants it this way.
</span><span style="color:#007f7f"> 792          */</span>
 <span style="color:#ff0;font-weight:bold">793</span>         <span style="color:#fff;font-weight:bold">if</span> (res-&gt;flags &amp; IORESOURCE_PCI_FIXED)
 <span style="color:#ff0;font-weight:bold">794</span>             bar64 = (res-&gt;flags &amp; IORESOURCE_MEM_64) ? <span style="color:#ff0;font-weight:bold">1</span> : <span style="color:#ff0;font-weight:bold">0</span>;
 <span style="color:#ff0;font-weight:bold">795</span>         <span style="color:#fff;font-weight:bold">else</span>
 <span style="color:#ff0;font-weight:bold">796</span>             bar64 = __pci_read_base(dev, pci_bar_unknown, res,
 <span style="color:#ff0;font-weight:bold">797</span>                         pos + PCI_SRIOV_BAR + i * <span style="color:#ff0;font-weight:bold">4</span>);
 <span style="color:#ff0;font-weight:bold">798</span>         if (!res-&gt;flags)
 <span style="color:#ff0;font-weight:bold">799</span>             <span style="color:#fff;font-weight:bold">continue</span>;
 <span style="color:#ff0;font-weight:bold">800</span>         if (resource_size(res) &amp; (PAGE_SIZE - <span style="color:#ff0;font-weight:bold">1</span>)) {
 <span style="color:#ff0;font-weight:bold">801</span>             rc = -EIO;
 <span style="color:#ff0;font-weight:bold">802</span>             <span style="color:#fff;font-weight:bold">goto</span> failed;
 <span style="color:#ff0;font-weight:bold">803</span>         }
 <span style="color:#ff0;font-weight:bold">804</span>         iov-&gt;barsz[i] = resource_size(res);
 <span style="color:#ff0;font-weight:bold">805</span>         res-&gt;end = res-&gt;start + resource_size(res) * total - <span style="color:#ff0;font-weight:bold">1</span>;
 <span style="color:#ff0;font-weight:bold">806</span>         pci_info(dev, <span style="color:#0ff;font-weight:bold">&#34;VF(n)</span> BAR%d space: %pR (contains BAR%d <span style="color:#fff;font-weight:bold">for</span> %d VFs)<span style="color:#f00">\</span>n<span style="color:#0ff;font-weight:bold">&#34;,</span>
 <span style="color:#ff0;font-weight:bold">807</span>              i, res, i, total);
 <span style="color:#ff0;font-weight:bold">808</span>         i += bar64;
 <span style="color:#ff0;font-weight:bold">809</span>         nres++;
 <span style="color:#ff0;font-weight:bold">810</span>     }

</code></pre></div><p>once we have all the info in <code>iov</code>, <code>iov</code> is set to <code>dev-&gt;sriov</code></p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"> <span style="color:#ff0;font-weight:bold">812</span>     iov-&gt;pos = pos;
 <span style="color:#ff0;font-weight:bold">813</span>     iov-&gt;nres = nres;
 <span style="color:#ff0;font-weight:bold">814</span>     iov-&gt;ctrl = ctrl;
 <span style="color:#ff0;font-weight:bold">815</span>     iov-&gt;total_VFs = total;
 <span style="color:#ff0;font-weight:bold">816</span>     iov-&gt;driver_max_VFs = total;
 <span style="color:#ff0;font-weight:bold">817</span>     pci_read_config_word(dev, pos + PCI_SRIOV_VF_DID, &amp;iov-&gt;vf_device);
 <span style="color:#ff0;font-weight:bold">818</span>     iov-&gt;pgsz = pgsz;
 <span style="color:#ff0;font-weight:bold">819</span>     iov-&gt;self = dev;
 <span style="color:#ff0;font-weight:bold">820</span>     iov-&gt;drivers_autoprobe = <span style="color:#fff;font-weight:bold">true</span>;
 <span style="color:#ff0;font-weight:bold">821</span>     pci_read_config_dword(dev, pos + PCI_SRIOV_CAP, &amp;iov-&gt;cap);
 <span style="color:#ff0;font-weight:bold">822</span>     pci_read_config_byte(dev, pos + PCI_SRIOV_FUNC_LINK, &amp;iov-&gt;link);
 <span style="color:#ff0;font-weight:bold">823</span>     if (pci_pcie_type(dev) == PCI_EXP_TYPE_RC_END)
 <span style="color:#ff0;font-weight:bold">824</span>         iov-&gt;link = PCI_DEVFN(PCI_SLOT(dev-&gt;devfn), iov-&gt;link);
 <span style="color:#ff0;font-weight:bold">825</span>
 <span style="color:#ff0;font-weight:bold">826</span>     if (pdev)
 <span style="color:#ff0;font-weight:bold">827</span>         iov-&gt;dev = pci_dev_get(pdev);
 <span style="color:#ff0;font-weight:bold">828</span>     <span style="color:#fff;font-weight:bold">else</span>
 <span style="color:#ff0;font-weight:bold">829</span>         iov-&gt;dev = dev;
 <span style="color:#ff0;font-weight:bold">830</span>
 <span style="color:#ff0;font-weight:bold">831</span>     dev-&gt;sriov = iov;
 <span style="color:#ff0;font-weight:bold">832</span>     dev-&gt;is_physfn = <span style="color:#ff0;font-weight:bold">1</span>;
 <span style="color:#ff0;font-weight:bold">833</span>     rc = compute_max_vf_buses(dev);
 <span style="color:#ff0;font-weight:bold">834</span>     if (rc)
 <span style="color:#ff0;font-weight:bold">835</span>         <span style="color:#fff;font-weight:bold">goto</span> fail_max_buses;
 <span style="color:#ff0;font-weight:bold">836</span>
</code></pre></div>
      </div>


      <footer>
        


        
        
        
        
        

        
      </footer>
    </article>

    
  </section>

    </div>

    <footer class="footer">
  <section class="container">
    ©
    
    2024
    
    ·
    
      Licensed under <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">CC BY-SA-4.0</a>
    ·
    
    Powered by <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> & <a href="https://github.com/luizdepra/hugo-coder/" target="_blank" rel="noopener">Coder</a>.
    
  </section>
</footer>

  </main>

  

  
  
  <script src="/js/coder.min.369d90111ae4409b4e51de5efd23a46b92663fcc82dc9a0efde7f70bffc3f949.js" integrity="sha256-Np2QERrkQJtOUd5e/SOka5JmP8yC3JoO/ef3C//D&#43;Uk="></script>
  

  

  


  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  
</body>

</html>
