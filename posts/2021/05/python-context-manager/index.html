<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="author" content="">
<meta name="description" content="Intro pep-343 describes the context(pun intended) of context managers.
 PEP 340, Anonymous Block Statements, combined many powerful ideas: using generators as block templates, adding exception handling and finalization to generators, and more
 Basically pep 340 introduced the concept of anonymous blocks. which means that something
block EXPR1 as VAR1: BLOCK1 is the same as
itr = EXPR1 # The iterator ret = False # True if a return statement is active val = None # Return value, if ret == True exc = None # sys." />
<meta name="keywords" content=", Python" />
<meta name="robots" content="noodp" />
<meta name="theme-color" content="" />
<link rel="canonical" href="/posts/2021/05/python-context-manager/" />


    <title>
        
            Python Context Manager :: Techiedeepdive 
        
    </title>



<link href="https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.5.0/css/flag-icon.min.css" rel="stylesheet"
    type="text/css">



<link rel="stylesheet" href="/main.de188b3201233c251f4fd6306dbd2cb41e408fb8846c09781b2925de7df5025c.css">






<meta itemprop="name" content="Python Context Manager">
<meta itemprop="description" content="Intro pep-343 describes the context(pun intended) of context managers.
 PEP 340, Anonymous Block Statements, combined many powerful ideas: using generators as block templates, adding exception handling and finalization to generators, and more
 Basically pep 340 introduced the concept of anonymous blocks. which means that something
block EXPR1 as VAR1: BLOCK1 is the same as
itr = EXPR1 # The iterator ret = False # True if a return statement is active val = None # Return value, if ret == True exc = None # sys."><meta itemprop="datePublished" content="2021-05-01T08:53:49+01:00" />
<meta itemprop="dateModified" content="2021-05-01T08:53:49+01:00" />
<meta itemprop="wordCount" content="487"><meta itemprop="image" content=""/>
<meta itemprop="keywords" content="Python," />
<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content=""/>

<meta name="twitter:title" content="Python Context Manager"/>
<meta name="twitter:description" content="Intro pep-343 describes the context(pun intended) of context managers.
 PEP 340, Anonymous Block Statements, combined many powerful ideas: using generators as block templates, adding exception handling and finalization to generators, and more
 Basically pep 340 introduced the concept of anonymous blocks. which means that something
block EXPR1 as VAR1: BLOCK1 is the same as
itr = EXPR1 # The iterator ret = False # True if a return statement is active val = None # Return value, if ret == True exc = None # sys."/>




    <meta property="og:title" content="Python Context Manager" />
<meta property="og:description" content="Intro pep-343 describes the context(pun intended) of context managers.
 PEP 340, Anonymous Block Statements, combined many powerful ideas: using generators as block templates, adding exception handling and finalization to generators, and more
 Basically pep 340 introduced the concept of anonymous blocks. which means that something
block EXPR1 as VAR1: BLOCK1 is the same as
itr = EXPR1 # The iterator ret = False # True if a return statement is active val = None # Return value, if ret == True exc = None # sys." />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/2021/05/python-context-manager/" /><meta property="og:image" content=""/><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-05-01T08:53:49+01:00" />
<meta property="article:modified_time" content="2021-05-01T08:53:49+01:00" /><meta property="og:site_name" content="Techiedeepdive" />







    <meta property="article:published_time" content="2021-05-01 08:53:49 &#43;0100 IST" />








    </head>

    
        <body>
    
    
        <div class="container">
            <header class="header">
    <span class="header__inner">
        <a href="/" style="text-decoration: none;">
    <div class="logo">
        
            <span class="logo__mark">></span>
            <span class="logo__text">$ cd /home/</span>
            <span class="logo__cursor" style=
                  "
                   
                   ">
            </span>
        
    </div>
</a>


        <span class="header__right">
            
                <nav class="menu">
    <ul class="menu__inner"><li><a href="/about/">About</a></li><li><a href="/posts">Blog</a></li><li><a href="/reading-list/">Reading list</a></li>
    </ul>
</nav>

                <span class="menu-trigger">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path d="M0 0h24v24H0z" fill="none"/>
                        <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
                    </svg>
                </span>
            
        </span>
    </span>
</header>


            <div class="content">
                
  <main class="post">

    <div class="post-info">
      <p>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock">
          <circle cx="12" cy="12" r="10"></circle>
          <polyline points="12 6 12 12 16 14"></polyline>
        </svg>
        3 minutes

        
      </p>
    </div>

    <article>
      <h1 class="post-title">
        <a href="/posts/2021/05/python-context-manager/">Python Context Manager</a>
      </h1>

      

      

      <div class="post-content">
        <h1 id="intro">Intro</h1>
<p><a href="https://www.python.org/dev/peps/pep-0343/">pep-343</a> describes the context(pun intended) of context managers.</p>
<blockquote>
<p>PEP 340, Anonymous Block Statements, combined many powerful ideas: using generators as block templates, adding exception handling and finalization to generators, and more</p>
</blockquote>
<p>Basically <a href="https://www.python.org/dev/peps/pep-0340/">pep 340</a> introduced the concept of anonymous blocks. which means that something</p>
<pre tabindex="0"><code>block EXPR1 as VAR1:
    BLOCK1
</code></pre><p>is the same as</p>
<pre tabindex="0"><code>itr = EXPR1  # The iterator
ret = False  # True if a return statement is active
val = None   # Return value, if ret == True
exc = None   # sys.exc_info() tuple if an exception is active
while True:
    try:
        if exc:
            ext = getattr(itr, &quot;__exit__&quot;, None)
            if ext is not None:
                VAR1 = ext(*exc)   # May re-raise *exc
            else:
                raise exc[0], exc[1], exc[2]
        else:
            VAR1 = itr.next()  # May raise StopIteration
</code></pre><p>but pep-343 won with statement <em>with</em></p>
<h1 id="specification">Specification</h1>
<p>the following context mangr expression</p>
<pre tabindex="0"><code>with EXPR as VAR:
    BLOCK
</code></pre><p>Translates to</p>
<pre tabindex="0"><code>mgr = (EXPR)
exit = type(mgr).__exit__  # Not calling it yet
value = type(mgr).__enter__(mgr)
exc = True
try:
    try:
        VAR = value  # Only if &quot;as VAR&quot; is present
        BLOCK
    except:
        # The exceptional case is handled here
        exc = False
        if not exit(mgr, *sys.exc_info()):
            raise
        # The exception is swallowed if exit() returns true
finally:
    # The normal and non-local-goto cases are handled here
    if exc:
        exit(mgr, None, None, None)
</code></pre><p>The pepe defines EXPR and VAR as</p>
<blockquote>
<p>Here, &lsquo;with&rsquo; and &lsquo;as&rsquo; are new keywords; EXPR is an arbitrary expression (but not an expression-list) and VAR is a single assignment target.</p>
</blockquote>
<h1 id="examples-and-application">Examples and application</h1>
<p>The main application for context manager is resource management like file or lock. And handle exceptions inside BLOCK. So, even exception happens, the cleanup code will be executed.</p>
<h2 id="context-manager-for-file">context manager for file</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">with</span> open(<span style="color:#e6db74">&#34;t.log&#34;</span>) <span style="color:#66d9ef">as</span> f:
	lines <span style="color:#f92672">=</span> f<span style="color:#f92672">.</span>readlines()
</code></pre></div><h2 id="user-defined-context-manager">user defined context manager</h2>
<p>ie the context manager data model requires two dunder methods</p>
<ul>
<li><strong>enter</strong></li>
<li><strong>exit</strong></li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">File</span>():
    <span style="color:#66d9ef">def</span> __init__(self):
        print(<span style="color:#e6db74">&#34;__init__&#34;</span>)
    <span style="color:#66d9ef">def</span> __enter__(self):
        print(<span style="color:#e6db74">&#34;__enter__&#34;</span>)
    <span style="color:#66d9ef">def</span> __exit__(self, type_,  value, traceback):
        print(<span style="color:#e6db74">&#34;__exit__&#34;</span>)
        print(<span style="color:#e6db74">&#34;type&#34;</span>, type_)
        print(<span style="color:#e6db74">&#34;value&#34;</span>, value)
        print(<span style="color:#e6db74">&#34;traceback&#34;</span>, traceback)



<span style="color:#66d9ef">with</span> File() <span style="color:#66d9ef">as</span> file:
    print(<span style="color:#e6db74">&#34;something&#34;</span>)
</code></pre></div><p>generates the following logs</p>
<pre tabindex="0"><code>__init__
__enter__
something
__exit__
type None
value None
traceback None

</code></pre><p>and when exception is raised the <code>__exit__</code> is called with excep information and stacktrace</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">with</span> File() <span style="color:#66d9ef">as</span> file:
    print(<span style="color:#e6db74">&#34;something&#34;</span>)
    <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">ValueError</span>
</code></pre></div><pre tabindex="0"><code>__enter__
something
__exit__
type &lt;class 'ValueError'&gt;
value 
traceback &lt;traceback object at 0x7f18a06b0500&gt;
4
Traceback (most recent call last):
  File &quot;cntx-mngr.py&quot;, line 23, in &lt;module&gt;
    raise ValueError
ValueError
</code></pre><h2 id="generator-based-context-manager">Generator based context manager</h2>
<p><a href="https://docs.python.org/3/library/contextlib.html">doc</a> describes it best:</p>
<blockquote>
<p>This function is a decorator that can be used to define a factory function for with statement context managers, without needing to create a class or separate <strong>enter</strong>() and <strong>exit</strong>() methods.</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> contextlib <span style="color:#f92672">import</span> contextmanager

<span style="color:#a6e22e">@contextmanager</span>
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">managed_resource</span>(<span style="color:#f92672">*</span>args, <span style="color:#f92672">**</span>kwds):
    <span style="color:#75715e"># Code to acquire resource, e.g.:</span>
    resource <span style="color:#f92672">=</span> acquire_resource(<span style="color:#f92672">*</span>args, <span style="color:#f92672">**</span>kwds)
    <span style="color:#66d9ef">try</span>:
        <span style="color:#66d9ef">yield</span> resource
    <span style="color:#66d9ef">finally</span>:
        <span style="color:#75715e"># Code to release resource, e.g.:</span>
        release_resource(resource)

<span style="color:#f92672">&gt;&gt;&gt;</span> <span style="color:#66d9ef">with</span> managed_resource(timeout<span style="color:#f92672">=</span><span style="color:#ae81ff">3600</span>) <span style="color:#66d9ef">as</span> resource:
<span style="color:#f92672">...</span>     <span style="color:#75715e"># Resource is released at the end of this block,</span>
<span style="color:#f92672">...</span>     <span style="color:#75715e"># even if code in the block raises an exception</span>
</code></pre></div>
      </div>
    </article>

    <hr />

    <div class="post-info">
      
    <p>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7" y2="7"></line></svg>

        <span class="tag"><a href="tags/python/">Python</a></span>
        
    </p>

      

      <p>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text">
          <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
          <polyline points="14 2 14 8 20 8"></polyline>
          <line x1="16" y1="13" x2="8" y2="13"></line>
          <line x1="16" y1="17" x2="8" y2="17"></line>
          <polyline points="10 9 9 9 8 9"></polyline>
        </svg>
        487 Words
      </p>

      <p>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar">
          <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
          <line x1="16" y1="2" x2="16" y2="6"></line>
          <line x1="8" y1="2" x2="8" y2="6"></line>
          <line x1="3" y1="10" x2="21" y2="10"></line>
        </svg>
        
          2021-05-01 08:53 &#43;0100
        

         
          
        
      </p>
    </div>

    
      <div class="pagination">
        <div class="pagination__title">
          <span class="pagination__title-h">Read other posts</span>
          <hr />
        </div>

        <div class="pagination__buttons">
          
            <span class="button previous">
              <a href="/posts/2021/05/python-wheels/">
                <span class="button__icon">←</span>
                <span class="button__text">Python Wheels</span>
              </a>
            </span>
          

          
            <span class="button next">
              <a href="/posts/2021/04/python-int/hex-and-bytes/">
                <span class="button__text">Python int/hex and bytes</span>
                <span class="button__icon">→</span>
              </a>
            </span>
          
        </div>
      </div>
    


    

    

  </main>

            </div>

            
                <footer class="footer">
    <div class="footer__inner">
        <div class="footer__content">
            <span>&copy; 2023</span>
            
            <span><a href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank" rel="noopener">CC BY-NC 4.0</a></span><span><a href="posts/index.xml" target="_blank" title="rss"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle></svg></a></span>
        </div>
    </div>
    <div class="footer__inner">
        <div class="footer__content">
            <span>Powered by <a href="http://gohugo.io">Hugo</a></span>
            <span>Made with &#10084; by <a href="https://github.com/rhazdon">Djordje Atlialp</a></span>
          </div>
    </div>
</footer>

            
        </div>

        



<script type="text/javascript" src="/bundle.min.2ce64ea6ea44a72b13dd812fc2eb5cca3efe878cce258a47c137c17edf46e0602a05e422b618a5b80b5939c731b7a293351c2f2222a21f6ee27e54a8448dd20e.js" integrity="sha512-LOZOpupEpysT3YEvwutcyj7&#43;h4zOJYpHwTfBft9G4GAqBeQithiluAtZOccxt6KTNRwvIiKiH27iflSoRI3SDg=="></script>



    </body>
</html>
